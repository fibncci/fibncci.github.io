---
layout: post
title: "R绘图"
date: 2019-11-29
tag: sas
---









# 29 绘图

R语言的前身是S语言， S语言的设计目的就是交互式数据分析、绘图。 所以绘图是R的重要功能。

R有最初的基本绘图， 这是从S语言继承过来的， 还有一些功能更易用、更强大的绘图系统， 如lattice、ggplot2。 基本绘图使用简单， 灵活性强， 但是为了做出满意的图形需要比较多的调整。 这里先讲解R语言的基本绘图功能。

R的基本绘图功能有两类图形函数： 高级图形函数， 直接针对某一绘图任务作出完整图形； 低级图形函数，在已有图形上添加内容。 具备有限的与图形交互的能力（函数`locator` 和`identify`）。

## 29.1 常用高级图形

### 29.1.1 条形图

`d.cancer`数据框包含了肺癌病人放疗的一些数据， 从[`cancer.csv`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/cancer.csv)读入：

```
d.cancer <- readr::read_csv("cancer.csv", locale=locale(encoding="GBK"))
## Parsed with column specification:
## cols(
##   id = col_double(),
##   age = col_double(),
##   sex = col_character(),
##   type = col_character(),
##   v0 = col_double(),
##   v1 = col_double()
## )
```

统计男女个数并用条形图表示：

```
res1 <- table(d.cancer[,'sex']); print(res1)
## 
##  F  M 
## 13 21
barplot(res1)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-dc-bp01-1.png)

可以增加标题，采用不同的颜色：

```
barplot(res1, main="性别分布", 
        col=c("brown2", "aquamarine1"))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-dc-bp02-1.png)

R函数`colors()`可以返回R中定义的用字符串表示的六百多种颜色名字。 如

```
head(colors(), 6)
## [1] "white"         "aliceblue"     "antiquewhite"  "antiquewhite1"
## [5] "antiquewhite2" "antiquewhite3"
```

下面的函数可以用来挑选颜色， 鼠标点击画出的颜色就可以挑选， 结果返回挑选出的颜色名：

```
select.colors <- function(){
  nc <- length(colors())
  x <- rep(seq(26), 26)[1:nc]
  y <- rep(seq(26), each=26)[1:nc]
  cols <- colors()
  plot(x, y, type="p", pch=16, cex=2,
       col=cols)
  res <- cols[identify(x,y, labels=cols)]
  res
}
```

用`width`选项与`xlim`选项配合可以调整条形宽度，如

```
barplot(res1, width=0.5, xlim=c(-3, 5),
        main="性别分布", 
        col=c("brown2", "aquamarine1"))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-dc-bp03-1.png)

按性别与病理类型交叉分组后统计频数，结果称为列联表：

```
res2 <- with(d.cancer, table(sex, type)); res2
##    type
## sex 鳞癌 腺癌
##   F    4    9
##   M   18    3
```

用分段条形图表现交叉分组频数， 交叉频数表每列为一条：

```
barplot(res2, legend=TRUE)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-dc-bp05-1.png)

用并排条形图表现交叉分组频数， 交叉频数表每列为一组：

```
barplot(res2, beside=TRUE, legend=TRUE)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-dc-bp06-1.png)

增加标题，指定颜色，调整图例位置，调整条形宽度：

```
barplot(res2, beside=TRUE, legend=TRUE,
        main='不同种类病人的性别',
        ylim=c(0, 20),
        xlim=c(-1, 6), width=0.6,
        col=c("brown2", "aquamarine1"))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-dc-bp07-1.png)

### 29.1.2 直方图和密度估计图

用`hist`作直方图以了解连续取值变量分布情况。 例如，下面的程序模拟正态分布数据并做直方图：

```
x <- rnorm(30, mean=100, sd=1)
print(round(x,2))
##  [1] 101.79  98.33 100.99  99.93  99.42  98.13 100.29  99.75  97.58 100.35
## [11]  97.54 100.17 101.42 100.44  97.69  99.24 101.68  99.12  98.88  98.39
## [21] 100.64  99.26  99.81  99.78  99.09  98.85  99.98 101.36 100.10  99.67
hist(x)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-hist01-1.png)

可以用`main=`、`xlab=`、`ylab=`等选项， 可以用`col=`指定各个条形的颜色，如：

```
hist(x, col=rainbow(15), 
     main='正态随机数', xlab='', ylab='频数')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/unnamed-chunk-1-1.png)

函数`density()`估计核密度。 下面的程序作直方图， 并添加核密度曲线：

```
tmp.dens <- density(x)
hist(x, freq=FALSE,
     ylim=c(0,max(tmp.dens$y)),
     col=rainbow(15),
     main='正态随机数',
     xlab='', ylab='频数')
lines(tmp.dens, lwd=2, col='blue')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-denfun01-1.png)

### 29.1.3 盒形图

盒形图可以简洁地表现变量分布，如

```
with(d.cancer, boxplot(v0))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-bp01-1.png)

其中中间粗线是中位数， 盒子上下边缘是和分位数， 两条触须线延伸到取值区域的边缘。

盒形图可以很容易地比较两组或多组，如

```
with(d.cancer, boxplot(v0 ~ sex))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-bp02-1.png)

也可以画若干个变量的并排盒形图，如

```
with(d.cancer,
     boxplot(list('疗前'=v0, '疗后'=v1)))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-bp03-1.png)

### 29.1.4 正态QQ图

用`qqnorm`和`qqline`作正态QQ图。 当变量样本来自正态分布总体时， 正态QQ图的散点近似在一条直线周围。

QQ图一般作法如下： 设有个观测, , , , 并已从小到大排列, 则 是总体的分位数的估计, 设 是标准正态分布的分位数, 则在样本来自正态 的情况下, 记 的分布函数为， 有, , , ， 于是用 ()作为坐标画散点图应该近似呈现为截距、 斜率 的一条直线。

但是, 上述的近似有一个小缺点: 是观测到的最小值, 对应于分位数, 是观测到的最大值, 却对应于 分位数, 对最小和最大值的处理不对称, 相当于说总体分布不能超过, 这是不合理的。 所以在实际画正态QQ图时, 不是对应于标准正态的分位数而是对应于略调整的如这样的分位数, 这种做法叫做连续性修正。 这时, 对应于分位数而 对应于分位数, 两边各留了。

下面的程序模拟正态分布随机数，并作正态QQ图:

```
qqnorm(x)
qqline(x, lwd=2, col='blue')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-qq01-1.png)

下面的程序模拟对数正态数据，并作正态QQ图:

```
z <- 10^rnorm(30, mean=0, sd=0.2)
qqnorm(z)
qqline(z, lwd=2, col='blue')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-qq02-1.png)

### 29.1.5 散点图

以d.class数据为例， 有name, sex, age, height, weight等变量。 从[`class.csv`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/class.csv)读入：

```
d.class <- read_csv("class.csv")
## Parsed with column specification:
## cols(
##   name = col_character(),
##   sex = col_character(),
##   age = col_double(),
##   height = col_double(),
##   weight = col_double()
## )
```

体重对身高的散点图：

```
plot(d.class$height, d.class$weight)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-sc02-1.png)

用`with()`函数简化数据框变量访问格式:

```
with(d.class,
     plot(height, weight))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-sc03-1.png)

在`plot()`函数内用`main`参数增加标题， 用`xlab`参数指定横轴标注， 用`ylab`参数指定纵轴标注，如

```
with(d.class,
     plot(height, weight,
          main='体重与身高关系',
          xlab='身高', ylab='体重'))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-sc04-1.png)

用`pch`参数指定不同散点形状，用`col`参数指定颜色， 用`cex`参数指定大小，如：

```
with(d.class,
     plot(height, weight,
          pch=16, col='blue',
          cex=2))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-sc05-1.png)

用气泡大小表现第三维（年龄）：

```
with(d.class,
     plot(height, weight,
          pch=16, col='blue',
          cex=1 + (age - min(age))/(max(age)-min(age))))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-sc06-1.png)

用气泡大小表现年龄， 用颜色区分性别：

```
with(d.class, 
        plot(height, weight,
          main='体重与身高关系',
          xlab='身高', ylab='体重',
          pch=16, 
          col=ifelse(sex=='M', 'blue', 'red'),
          cex=1 + (age - min(age))
            /(max(age)-min(age))))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-sc07-1.png)

用`pairs()`函数可以做散点图矩阵：

```
pairs(d.class[, c('age', 'height', 'weight')])
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-pairs01-1.png)

### 29.1.6 曲线图

`curve()`函数接受一个函数， 或者一个以`x`为变量的表达式， 以及曲线的自变量的左、右端点， 绘制函数或者表达式的曲线图，如：

```
curve(1 - 3*x - x^2, -4, 2)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-cu01-1.png)

又如：

```
curve(sin, -2*pi, 2*pi)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-cu02-1.png)

在`plot`函数中使用 `type=’l’`参数可以作曲线图， 如

```
x <- seq(0, 2*pi, length=200)
y <- sin(x)
plot(x,y, type='l')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-pcu01-1.png)

除了仍可以用`main`, `xlab`, `ylab`, `col`等参数外， 还可以用`lwd`指定线宽度， `lty`指定虚线，如

```
plot(x,y, type='l', lwd=2, lty=3)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-pcu02-1.png)

多条曲线， 可以用`matplot()`函数。例如

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x)
y2 <- cos(x)
matplot(x, cbind(y1, y2), type='l', 
        lty=1, lwd=2, col=c("red", "blue"),
        xlab="x", ylab="")
abline(h=0, col='gray')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-ma01-1.png)

### 29.1.7 三维图

用`persp`函数作三维曲面图, `contour`作等值线图， `image`作色块图。 坐标`x`和`y`构成一张平面网格， 数据`z`是包含z坐标的矩阵，每行对应一个横坐标， 每列对应一个纵坐标。

下面的程序生成二元正态分布密度曲面数据：

```
x <- seq(-3,3, length=100)
y <- x
f <- function(x,y,ssq1=1, ssq2=2, rho=0.5){
     det1 <- ssq1*ssq2*(1 - rho^2)
     s1 <- sqrt(ssq1)
     s2 <- sqrt(ssq2)
     1/(2*pi*sqrt(det1)) * exp(-0.5 / det1 * (
       ssq2*x^2 + ssq1*y^2 - 2*rho*s1*s2*x*y))
}
z <- outer(x, y, f)
```

作二元正态密度函数的三维曲面图、等高线图、色块图:

```
persp(x, y, z)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-pe02-1.png)

```
contour(x, y, z)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-pe02-2.png)

```
image(x, y, z)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-pe02-3.png)

### 29.1.8 动态三维图

rgl包能制作动态的三维散点图与曲面图。

```
library(rgl)
```

iris数据框包含了3种鸢尾花的各50个样品的测量值， 测量值包括花萼长、宽， 花瓣长、宽。 用rgl的`plot3d()`作动态三维散点图如下：

```
with(iris, plot3d(
  Sepal.Length, Sepal.Width, Petal.Length, 
  type="s", col=as.numeric(Species)))
```

这个图可以用鼠标拖动旋转。 其中`type="s"`表示绘点符号是球体形状。 还可选`"p"`(点)、`"l"`(连线)、`"h"`(向z=0连线)。 可以用`size=`指定大小倍数（缺省值为3）。

用rgl的`persp3d()`函数作曲面图。 如 二元正态分布密度曲面：

```
x <- seq(-3,3, length=100)
y <- x
f <- function(x,y,ssq1=1, ssq2=2, rho=0.5){
     det1 <- ssq1*ssq2*(1 - rho^2)
     s1 <- sqrt(ssq1)
     s2 <- sqrt(ssq2)
     1/(2*pi*sqrt(det1)) * exp(-0.5 / det1 * (
       ssq2*x^2 + ssq1*y^2 - 2*rho*s1*s2*x*y))
}
z <- outer(x, y, f)
persp3d(x=x, y=y, z=z, col='red')
```

rgl也有低级图形函数支持向已有图形添加物体、文字等， 也支持并列多图。 适当设置可以在R Markdown生成的HTML结果中动态显示三维图。

## 29.2 低级图形函数

### 29.2.1 `abline()`

用`abline`函数在图中增加直线。 可以指定截距和斜率， 或为竖线指定横坐标(用参数`v`)， 为水平线指定纵坐标(用参数`h`)。 如

```
with(d.class, plot(height, weight))
abline(-143, 3.9, col="red", lwd=2)
abline(v=c(55,60,65,70), col="gray")
abline(h=c(60,80,100,120,140), col="gray")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-abline01-1.png)

### 29.2.2 `points()`

用`points`函数增加散点，如：

```
x <- seq(0, 2*pi, length=200)
y <- sin(x)
special <- list(x=(0:4)*pi/2, y=sin((0:4)*pi/2))
plot(x, y, type='l')
points(special$x, special$y, 
       col="red", pch=16, cex=2)
points(special, col="red", pch=16, cex=2)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-points01-1.png)

### 29.2.3 `lines()`

用`lines`函数增加曲线，如：

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x)
y2 <- cos(x)
plot(x, y1, type='l', lwd=2, col="red")
lines(x, y2, lwd=2, col="blue")
abline(h=0, col='gray')
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-lines01-1.png)

### 29.2.4 图例

可以用`legend`函数增加标注，如

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x)
y2 <- cos(x)
plot(x, y1, type='l', lwd=2, col="red")
lines(x, y2, lwd=2, col="blue")
abline(h=0, col='gray')
legend(0, -0.5, col=c("red", "blue"),
       lty=c(1,1), lwd=c(2,2), 
       legend=c("sin", "cos"))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-legend01-1.png)

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x)
y2 <- cos(x)
plot(x, y1, type='l', lwd=2, col="red")
lines(x, y2, lwd=2, col="blue")
abline(h=0, col='gray')
legend('top', col=c("red", "blue"),
       lty=c(1,1), lwd=c(2,2), 
       legend=c("sin", "cos"))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-legend02-1.png)

### 29.2.5 `axis()`

在`plot()`函数中用 `axes=FALSE`可以取消自动的坐标轴。 用`box()`函数画坐标边框。 用`axis`函数单独绘制坐标轴。 `axis`的第一个参数取1，2，3，4， 分别表示横轴、纵轴、上方和右方。 `axis`的参数`at`为 刻度线位置，`labels`为标签。 如

```
x <- c('一月'=15, '二月'=20, 
       '三月'=18, '四月'=22)
plot(seq(along=x), x, axes=FALSE,
     type='b', lwd=3,
     main='前四个月销售额',
     xlab='', ylab='销售额')
box(); axis(2)
axis(1, at=seq(along=x), labels=names(x))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-axis01-1.png)

R基本绘图支持少量的数学公式显示功能，如不用数学符号时：

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x)
plot(x, y1, type='l', lwd=2,
     axes=FALSE,
     xlab='x', ylab='')
abline(h=0, col='gray')
box()
axis(2)
axis(1, at=(0:4)/2*pi,
     labels=c('0', 'pi/2', 'pi', '3pi/2', '2pi'))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-math01-1.png)

使用数学符号时：

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x)
plot(x, y1, type='l', lwd=2,
     axes=FALSE,
     xlab='x', ylab='')
abline(h=0, col='gray')
box()
axis(2)
axis(1, at=(0:4)/2*pi,
     labels=c(0, expression(pi/2), 
     expression(pi), expression(3*pi/2), 
     expression(2*pi)))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-math02-1.png)

绘图中使用数学符号的演示：

```
demo(plotmath)
```

### 29.2.6 `text()`

`text()`在坐标区域内添加文字。 `mtext()`在边空处添加文字。 如

```
with(d.class, plot(height, weight))
lm1 <- lm(weight ~ height, data=d.class)
abline(lm1, col='red', lwd=2)
a <- coef(lm1)[1]
b <- coef(lm1)[2]
text(52, 145, adj=0, '线性回归:')
text(52, 140, adj=0,
    substitute(hat(y) == a + b*x,
    list(a=round(coef(lm1)[1], 2), 
         b=round(coef(lm1)[2], 2))))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-text01-1.png)

### 29.2.7 `locator()`和`identify()`

`locator()`函数在执行时等待用户在图形的坐标区域内点击并返回点击处的坐标。 可以用参数`n`指定要点击的点的个数。 不指定个数则需要用右键菜单退出。 这个函数也可以用来要求用户点击以进行到下一图形。 如

```
x <- seq(0, 2*pi, length=200)
y1 <- sin(x); y2 <- cos(x)
plot(x, y1, type='l',
     col="red")
lines(x, y2, col="blue")
legend(locator(1), col=c("red", "blue"),
       lty=c(1,1), legend=c("sin", "cos"))
```

`identify()`可以识别点击处的点并标注标签， 格式为`identify(x, y, labels)`， 其中`(x,y)`给出可点击的点的坐标， `labels`是每个点对应的标签， 点击那个点就在那个点旁边标对应的标签。

## 29.3 图形参数

用图形参数可以选择点的形状、颜色、线型、粗细、坐标轴做法、边空、一页多图等。 有些参数直接用在绘图函数内，如`plot`函数可以用 `pch`、`col`、`cex`、`lty`、 `lwd`等参数。 有些图形参数必须使用`par()`函数指定。 `par`函数指定图形参数并返回原来的参数值， 所以在修改参数值作图后通常应该恢复原始参数值， 做法如

```
opar <- par(mfrow=c(2,2))
with(d.class, {hist(height);
     boxplot(height);
     qqnorm(height); qqline(height);
     plot(height); rug(height,side=2)})
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-par01-1.png)

```
par(opar)
```

在函数内，可以在函数开头修改了图形参数后， 用`on.exit()`函数将恢复原始图形参数作为函数退出前必须完成的任务，如

```
f <- function(){
    opar <- par(mfrow=c(2,2)); on.exit(par(opar))
    with(
        d.class,
        {hist(height);
         boxplot(height);
         qqnorm(height); qqline(height);
         plot(height); rug(height,side=2)
     })
}
f()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-par02-1.png)

### 29.3.1 例子：用图形参数解决barplot图形横坐标值过宽

barplot的横坐标标注太宽时，自动将某些标注省略。 用las=2指定坐标轴刻度标签垂直于坐标轴， 这样x轴的刻度值就变成了纵向的。 注意使用mar参数增加横坐标边空大小。 例如

```
f <- function(){
    opar <- par(mar=c(8, 4, 2, 0.5)); on.exit(par(opar))
    x <- 1:10
    names(x) <- paste(10000000000 + (1:10))
    barplot(x, las=2)
}
f()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-parlas01-1.png)

图形参数可以分为如下四类

- 图形元素控制；
- 坐标轴与坐标刻度；
- 图形边空；
- 一页多图。

### 29.3.2 图形元素控制

- `pch=16`参数。散点符号，取的数。
- `lty=2`参数。线型，1为实线，从2开始为各种虚线。
- `lwd=2`参数，线的粗细，标准粗细为1。
- `col="red"`参数，颜色，可以是数字， 或颜色名字符串如`"red"`，`"blue"`等。 用`colors()`函数查询有名字的颜色。 用`rainbow(n)`函数产生连续变化的颜色。
- `font=2`参数，字体，一般font=1是正体,2是粗体, 3是斜体,4是粗斜体。
- `adj=-0.1`指定文本相对于给定坐标的对齐方式。 取0表示左对齐,取1表示右对齐,取0.5表示居中。 此参数的值实际代表的是出现在给定坐标左边的文本的比例。
- `cex=1.5` 绘点符号大小倍数，基本值为1。

### 29.3.3 坐标轴与坐标刻度

- `mgp=c(3,1,0)` 坐标轴的标签、刻度值、坐标轴线 到实际的坐标轴位置的距离，以行高为单位。 经常用来缩小坐标轴所占的空间, 如`mgp=c(1.5, 0.5, 0)`。

- `lab=c(5,7,12)` 提供刻度线多少的建议， 第一个数为x轴刻度线个数， 第二个数为y轴刻度线个数， 第三个数是坐标刻度标签的字符宽度。

- `las=1` 坐标刻度标签的方向。 0表示总是平行于坐标轴, 1表示总是水平, 2表示总是垂直于坐标轴。

- `tck=0.01` 坐标轴刻度线长度，以绘图区域大小为单位1。

- `xaxs="s"`, `yaxs="e"`: 控制x轴和y轴标刻度的方法。

  取`"s"`(即standard)或`"e"`(即extended) 的时候数据范围控制在最小刻度和最大刻度之间。 取`"e"`时如果有数据点十分靠近边缘轴的范围会略微扩大。

  取值为`"i"`（即internal）或`"r"`（此为缺省） 使得刻度线都落在数据范围内部,而`"r"`方式所留的边空较小。

  取值设为`"d"`时会锁定此坐标轴, 后续的图形都使用与它完全相同的坐标轴, 这在要生成一系列可比较的图形的时候是有用的。 要解除锁定需要把这个图形参数设为其它值。

### 29.3.4 图形边空

一个单独的图由绘图区域(绘图的点、线等画在这个区域中)和包围绘图区域的边空组成, 边空中可以包含坐标轴标签、坐标轴刻度标签、标题、小标题等, 绘图区域一般被坐标轴包围。

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/img-figspace.jpg)

边空的大小由mai参数或mar参数控制, 它们都是四个元素的向量, 分别规定下方、左方、上方、右方的边空大小, 其中mai取值的单位是英寸, 而mar的取值单位是文本行高度。 例如：

```
opar <- par(mar=c(2,2,0.5,0.5), 
            mgp=c(0.5, 0.5, 0), tck=0.005)
with(d.class, plot(height, weight, 
                   xlab='', ylab=''))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-parmar01-1.png)

```
par(opar)
```

### 29.3.5 一页多图

R可以在同一页面开若干个按行、列排列的窗格, 在每个窗格中可以作一幅图。 每个图有自己的内边空, 而所有图的外面可以包一个“外边空”。

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/img-figpanel.jpg)

一页多图用`mfrow`参数或`mfcol`参数规定。 用`oma`指定四个外边空的行数。 用`mtext`加`outer=T`指定在外边空添加文本。 如果没有`outer=T`则在内边空添加文本。 如

```
opar <- par(mfrow=c(2,2),
            oma=c(0,0,2,0))
with(d.class, {hist(height);
     boxplot(height);
     qqnorm(height); qqline(height);
     plot(height); rug(height,side=2)})
mtext(side=3, text='身高分布', cex=2, outer=T)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-parmfrow01-1.png)

```
par(opar)
```

## 29.4 图形输出

只要启用了高级绘图函数会自动选用当前绘图设备， 缺省为屏幕窗口。

### 29.4.1 PDF 输出

用`pdf`函数可以指定输出到PDF文件。如

```
pdf(file='fig-hw.pdf', height=10/2.54,
    width=10/2.54, family='GB1')
with(d.class, plot(height, weight,
                   main='体重与身高关系'))
dev.off()
```

用`dev.off()`关闭当前设备并生成输出文件 （如果是屏幕窗口则没有保存结果）。

### 29.4.2 PNG输出

```
png(file='fig-hw.png', height=1000, width=1000)
with(d.class, plot(height, weight,
                   main='体重与身高关系'))
dev.off()
```

类似地， 用`jpeg()`函数启用JPEG图形设备, 用`bmp()`函数启用BMP图形设备, 用`postscript()`函数启用PostScript图形设备。

## 29.5 包含多种中文字体的图形

为了使用MS Windows系统字体， 一种办法是安装showtext包。 该包替换画图时的添加文本函数命令， 把文本内容替换成多边形（PDF或PS图）或点阵（点阵图）。

需要的工作：

- 查看Windows的font目录内容，看文件名与字体名的对应关系。 下面的程序中的列表是我的中文Windows 10的部分中文字体。
- 找到自己希望使用的中文字体的文件名。
- 用font.add()命令，增加一套自定义字体family， 一套中可以指定四种：常规(regular), 粗体(bold), 斜体(italic), 粗斜体(bolditalic)
- 程序中调入showtext包并运行showtext.auto()命令，这个命令使得文本命令采用showtext包
- 用par(family=)指定自定义的字体family。
- 作图（主要是PDF）。关闭图形设备。

```
test.chinese <- function(){
    require(showtext); showtext.auto()

    ## 建立文件名到字体名对照表
    fmap <- c(
        'msyh'='微软雅黑常规',
        'msyhbd'='微软雅黑粗体',
        'msyhl'='微软雅黑细体',
        'simsun'='宋体',
        'simfang'='仿宋',
        'simkai'='楷体',
        'simhei'='黑体',
        'SIMLI'='隶书',
        'SIMYOU'='幼圆',
        'STSONG'='华文宋体',
        'STZHONGS'='华文中宋',
        'STFANGSO'='华文仿宋',
        'STKAITI'='华文楷体',
        'STXIHEI'='华文细黑',
        'STLITI'='华文隶书',
        'STXINGKA'='华文行楷',
        'STXINWEI'='华文新魏',
        'STCAIYUN'='华文彩云',
        'STHUPO'='华文琥珀'
        )
    fmapr <- names(fmap); names(fmapr) <- unname(fmap)
    cat('==== 字体文件名与字体名称对应:\n')
    print(fmap)
    cat('==== 字体名与字体文件名对应:\n')
    print(fmapr)

    ## 找到某个字体的字体文件
    ## font.name是字体名称
    find.font <- function(font.name){
        fname <- fmapr[font.name]
        flist0 <- font.files()
        flist1 <- sapply(strsplit(flist0, '[.]'), function(it) it[1])
        flist0[flist1==fname]
    }
    ff1 <- find.font('宋体')
    ff2 <- find.font('黑体')
    ff3 <- find.font('仿宋')
    ff4 <- find.font('隶书');

    font.add('cjk4',
             regular=ff1,
             bold=ff2,
             italic=ff3,
             bolditalic=ff4)
    ##browser()

    pdf('test-chinese.pdf'); on.exit(dev.off())
    par(family='cjk4')
    
    plot(c(0,1), c(0,1), type='n',
         axes=FALSE, xlab='', ylab='')
    text(0.1, 0.9, '正体', font=1)
    text(0.1, 0.8, '粗体', font=2)
    text(0.1, 0.7, '斜体', font=3)
    text(0.1, 0.6, '粗斜体', font=4)
}
test.chinese()
```

注意：图形参数font=1表示正体， font=2表示粗体, font=3表示斜体, font=4表示粗斜体。

## 29.6 其它图形

### 29.6.1 相关系数图

用`cor(x)`可以计算数据框`x`的各列的相关系数阵。 corrgram包的`corrgram()`函数可以将相关系数阵用图形表示， 系数绝对值大小用色块颜色深浅表示， 正负用两种颜色区分。

例如， 计算iris数据框中四个测量值的相关系数并用矩阵表示：

```
library(corrgram)
R.iris <- cor(iris[,1:4])
print(round(R.iris, 2))  
##              Sepal.Length Sepal.Width Petal.Length Petal.Width
## Sepal.Length         1.00       -0.12         0.87        0.82
## Sepal.Width         -0.12        1.00        -0.43       -0.37
## Petal.Length         0.87       -0.43         1.00        0.96
## Petal.Width          0.82       -0.37         0.96        1.00
corrgram(
  R.iris, order=TRUE, 
  lower.panel=panel.shade,
   upper.panel = panel.pie,
   text.panel = panel.txt
)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/graph_files/figure-html/graph-iris-corrgram01-1.png)

左下方用颜色代表正负相关， 蓝色为正相关，红色为负相关， 可以看出花萼长(Sepal.Length)、花瓣宽(Petal.Width)和花瓣长(Petal.Length)相互为较强的正相关， 但是花萼宽与其它三个变量为负相关。 这个相关结果实际是虚假的， 因为样本不是单一总体而是来自三个总体。 图形右上方用阴影部分大小和颜色深度代表相关系数绝对值， 用颜色区分正负。











# 30 ggplot作图入门

## 30.1 介绍

Hadley Wickem的ggplot2包是R的一个作图用的扩展包， 它实现了“图形的语法”， 将一个作图任务分解为若干个子任务， 只要完成各个子任务就可以完成作图。 在作常用的图形时， 只需要两个步骤： 首先将图形所展现的数据输入到`ggplot()`函数中， 然后调用某个`geom_xxx()`函数， 指定图形类型，如散点图、曲线图、盒形图等。

如果需要进一步控制图形细节， 只要继续调用其它函数， 就可以控制变量值的表现方式(scale)、图例、配色等。 这使得我们很容易做出基本的图形， 在有需要时再深入学习， 做出更为满意的图形。

ggplot2的作图一般步骤为：

- 准备数据，一般为数据框， 且一般为长表， 即每个观测时间占一行， 每个观测变量占一列。
- 将数据输入到`ggplot()`函数中， 并指定参与作图的每个变量分别映射到哪些图形特性， 比如映射为x坐标、y坐标、颜色、形状等。 这些映射称为aesthetic mappings或aesthetics。
- 选择一个合适的图形类型， 函数名以`geom_`开头， 如`geom_point()`表示散点图。 图形类型简称为geom。 将`ggplot()`部分与`geom_xxx()`部分用加号连接。 到此已经可以作图，下面的步骤是进一步的细化设定。
- 设定适当的坐标系统， 如`coord_cartesian()`, `scale_x_log10()`等。 仍用加号连接。
- 设定标题和图例位置等，如`labs()`。 仍用加号连接。

这个流程的一个大致的模板为：

```
p <- ggplot(data=<输入数据框>,
  mapping=aes(<维度>=<变量名>,
    <维度>=<变量名>, <...>))
p + geom_<图形类型>(<...>) + 
  scale_<映射>_<类型>(<...>) +
  coord_<类型>(<...>) +
  labs(<...>)
```

其中`<...>`表示额外的选项。 变量`p`包含做出的图形的所有数据与设定， 变量名可以任意取。

本章内容主要来自：

- Healy, Kieran (2018). Data Visualization: A Practical Introduction. Princeton University Press. https://socviz.co/index.html 这本书讲了R的ggplot的使用， 也讲了一些可视化的一般性原则。
- Claus O. Wilke(2019). Fundamentals of Data Visualization. O’Reilly Media. https://serialmentor.com/dataviz/ 这本书虽然也使用R的ggplot2包， 但正文中没有代码， 主要讲作图有哪些考虑、各种图形类型。 代码在github上可下载。
- Winston Chang(2018). R Graphics Cookbook. O’Relly Media. 网站：https://r-graphics.org/ 为第二版。 讲了各种图的R程序。
- Wickham, Hadley (2016). Ggplot2: Elegant graphics for data analysis. New York: Springer.

Wickham的书主要需要安装tidyverse扩展包， 安装时会自动安装其它一些有关扩展包。 Healy的的书需要通过如下程序安装socviz软件包：

```
devtools::install_github("kjhealy/socviz")
```

后续的例子中用到一些数据集:

- 来自gapminder扩展包的gapminder数据集， 有若干个国家不同年份的一些数据， 包括所属洲、期望寿命、人口数、人均GDP。 有1704个观测和6个变量。
- socviz包的`gss_sm`数据集，是2016年美国一般社会调查数据的部分内容。 有2867个观测，32个变量。 社会调查数据的变量主要取属性值， 比如无序分类、有序分类、分组的数值、整数值等。
- socviz包的organdata数据集， 是17个OECD国家历年的器官捐献情况以及一些其它记录。
- socviz扩展包的`elections_historic`数据集。 包括美国历次总统大选当选人、所属党派、支持比例等。
- socviz扩展包的asasec数据集。 这是美国社会学学会(ASA)的各分会2005年到2015年的一些数据。
- ggplot2包中的`midwest`数据集包含了美国中西部的一些县的统计数据， 如面积等。
- 来自ggplot2包的钻石数据集。

gapminder的头部：

```
library(gapminder)
head(gapminder, 20)
## # A tibble: 20 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    <fct>       <fct>     <int>   <dbl>    <int>     <dbl>
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
## 11 Afghanistan Asia       2002    42.1 25268405      727.
## 12 Afghanistan Asia       2007    43.8 31889923      975.
## 13 Albania     Europe     1952    55.2  1282697     1601.
## 14 Albania     Europe     1957    59.3  1476505     1942.
## 15 Albania     Europe     1962    64.8  1728137     2313.
## 16 Albania     Europe     1967    66.2  1984060     2760.
## 17 Albania     Europe     1972    67.7  2263554     3313.
## 18 Albania     Europe     1977    68.9  2509048     3533.
## 19 Albania     Europe     1982    70.4  2780097     3631.
## 20 Albania     Europe     1987    72    3075321     3739.
```

`gss_sm`的头部：

```
head(gss_sm, 20)
## # A tibble: 20 x 32
##     year    id ballot   age childs  sibs degree race  sex   region income16
##    <dbl> <dbl>  <dbl> <dbl>  <dbl> <dbl> <fct>  <fct> <fct> <fct>  <fct>   
##  1  2016     1      1    47      3     2 Bache~ White Male  New E~ $170000~
##  2  2016     2      2    61      0     3 High ~ White Male  New E~ $50000 ~
##  3  2016     3      3    72      2     3 Bache~ White Male  New E~ $75000 ~
##  4  2016     4      1    43      4     3 High ~ White Fema~ New E~ $170000~
##  5  2016     5      3    55      2     2 Gradu~ White Fema~ New E~ $170000~
##  6  2016     6      2    53      2     2 Junio~ White Fema~ New E~ $60000 ~
##  7  2016     7      1    50      2     2 High ~ White Male  New E~ $170000~
##  8  2016     8      3    23      3     6 High ~ Other Fema~ Middl~ $30000 ~
##  9  2016     9      1    45      3     5 High ~ Black Male  Middl~ $60000 ~
## 10  2016    10      3    71      4     1 Junio~ White Male  Middl~ $60000 ~
## 11  2016    11      2    33      5     4 High ~ Black Fema~ Middl~ under $~
## 12  2016    12      1    86      4     4 High ~ White Fema~ Middl~ under $~
## 13  2016    13      2    32      3     3 High ~ Black Male  Middl~ $8 000 ~
## 14  2016    14      3    60      5     6 High ~ Black Fema~ Middl~ $12500 ~
## 15  2016    15      2    76      7     0 Lt Hi~ White Male  New E~ $40000 ~
## 16  2016    16      3    33      2     1 High ~ White Fema~ New E~ $50000 ~
## 17  2016    17      3    56      6     3 High ~ White Male  New E~ $50000 ~
## 18  2016    18      2    62      5     8 Lt Hi~ Other Fema~ New E~ $5 000 ~
## 19  2016    19      2    31      0     2 Gradu~ Black Male  New E~ $35000 ~
## 20  2016    20      1    43      2     0 High ~ Black Male  New E~ $25000 ~
## # ... with 21 more variables: relig <fct>, marital <fct>, padeg <fct>,
## #   madeg <fct>, partyid <fct>, polviews <fct>, happy <fct>,
## #   partners <fct>, grass <fct>, zodiac <fct>, pres12 <dbl>,
## #   wtssall <dbl>, income_rc <fct>, agegrp <fct>, ageq <fct>,
## #   siblings <fct>, kids <fct>, religion <fct>, bigregion <fct>,
## #   partners_rc <fct>, obama <dbl>
```

## 30.2 作图的一般原则

关于什么是好的图形和坏的图形， William S. Cleveland， Edward R. Tufte等人有很多的研究。

坏的图形可能有如下缺点：

- 坏的品味。统计图形应该用尽可能少的图形元素表示尽可能多的数据， 从打印图形而言，即数据量与所用墨水比例越大越好。 没有必要的颜色、三维形态经常会影响读者对图形的认读。 这是Edward R. Tufte的观点， 但是过于极端也不好。
- 坏的数据。 即使图形本身的做法没有问题， 选择了错误的或者不合适的数据也会误导读者， 甚至于用错误数据做的很专业的图形会比粗陋的图形更能误导读者。
- 坏的感知。 不好的颜色选择、三维形状、坐标轴范围、宽高比都有可能对读者的认知有影响。

作图时应考虑的一些因素：

- 数值型变量的不同值可以表示为：

  - 同一坐标轴上的不同位置、
  - 不同轴上的位置、
  - 不同长度、
  - 不同角度或者斜率、
  - 不同面积、
  - 三维空间中的不同位置、
  - 颜色的不同明暗度、
  - 不同颜色饱和度、
  - 曲线的不同曲率、
  - 三维体积，

  这些表示的选择项越往后越难以被读者正确辨识。 使用颜色时，应该使用渐变的明暗度或者渐变色。

- 分类变量的不同值可以表示为：

  - 不同分组、
  - 不同颜色、
  - 三维动态、
  - 不同符号。

  这些表示的选择项越往后越难辨识。 使用颜色时，应该使用明显不同的颜色而不应该使用渐变色。

- 对于最少是零的变量， 是否应该以零作为坐标轴的最低值需要考虑， 但没有一定的规则。 同一组数据在不同的坐标范围或者长宽比下曲线的斜率会有很大差别。

## 30.3 散点图：ggplot入门

### 30.3.1 基本的散点图

以gapminder数据集作为输入数据， 做出简单的散点图， 并逐步进行改善。 这个数据集有多个国家在多个年份的期望寿命与人均GDP值， 作期望寿命对人均GDP的散点图， 每个国家的每个年份作为一个点。 散点图最重要的映射是x轴与y轴两个维度。

首先调用`ggplot()`函数， 指定数据集， 将人均GDP映射到x轴， 将期望寿命映射到y轴， 结果保存为一个R变量：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
```

x、y轴是最常见的映射， 也可以将变量映射为颜色、符号、线型等， 这时不需要指定具体的颜色、符号、线型， 而是将变量映射为这些图形元素类型。

在如上指定了数据和映射后， 只要用`geom_xxx()`指定一个图形类型， 并与`ggplot()`的结果用加号连接就可以作图了，如：

```
p + geom_point()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point01b-1.png)

实际上，上面的程序等同于调用`print(p + geom_point())`。 在R函数中应该显示地调用`print()`。

### 30.3.2 逐步改善

指定数据集、指定映射、选择适当的图形类型就可以做出基本的图形， 随后可以逐步对坐标系、坐标系刻度、标签与图例、配色等进行改善。 实际上，ggplot2包已经提供了十分合理的预设值， 用户只要进行一些必要的改动即可。

作图步骤之间用加号连接，这是ggplot包特有的语法。 例如， 用相同的映射做出拟合曲线图：

```
p + geom_smooth()
## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point01c-1.png)

用相同的映射做出散点图并叠加拟合曲线图：

```
p + geom_point() + geom_smooth()
## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point01d-1.png)

`geom_smooth()`的默认设置调用了`gam()`函数来拟合曲线， 可以用`geom_smooth()`的参数选择不同的拟合方法， 如直线拟合：

```
p + geom_point() + geom_smooth(method="lm")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point01e-1.png)

注意`geom_xxx()`函数计算所需的变量值是从`ggplot()`函数保存在变量`p`中的信息提取的。

在以上的所有图形中， x轴变量（人均GDP）分布非正态，严重右偏， 使得大多数散点重叠地分布在直角坐标系的左下角。 将x轴用对数刻度可以改善， 函数为`scale_x_log10()`:

```
p + geom_point() +
  geom_smooth(method="gam") +
  scale_x_log10()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point01f-1.png)

广义可加模型拟合的曲线基本是一条直线。 注意， 在进行拟合时， 已经预先对人均GDP变量进行常用对数变换。

刚刚的图形的横坐标轴刻度不太友好， 可以调用scales扩展包的适当函数进行改善， 作为`scale_x_log10()`的`labels`选项：

```
p + geom_point() +
  geom_smooth(method="gam") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point01g-1.png)

`scale_xxx()`的`labels`选项指定如何标出坐标刻度数字， 参数值是一个函数对象， 如果scales包中找不到适当的功能， 可以自定义一个函数将数值转换为字符串。 scales包提供了`comma`, `date`, `dollar`, `math`, `number`, `ordinal`, `pvalue`, `scientific`, `time`等坐标刻度值转换函数。

### 30.3.3 颜色、符号、线型等映射

在`ggplot()`函数的`mapping`参数的`aes()`设定中将变量映射到x、y轴， 颜色、符号、线型等图形元素类型， 也可以作为图形设置将某些图形元素设置为固定值。

例如， 用不同颜色表示不同大洲， 就是将`continent`变量映射到`color`:

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp,
    color = continent))
```

程序中仅指定了将大洲映射到颜色维， 并不具体指定所用的颜色。

作带有局部多项式曲线拟合的散点图：

```
p + geom_point() +
  geom_smooth(method="loess") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point02b-1.png)

可以看出， 不同散点用了不同颜色表示其continent变量的值， 五个大洲分别进行了曲线拟合， 使得图形比较复杂，难以认读。 在图形右侧自动生成了颜色与continent变量值的对应关系图例。

下面的图形分不同大洲作曲线拟合， 并将置信区间阴影的颜色也用不同大洲区分， 方法是在`aes()`中将`color`和`fill`都指定为变量`continent`:

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp,
    color = continent,
    fill = continent))
p + geom_point() +
  geom_smooth(method="loess") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point03-1.png)

尝试将颜色指定为一个固定值，如：

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp,
    color = "green"))
p + geom_point() +
  geom_smooth(method="loess") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point04-bad-1.png)

我们发现， 散点并没有使用绿色， 而且图形右侧有一个`green`图例。 这是因为， `aes()`仅用来指定变量与图形元素类型的映射， 所以实际上是生成了一个仅有一个常数值`"green"`的新变量， 用颜色表示这个新变量。 为了指定固定颜色， 可以作为`geom_xxx()`函数的选项，如：

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
p + geom_point(color="green") +
  geom_smooth(method="loess") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point05-1.png)

`geom_xxx()`函数接受许多关于颜色、透明度、符号、线型的设置参数。 比如， 下面的程序指定了散点的透明度， 以及拟合直线的粗细：

```
p + geom_point(alpha=0.5) +
  geom_smooth(method="lm", color="cyan", se = FALSE, size = 8) +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point05b-1.png)

程序中`size`指定了线的粗细倍数， `se = FALSE`关闭了置信区间显示。 用`alpha =`设置了透明度， 取0和1之间的值， 数值越小越透明。 在有许多个点时适当设置透明度可以比较好地显示出重叠的点， 重叠点越多点的颜色越深。 虽然这里设置了固定的透明度， 也可以在`aes()`中将透明度`alpha`映射到某个变量， 使得该变量值大小用点的透明度表示。

下面用`labs()`函数给图形加上适当的标题：

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
p + geom_point(alpha = 0.3) +
  geom_smooth(method="gam") +
  scale_x_log10(labels=scales::dollar) + 
  labs(
    x = "人均GDP",
    y = "期望寿命（年数）",
    title = "经济增长与期望寿命",
    subtitle = "数据点为每个国家每年",
    caption = "数据来源: gapminder"  )
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point06-1.png)

可以看出， `labs()`规定了上方的标题、小标题， x轴、y轴的标题， 右下方的标注(caption)。 坐标轴刻度数值的规定则需要在`scale_xxx()`函数中给出。

### 30.3.4 在geom函数中映射变量

在前面的一个例图中， 在`ggplot()`函数中将`color`和`fill`映射到了`continent`变量， 使得不仅散点颜色代表了不同大洲， 还使得每个大洲单独拟合了曲线。 如果希望所有大洲拟合同一条曲线怎么办？

在必要时， 可以在`geom_xxx()`函数中用`mapping = aes(<...>)`单独指定变量映射。 例如， 下面的程序在`geom_point()`中将不同大洲映射为不同颜色， 而不影响`geom_smooth()`中的颜色以及分组：

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
p + geom_point(mapping = aes(color = continent)) +
  geom_smooth(method="loess") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point07-1.png)

### 30.3.5 连续变量的颜色映射

也可以将连续变量映射为渐变色。 除了表示二元函数的等值线图以外这种方法并不利于读者认读。

例如， 将人口数取自然对数映射为渐变色：

```
p <- ggplot(data=gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp,
    color = log(pop)))
p + geom_point() +
  geom_smooth(method="loess") +
  scale_x_log10(labels=scales::dollar)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-start-gapminder-point08-1.png)

这里不同散点的颜色是连续变化的， 右侧的图例仅显示了有限的一些代表值。

### 30.3.6 保存图像

如果使用Rmarkdown制作图文， 图像会自动进入编译的结果（如PDF、Word、HTML）中， 图像大小、输出大小可以用Rmarkdown的设置调整。

为了将最近生成的图形保存为PNG格式，用命令如

```
ggsave(filename="文件名.png")
```

保存为PDF格式：

```
ggsave(filename="文件名.pdf")
```

如果将制作的图形保存到了一个R变量中， 在`ggsave()`中可以用`plot=`参数指定，如

```
ggout01 <- p + geom_point()
ggsave(filename="文件名.pdf", plot=ggout01)
```

在`ggsave()`中可以用`scale =`指定放大比例， 用`height =`指定高度， 用`width =`指定宽度，用`units =`指定高度和宽度的单位，如：

```
ggsave(filename="文件名.pdf", plot=ggout01,
       height=12, width=8, units="cm")
```

单位可以是in, cm, mm。

## 30.4 分组、小图、变换、条形图

### 30.4.1 图形中的分组

考虑gapminder数据集中每个国家的期望寿命随时间（年）的变化。 用`geom_line()`可以画折线图。 因为有许多国家，所以无法直接作图，如：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = year, 
    y = lifeExp))
p + geom_line()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-group01-1.png)

没有得出我们希望的每个国家一条曲线的效果。 这是因为程序中没有指定需要按照国家分组， 使得同一年的不同国家的坐标连成了一条竖线。

要注意的是， `geom_line()`会自动将x坐标从小到大排序， 然后再连接相邻的点。 如果希望按输入数据的次序连接相邻的点， 需要用`geom_path()`函数。

为了解决上图的问题， 加入按照国家分组的设定。 实际上， 分组(`group`)与`x`、`y`、`color`、`fill`一样可以映射到一个变量， 但仅能映射到分类变量。 上述程序的改进如下：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = year, 
    y = lifeExp,
    group = country))
p + geom_line()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-group01b-1.png)

结果图形中每一条曲线对应一个国家。 为了查探其中最下方的不稳定曲线是哪一个国家，使用筛选观测的功能：

```
gapminder %>%
  filter(lifeExp < 30, year >= 1990)
## # A tibble: 1 x 6
##   country continent  year lifeExp     pop gdpPercap
##   <fct>   <fct>     <int>   <dbl>   <int>     <dbl>
## 1 Rwanda  Africa     1992    23.6 7290203      737.
```

该国家为Rwanda。

分组(group)映射仅在其它映射没有将分组考虑在内的情况。 比如， 分大洲用不同颜色，用了`color=continent`， 则不需要`group=continent`。

### 30.4.2 小图(facet)

上面的图包含了过多的曲线， 使得图形表现得很拥挤。 可以将一个作图区域拆分成若干个小块， 称为小图（facet）， 按照某一个或两个分类变量的不同值将数据分为若干个子集， 每个数据子集分别在小图上作图。

对于上面的例子， 可以将每个大洲的图形分别放置在一个小图上。 小图不是一种变量映射， 而是一种图形摆放方法， 所以不设置在`aes()`函数内， 而是用`facet_wrap()`函数规定。 这种功能与`group`映射的功能有些重复， 所以有时需要与`group`映射配合使用， 有时则不需要。 程序如：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = year, 
    y = lifeExp,
    group = country))
p + geom_line() + facet_wrap(~ continent)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-facet01-1.png)

区分不同小图的标签写在每个小图的上方。 可以用`facet_wrap()`参数`strip_position`和参数`switch`调整标签的上下左右。

小图之间默认公用了横坐标和纵坐标且坐标范围保持一致。 如果不保持一致， 读者可能会有误解。 但是x轴或y轴映射为分类变量且不同小图的分类完全不同时， 可以令各小图中该轴的取值不统一。 `facet_wrap()`选项`scales`默认为`"fixed"`， 即所有小图的x轴、y轴都范围一致， 取`"free_x"`则允许各小图的x轴不统一， `"free_y"`允许各小图的y轴不统一， `"free"`允许各小图的x轴和y轴都不统一。

在`facet_wrap()`中可以用`ncol`参数指定小图的列数， 用`nrow`指定小图的行数。 各个小图的次序应该设定为一定的合理次序， 比如用来分类的变量本身有序， 或者令各小图中的数据值有一定的增减次序。

下面的程序将曲线颜色变浅， 对每个大洲增加了拟合曲线， 增加了适当的标题和坐标轴标签：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = year, 
    y = lifeExp))
p + geom_line(mapping = aes(group = country), color = "gray70") +
  geom_smooth(method = "loess", color="cyan", se = FALSE, size = 1.1) +
  facet_wrap(~ continent, ncol = 2) +
  labs(
    x = "年份",
    y = "期望寿命",
    title = "五个大洲各国期望寿命变化趋势"
    )
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-facet01b-1.png)

注意`group = country`的设置从`ggplot()`函数中转移到了`geom_line()`函数中， 否则就意味着拟合线也需要按照国家分组， 而不是按大洲分组。

`facet_wrap()`主要适用于按照一个分类变量的值将不同观测在不同小图中表现， 可以人为指定小图的行数和列数。 如果需要按照两个分类变量交叉分组分配小图， 可以用`facet_grid()`函数。

例如， 对`gss_sm`数据集，作小孩个数对年龄的散点图：

```
p <- ggplot(data=gss_sm,
  mapping = aes(
    x = age,
    y = childs))
p + geom_point(alpha = 0.2)
## Warning: Removed 18 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-facet-gss01-1.png)

有过多的重叠点。 将观测按照性别(sex)和种族(race)交叉分组， 分配到不同的小图上：

```
p + geom_point(alpha = 0.2) +
  facet_grid(sex ~ race)
## Warning: Removed 18 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-facet-gss01b-1.png)

交叉分组时作小图时， `sex ~ race`这种写法使得不同性别对应到不同行， 不同种族对应到不同列。 在图形中增加拟合曲线：

```
p + geom_point(alpha = 0.2) +
  geom_smooth() +
  facet_grid(sex ~ race)
## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'
## Warning: Removed 18 rows containing non-finite values (stat_smooth).
## Warning: Removed 18 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-facet-gss01c-1.png)

这里虽然没有映射`group`维， 但还是按性别和种族对数据集分成了6个子集， 每个小图中仅有一个自己的数据。

### 30.4.3 数据变换与条形图

有些`geom_xxx()`函数直接按照数据值作图， 如`geom_point()`、`geom_line()`， 而`geom_smooth()`这样的函数则会按照某种算法计算并对计算结果作图。 `geom_xxx()`都有默认的`stat_xxx()`函数用来计算， 也可以人为指定不同的统计规则。

考虑条形图的例子。 ggplot2中的条形图函数`geom_bar()`可以对一个分类变量自动统计频数， 并作频数条形图。 比如对`gss_sm`数据集的bigregion变量作频数条形图：

```
p <- ggplot(data = gss_sm,
  mapping = aes(x = bigregion))
p + geom_bar()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-gss01-1.png)

结果是每个大区的受访者人数的条形图。 图形中`x`映射是用户指定的， 而`y`轴则是自动计算的频数。 实际上， `geom_bar()`自动调用了统计函数`stat_freq()`对每个大区计算频数， 生成新变量`count`和`prop`。 `geom_bar()`默认使用`count`(频数)。

下面的程序将纵坐标改成了比例：

```
p + geom_bar(mapping = aes(y = ..prop..))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-gss01b-1.png)

程序中的统计结果比例用特殊变量名`..prop..`表示。 这个图形是错误的， 原因是在`ggplot()`函数中指定`x = bigregion`后， 因为条形图的主要变量变量`bigregion`是分组变量， 这样在`geom_bar()`的执行中仍按照`bigregion`分组。 解决方法是在`geom_bar()`的`aes()`中加入`group = 1`选项， 这实际是定义了一个常数值的分组变量，也就仅有一组了：

```
p + geom_bar(mapping = aes(y = ..prop.., group = 1))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-gss01c-1.png)

虽然解决了问题， 但是用`geom_bar()`函数直接从原始数据做比例的条形图还是很容易做错， 所以建议从原始数据中用数据概括方法算出比例再用`geom_col()`函数作条形图， 见[30.4.6](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#ggplot2-right-barfromtable)。

下面的例子作`gss_sm`数据集中`religion`变量的频数条形图， 并给不同的条形自动分配不同的颜色， 方法是指定`fill = religion`：

```
p <- ggplot(data = gss_sm,
  mapping = aes(x = religion, fill = religion))
p + geom_bar()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-gss02-1.png)

因为将`religion`同时映射到`x`维与`fill`维， 所以对应`fill`维在图形右侧出现了图例， 这是多余的。 调用`guides(fill = FALSE)`可以人为指定不做关于填充色的图例：

```
p + geom_bar() +
  guides(fill = FALSE)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-gss02b-1.png)

从可视化理论的角度看， 上图中的不同颜色是多余的， 用同一颜色更能强度数据本身。

### 30.4.4 分段与并列条形图

上面的条形图展现了单个分类变量的频数分布。 两个分类变量的交叉频数分布可以用分段条形图或者并列条形图表现。

例如，对`gss_sm`数据集， 按照bigregion分组计算频数， 每组内再按照religion计算频数，作图如下：

```
p <- ggplot(data = gss_sm,
  mapping = aes(
    x = bigregion, 
    fill = religion))
p + geom_bar()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-barseg-gss01-1.png)

这样的图形可以很容易地比较大类(这里是bigregion)的频数比例， 但大类内的小类(这里是religion)可以比较容易地在大类内部比较， 但是在大类之间比较则较困难。 如果仅有两个小类， 则小类在大类之间的比较也没有问题。

另一种做法是将大类的高度拉平， 图形仅表示每一大类内部小类的比例， 没有大类频数信息， 也不能比较两个大类之间的小类频数， 但可以大致地在大类之间比较小类的比例：

```
p + geom_bar(position = "fill")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-barseg-gss01b-1.png)

上面的程序在`geom_bar()`中用了`position = "fill"`选项。

并排的条形图可以表现每个交叉类的频数， 可以比较容易地比较每个大类内部的小类比例以及小类的频数， 但是不容易比较大类的比例：

```
p + geom_bar(position = "dodge")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-barseg-gss01c-1.png)

如果想将上图中的纵轴改为大类内的比例， 下面的第一次尝试给出错误的结果：

```
p + geom_bar(position = "dodge", 
             mapping = aes(y = ..prop..))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-barseg-gss01d-1.png)

出错的原因是， `ggplot()`中的`x =`和`fill =`指定了两个分组变量， 结果是交叉地分成了个组， 每一组内的比例当然都是100%。 第二次尝试指定分组变量仅为religion:

```
p + geom_bar(position = "dodge", 
    mapping = aes(y = ..prop.., group=religion))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-barseg-gss01e-1.png)

这个图形表面上没错， 但是仔细查看发现， 上图中每个大区内部的宗教比例之和不等于1， 而是每种宗教在不同大区之间的比例之和等于1。

实际上， 对于列联表， 最好是预先统计出列联表结果， 以列联表为输入用`geom_col()`函数作图， 就可以避免许多错误图形。

为了在不同大区之间比较宗教比例分布， 可以借助于小图， 将每个大区分配到一个小图：

```
p <- ggplot(data = gss_sm, 
    mapping = aes(x = religion, group=bigregion))
p + geom_bar(position = "dodge", 
    mapping = aes(y = ..prop..)) +
  facet_wrap(~ bigregion, ncol=2)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-barseg-gss02-1.png)

注意上面的程序将`x`映射到了religion， 将`group`映射到了bigregion。 如果不映射`group`则图形还是错误的。 直接对原始数据做并列条形图比较类内比例不够直观， 更好的办法是先统计出交叉频数表， 以交叉频数表作为图形函数的输入作图， 见[30.4.6](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#ggplot2-right-barfromtable)。

### 30.4.5 直方图与密度估计

条形图(barplot)反映分类变量的频数分布或者比例， 直方图(histogram)反映连续取值的数值变量的分布。 `geom_histogram()`作直方图， 可以自动选取合适的分组个数， 也可以人为指定分组个数。

ggplot2包中的`midwest`数据集包含了美国中西部的一些县的统计数据， 如面积（单位：平方英里）。 下面的程序对连续取值的数值型变量area作频数直方图， 自动确定分组个数：

```
p <- ggplot(data = midwest,
    mapping = aes(x = area))
p + geom_histogram()
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest01-1.png)

上面图形的纵坐标是频数(count)，是每个组的频数。 `geom_histogram()`默认调用`stat_bin()`进行分组及频数统计。 直方图的形状比较依赖于分组数与分组起始点位置， 可以用`bins`参数控制分组数， 用`binwidth`参数控制分组宽度， 用`center`或者`boundary`参数控制组中心或者组边界对齐位置， 如：

```
p + geom_histogram(bins = 15)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest01b-1.png)

可以利用`fill`映射将构成直方图的观测按照某个分类变量分组， 然后每个条形内部按照该分类变量的值分段染色， 段内各颜色的长度代表该条形所在组某一类的频数， 如：

```
midwest_sub <- midwest %>%
  filter(state %in% c("OH", "WI"))
p <- ggplot(data=midwest_sub,
    mapping = aes(x = area, fill = state))
p + geom_histogram(bins = 10)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest02-1.png)

可见面积较小的县主要来自OH州， 面积较大的县主要来自WI州。

`geom_density()`可以对连续变量绘制密度估计曲线，如：

```
p <- ggplot(data = midwest,
    mapping = aes(x = area))
p + geom_density()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest03-1.png)

下面的程序写法制作每个州的各县的面积密度估计， 画在同一坐标系中：

```
p <- ggplot(data = midwest,
    mapping = aes(
      x = area, 
      color = state,
      fill = state))
p + geom_density(alpha = 0.3)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest04-1.png)

可以看出，IN与MI州各县的面积偏小。 WI州各县的面积较大。

上面的图形可以借助于`geom_line(stat = "density")`改成仅有多条曲线：

```
p <- ggplot(data = midwest,
    mapping = aes(
      x = area, 
      color = state))
p + geom_line(stat = "density")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest05-1.png)

`geom_density()`的纵轴是密度估计。 为了能够将直方图与密度估计画在同一坐标系中， 需要将直方图的纵轴也改为密度估计，如：

```
p <- ggplot(data = midwest,
    mapping = aes(x = area))
p + geom_histogram(mapping = aes(y = ..density..), alpha = 0.6) +
  geom_density(size = 1.1)
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-hist-midwest06-1.png)

进一步地， `geom_freqpoly()`将直方图做成折线格式； `geom_bin2d()`作二维的直方图，用不同颜色代表密度； `geom_density_2d()`作二维密度估计等值线图。

### 30.4.6 频数表的条形图

有时用来绘图的数据已经是一个频数表， 比如泰坦尼克号乘客生存与性别的频数表：

```
titanic
##       fate    sex    n percent
## 1 perished   male 1364    62.0
## 2 perished female  126     5.7
## 3 survived   male  367    16.7
## 4 survived female  344    15.6
```

这是一个长表格式的列联表， 对于`table()`生成的列联表可以用`as.data.frame`将其转换为长表格式。

在`geom_bar()`中指定`stat = "identity"`就表示频数（或者比例）已有， 用`y`维进行映射， 或者使用`geom_col()`函数，这时不需要`stat = "identity"`。 如：

```
p <- ggplot(data=titanic,
    mapping = aes(
      x = fate,
      y = n,
      fill = sex))
p + geom_bar(position = "dodge", stat = "identity")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-titanic02-1.png)

或：

```
p + geom_col(position = "dodge")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-titanic02b-1.png)

也可以按照性别分成大组：

```
p <- ggplot(data=titanic,
    mapping = aes(
      x = sex,
      y = n,
      fill = fate))
p + geom_col(position = "dodge")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-titanic03-1.png)

用`theme()`函数的`legend.position`参数可以指定图例的位置，如：

```
p + geom_col(position = "dodge") +
  theme(legend.position = "top")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-titanic03b-1.png)

做成堆叠形式：

```
p + geom_col(position = "stack")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-titanic03c-1.png)

实际上， 还可以用适当程序将存亡状态以及频数直接标在条形的色块内， `geom_text()`函数可以在指定坐标位置标注指定的文字标签， 见[30.5.3](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#ggplot2-moregeom-text)。

datasets包的Titanic数据集包含了泰坦尼克号乘客更详细的信息。 我们按照存亡结果和舱位等级分小图作男女频数条形图：

```
titanic2 <- as.data.frame(Titanic) %>%
  group_by(Class, Sex, Survived) %>%
  summarise(n = sum(Freq)) %>%
  filter(Class != "Crew") %>%
  mutate(Survived = factor(
    Survived, levels = c("Yes", "No"), 
    labels = c("survived", "perished")))
p <- ggplot(data = titanic2, mapping = aes(
  x = Sex, y = n, fill = Sex))
p + geom_col() + 
  facet_grid(Class ~ Survived) +
  guides(fill = FALSE)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-titanic04-1.png)

这里将`fill`映射到了Sex， 使得表示男女的条形填充了不同的颜色。 如果不满意上面的颜色， 可以用`scale_fill_manual()`函数人为地指定颜色、对应离散值和图例标签。 R扩展包colourpicker提供了很好交互图形界面用来挑选颜色。

`geom_col()`不仅限于画频数或者比例的条形图， 此函数可以将一般用折线图表现的内容画成条形图， 但一定要注意一点：y坐标轴必须从0开始， 这也是`geom_col()`和`geom_bar()`函数默认的设置。 如果坐标轴不从零开始， 则条形的长度就不能正确表示对应的y变量数值。

例如， socviz包的`oecd_sum`数据集包含各年的美国以及OECD国家的期望寿命：

```
oecd_sum
## # A tibble: 57 x 5
## # Groups:   year [57]
##     year other   usa  diff hi_lo
##    <int> <dbl> <dbl> <dbl> <chr>
##  1  1960  68.6  69.9 1.3   Below
##  2  1961  69.2  70.4 1.2   Below
##  3  1962  68.9  70.2 1.30  Below
##  4  1963  69.1  70   0.9   Below
##  5  1964  69.5  70.3 0.800 Below
##  6  1965  69.6  70.3 0.7   Below
##  7  1966  69.9  70.3 0.400 Below
##  8  1967  70.1  70.7 0.6   Below
##  9  1968  70.1  70.4 0.3   Below
## 10  1969  70.1  70.6 0.5   Below
## # ... with 47 more rows
```

我们用`geom_col()`作`diff`变量的条形图， 并按照`hi_lo`变量对正负差值分别使用不同颜色：

```
p <- ggplot(data = oecd_sum,
    mapping = aes(
      x = year, 
      y = diff,
      fill = hi_lo))
p + geom_col() + 
  guides(fill = FALSE) +  # 正负号的不同颜色不使用图例标注
  labs(x = NULL,
       y = "期望寿命差值",
       title = "美国期望寿命差值",
       subtitle = "1960-2015年美国与OECD国家期望寿命差值",
       caption="来自socviz扩展包")
## Warning: Removed 1 rows containing missing values (position_stack).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-right-bar-oecd02-1.png)

## 30.5 更多图形种类

### 30.5.1 列联表生成与绘图

虽然ggplot2包能进行一些默认的统计汇总， 但是这些工作毕竟还是用专门的工具处理更好。 tidyverse系列的工具比较适用于进行数据整理和数据汇总， 见第[27](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/summary-manip.html#summary-manip)章和第[28](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/summary-summ.html#summary-summ)章。

比如， 将列联表用并列条形图表示， 虽然ggplot2能直接从原始数据作图， 但是用户比较容易混淆频数、比例、行比例、列比例的区别， 最好是预先计算出作图所需的汇总表， 用长表形式表示， 即每个观测为某个分类或者交叉分类的频数。

考虑`gss_sm`数据集中分类变量`bigregion`与分类变量`religion`的列联表作图问题。 频数表：

```
tab <- gss_sm %>%
  count(bigregion, religion)
## Warning: Factor `religion` contains implicit NA, consider using
## `forcats::fct_explicit_na`
tab
## # A tibble: 24 x 3
##    bigregion religion       n
##    <fct>     <fct>      <int>
##  1 Northeast Protestant   158
##  2 Northeast Catholic     162
##  3 Northeast Jewish        27
##  4 Northeast None         112
##  5 Northeast Other         28
##  6 Northeast <NA>           1
##  7 Midwest   Protestant   325
##  8 Midwest   Catholic     172
##  9 Midwest   Jewish         3
## 10 Midwest   None         157
## # ... with 14 more rows
```

生成了长表格式的列联表， 保存成了tibble数据集， 这也正是ggplot2包所需的格式。

将上述的长表显示为宽表：

```
tab2 <- xtabs(n ~ bigregion + religion, data=tab)
tab2
##            religion
## bigregion   Protestant Catholic Jewish None Other
##   Northeast        158      162     27  112    28
##   Midwest          325      172      3  157    33
##   South            650      160     11  170    50
##   West             238      155     10  180    48
```

从原始数据生成这样的宽表，程序为：

```
tab2 <- gss_sm %$%
  table(bigregion, religion)
tab2
##            religion
## bigregion   Protestant Catholic Jewish None Other
##   Northeast        158      162     27  112    28
##   Midwest          325      172      3  157    33
##   South            650      160     11  170    50
##   West             238      155     10  180    48
```

将bigregion(大区)作为大类， 每个大区内做出各个宗教人数的频数条形图：

```
p <- ggplot(data=tab,
    mapping = aes(
      x = bigregion, 
      fill = religion,
      y = n )) 
p + geom_bar(stat = "identity", position = "dodge")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-gss01d-1.png)

使用同一个频数表， 将religion(宗教)作为大类， 在每种宗教中作不同大区的频数条形图：

```
p <- ggplot(data=tab,
    mapping = aes(
      x = religion,
      fill = bigregion, 
      y = n )) 
p + geom_bar(stat = "identity", position = "dodge")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-gss01e-1.png)

我们希望表现每个大区内的各种宗教的比例, 使得每个大区的比例之和等于1， 从宽表格式可以用`prop.table()`函数直接得到列百分比表：

```
tab2a <- prop.table(tab2, 2)
round(tab2a, 2)
##            religion
## bigregion   Protestant Catholic Jewish None Other
##   Northeast       0.12     0.25   0.53 0.18  0.18
##   Midwest         0.24     0.27   0.06 0.25  0.21
##   South           0.47     0.25   0.22 0.27  0.31
##   West            0.17     0.24   0.20 0.29  0.30
```

为了得到ggplot2所需格式， 可以用`as.data.frame(tab2a)`转换。

如果从原始数据直接统计，可以利用dplyr包的`group_by()`分组汇总功能：

```
tab3 <- gss_sm %>%
  group_by(bigregion, religion) %>%
  summarize(N = n()) %>%
  mutate(prop = N / sum(N),
         pct = round(100 * prop, 2))
## Warning: Factor `religion` contains implicit NA, consider using
## `forcats::fct_explicit_na`
tab3
## # A tibble: 24 x 5
## # Groups:   bigregion [4]
##    bigregion religion       N    prop   pct
##    <fct>     <fct>      <int>   <dbl> <dbl>
##  1 Northeast Protestant   158 0.324   32.4 
##  2 Northeast Catholic     162 0.332   33.2 
##  3 Northeast Jewish        27 0.0553   5.53
##  4 Northeast None         112 0.230   23.0 
##  5 Northeast Other         28 0.0574   5.74
##  6 Northeast <NA>           1 0.00205  0.2 
##  7 Midwest   Protestant   325 0.468   46.8 
##  8 Midwest   Catholic     172 0.247   24.8 
##  9 Midwest   Jewish         3 0.00432  0.43
## 10 Midwest   None         157 0.226   22.6 
## # ... with 14 more rows
```

程序中用`group_by()`做了交叉分组， `n()`计算每个交叉组的频数， 而`sum(N)`并不是计算总频数， 而是每个`bigregion`内部的频数。 在交叉分组时， `sum()`, `mean()`这些汇总函数是针对最内层的数据进行汇总的。

利用上述的数据， 作每个大区内各种宗教人数百分数的条形图：

```
p <- ggplot(data=tab3,
    mapping = aes(
      x = bigregion, 
      fill = religion,
      y = pct )) 
p + geom_bar(stat = "identity", position = "dodge") +
  labs(x = "大区", y = "百分数", fill="宗教") +
  theme(legend.position = "bottom")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-gss03b-1.png)

下面将每个大区的宗教百分数分布做成一幅小图， 用横向条形图， 作小图的程序中不涉及bigregion变量：

```
p <- ggplot(data=tab3,
    mapping = aes(
      x = religion, 
      fill = religion,
      y = pct )) 
p + geom_bar(stat = "identity", position = "dodge") +
  labs(x = NULL, y = "百分数") +
  guides(fill = FALSE) +
  coord_flip() + 
  facet_grid(~ bigregion)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-gss03c-1.png)

### 30.5.2 连续变量的分组图形

选用socviz包的organdata数据集， 这是17个OECD国家历年的器官捐献情况以及一些其他变量的记录。 其中前6列的一些抽样数据：

```
organdata %>%
  select(1:6) %>%
  sample_n(size = 10)
## # A tibble: 10 x 6
##    country        year       donors    pop pop_dens   gdp
##    <chr>          <date>      <dbl>  <int>    <dbl> <int>
##  1 Australia      1991-01-01   12.1  17284    0.223 17171
##  2 Switzerland    2001-01-01   13.2   7233   17.5   30134
##  3 United States  1994-01-01   19.4 263126    2.73  26578
##  4 France         1992-01-01   16.8  57240   10.4   19566
##  5 Belgium        1997-01-01   22.5  10181   30.8   22936
##  6 United States  1991-01-01   17.9 252981    2.63  23443
##  7 Germany        1998-01-01   13.4  82047   23.0   23283
##  8 United Kingdom 1999-01-01   12.1  58635   24.1   24086
##  9 Switzerland    1991-01-01   15.6   6797   16.5   24879
## 10 Spain          1997-01-01   29    39348    7.78  17203
```

变量donors是每百万人中器官捐献数。 作donors对year的散点图：

```
p <- ggplot(data = organdata,
    mapping = aes(
      x = year,
      y = donors))
p + geom_point()
## Warning: Removed 34 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ02-1.png)

每年有多个数值， 是不同国家的捐献数。 这个图形不能反映一种时间趋势， 不太有用。

可以对每个国家画一条折线图：

```
p <- ggplot(data = organdata,
    mapping = aes(
      x = year,
      y = donors,
      color = country))
p + geom_line()
## Warning: Removed 34 rows containing missing values (geom_path).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ03-1.png)

共有17个国家，每个国家做了器官捐赠率随时间变化的折线图。 用小图的方法将其分配到不同的小图：

```
p <- ggplot(data = organdata,
    mapping = aes(
      x = year,
      y = donors))
p + geom_line() +
  facet_wrap(~ country, ncol=4)
## Warning: Removed 2 rows containing missing values (geom_path).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ04-1.png)

用`geom_boxplot()`可以做盒形图， 能够画出连续型变量的主要分位数，表现变量分布，如：

```
p <- ggplot(data = organdata,
    mapping = aes(y = donors))
p + geom_boxplot()
## Warning: Removed 34 rows containing non-finite values (stat_boxplot).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ05-1.png)

这是所有国家所有年的捐献率分布情况。 类似函数还有`geom_violin()`。

每个国家的捐献率单独做盒形图并且放在同一坐标系中：

```
p <- ggplot(data = organdata,
    mapping = aes(y = donors, x = country))
p + geom_boxplot() + coord_flip()
## Warning: Removed 34 rows containing non-finite values (stat_boxplot).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ06-1.png)

这个图形很好地比较了不同国家的历年捐献率的分布， 比如， Spain的捐献率最高。 为了将图形中的各个国家按照捐献率的某个统计量排序， 可以使用stats包的`reorder()`函数， 调整因子的水平次序。 为了能够比较容易地标出国家名称， 交换x轴与y轴的作用， 如：

```
p <- ggplot(data = organdata,
    mapping = aes(
      y = donors, 
      x = reorder(country, donors, median, na.rm=TRUE)))
p + geom_boxplot() + 
  coord_flip() +
  labs(y = "捐献率(单位: 百万分之一)",
       x = NULL)
## Warning: Removed 34 rows containing non-finite values (stat_boxplot).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ07-1.png)

这里盒形图是横向的， 如果仍然纵向作图， 国家名称在横轴， 许多个国家名称就会重叠在一起， 只好仅显示其中一部分名称。

当每组（这里是每个国家）的观测个数很少时， 也可以做成散点图，如：

```
p <- ggplot(data = organdata,
    mapping = aes(
      y = donors, 
      x = reorder(country, donors, median, na.rm=TRUE)))
p + geom_point(alpha = 0.4) + 
  coord_flip() +
  labs(y = "捐献率(单位: 百万分之一)",
       x = NULL)
## Warning: Removed 34 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ08-1.png)

因为有的观测点完全重叠， 所以用了`alpha`参数指定一定的透明度， 重叠越多的点显示的颜色越深。 但是， 如果两个不同颜色的点完全重叠， 半透明不能显示两个不同颜色的效果。

在作这样的散点图时， 为了避免重叠的点， 可以将`geom_point()`改为`geom_jitter()`，如:

```
p + geom_jitter(alpha = 0.4) + 
  coord_flip() +
  labs(y = "捐献率(单位: 百万分之一)",
       x = NULL)
## Warning: Removed 34 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ08b-1.png)

上图的点的扰动过大了， 使得不同国家的区分不明显了。 作扰动的散点图时， 可以用`width`指定左右扰动范围， 用`height`指定上下扰动范围， 这里只需要指定左右扰动范围， 因为坐标轴对调所以就变成了上下扰动：

```
p + geom_jitter(alpha = 0.4, width = 0.15) + 
  coord_flip() +
  labs(y = "捐献率(单位: 百万分之一)",
       x = NULL)
## Warning: Removed 34 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ08c-1.png)

`geom_boxplot()`也支持`color`, `fill`维度。 organdata中的变量`world`是一个国家的福利类型， 用不同填充色表示`world`变量：

```
p <- ggplot(data = organdata,
    mapping = aes(
      y = donors, 
      x = reorder(country, donors, median, na.rm=TRUE),
      fill = world))
p + geom_boxplot() + 
  coord_flip() +
  labs(y = "捐献率(单位: 百万分之一)",
       x = NULL,
       fill = "福利类型") +
  theme(legend.position = "top")
## Warning: Removed 34 rows containing non-finite values (stat_boxplot).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ09-1.png)

下面做不同国家的平均捐赠率的图形。 首先得到统计数据：

```
organdata2 <- organdata %>%
  group_by(country) %>%
  summarize(
    donors_mean = mean(donors, na.rm=TRUE),
    donors_sd = sd(donors, na.rm=TRUE))
organdata2
## # A tibble: 17 x 3
##    country        donors_mean donors_sd
##    <chr>                <dbl>     <dbl>
##  1 Australia             10.6     1.14 
##  2 Austria               23.5     2.42 
##  3 Belgium               21.9     1.94 
##  4 Canada                14.0     0.751
##  5 Denmark               13.1     1.47 
##  6 Finland               18.4     1.53 
##  7 France                16.8     1.60 
##  8 Germany               13.0     0.611
##  9 Ireland               19.8     2.48 
## 10 Italy                 11.1     4.28 
## 11 Netherlands           13.7     1.55 
## 12 Norway                15.4     1.11 
## 13 Spain                 28.1     4.96 
## 14 Sweden                13.1     1.75 
## 15 Switzerland           14.2     1.71 
## 16 United Kingdom        13.5     0.775
## 17 United States         20.0     1.33
```

用条形图表现不同国家的平均捐献率：

```
p <- ggplot(data = organdata2,
    mapping = aes(
      x = reorder(country, donors_mean), 
      y = donors_mean))
p + geom_col() +
  coord_flip() +
  labs(x = NULL, y = "平均捐赠率(单位: 百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ20b-1.png)

这样的图形也可以做成点图， 称为Cleveland点图。 不需要再颠倒横纵坐标， 直接规定x轴为平均捐赠率即可：

```
p <- ggplot(data = organdata2,
    mapping = aes(
      y = reorder(country, donors_mean), 
      x = donors_mean))
p + geom_point() +
  labs(y = NULL, x = "平均捐赠率(单位: 百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ20c-1.png)

organdata数据集中变量`consent_law`是关于一个国家中器官捐赠是必须告知还是默认捐赠的区别。 为了在上面的点图中用不同颜色区分这两种做法， 需要在分组汇总阶段就将`consent_law`也作为分组变量。 这是因为`summarize()`函数会自动舍弃分组变量和统计结果之外的原有变量。

```
organdata3 <- organdata %>%
  group_by(consent_law, country) %>%
  summarize(
    donors_mean = mean(donors, na.rm=TRUE),
    donors_sd = sd(donors, na.rm=TRUE)) %>%
  ungroup()
organdata3
## # A tibble: 17 x 4
##    consent_law country        donors_mean donors_sd
##    <chr>       <chr>                <dbl>     <dbl>
##  1 Informed    Australia             10.6     1.14 
##  2 Informed    Canada                14.0     0.751
##  3 Informed    Denmark               13.1     1.47 
##  4 Informed    Germany               13.0     0.611
##  5 Informed    Ireland               19.8     2.48 
##  6 Informed    Netherlands           13.7     1.55 
##  7 Informed    United Kingdom        13.5     0.775
##  8 Informed    United States         20.0     1.33 
##  9 Presumed    Austria               23.5     2.42 
## 10 Presumed    Belgium               21.9     1.94 
## 11 Presumed    Finland               18.4     1.53 
## 12 Presumed    France                16.8     1.60 
## 13 Presumed    Italy                 11.1     4.28 
## 14 Presumed    Norway                15.4     1.11 
## 15 Presumed    Spain                 28.1     4.96 
## 16 Presumed    Sweden                13.1     1.75 
## 17 Presumed    Switzerland           14.2     1.71
p <- ggplot(data = organdata3,
    mapping = aes(
      y = reorder(country, donors_mean), 
      x = donors_mean,
      color = consent_law))
p + geom_point(size = 3) +
  labs(y = NULL, x = "平均捐赠率(单位: 百万分之一)") +
  theme(legend.position = "top")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ31-1.png)

平均捐赠率最高的三个国家都是不需告知预先假定同意的。

也可以将两种告知规定分成两个小图：

```
p <- ggplot(data = organdata3,
    mapping = aes(
      y = reorder(country, donors_mean), 
      x = donors_mean))
p + geom_point(size = 3) +
  facet_wrap(~ consent_law, ncol=1, scales = "free_y") + 
  labs(y = NULL, x = "平均捐赠率(单位: 百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ32-1.png)

因为纵轴是分类变量，程序中的`scales = "free_y"`使得纵轴仅对存在的类留出空间。 用了`ncol = 1`使得两种告知规定的小图上下排列， 便于比较横坐标值。

当每个类别仅有一个数值时， 一般推荐使用Cleveland点图， 而不是条形图或者折线图。 Cleveland点图总是将类别值绘制在y轴， 将要比较的数量值用x坐标表示， 并将各类按照数量值大小次序排列。

可以表示平均值的点图上增加一条线， 表示误差大小，所用函数为`geom_pointrange()`。 这个函数仅支持对y轴加误差线， 所以需要用交换坐标轴的办法将分类变量放在y轴。 比如， 画出近似95%置信区间范围：

```
p <- ggplot(data = organdata3,
    mapping = aes(
      x = reorder(country, donors_mean), 
      y = donors_mean))
p + geom_pointrange(
    mapping = aes(ymin = donors_mean - 1.96*donors_sd,
                  ymax = donors_mean + 1.96*donors_sd)) +
  coord_flip() +
  facet_wrap(~ consent_law, ncol=1, scales = "free_y") + 
  labs(y = NULL, x = "平均捐赠率(单位: 百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-organ33-1.png)

类似的函数还有`geom_linerange()`、`geom_crossbar()`、`geom_errorbar()`。

### 30.5.3 坐标系中的文字

类似于散点图， 可以将指定的文字绘制在指定的坐标位置， 使用`geom_text(mapping = aes(label = 字符型变量))`。

例如，gapminder数据集中各大洲的平均寿命与平均gdp的文字散点图：

```
gapminder2 <- gapminder %>%
  group_by(continent) %>%
  summarize(lifeExp = mean(lifeExp, na.rm=TRUE), 
            gdpPercap = mean(gdpPercap))
p <- ggplot(data=gapminder2,
    mapping = aes(
      x = gdpPercap, 
      y = lifeExp,
      label = continent))
p + geom_text()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-text-gap01-1.png)

可以同时绘制散点：

```
p + geom_text() +
  geom_point(size = 2, col="blue")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-text-gap01b-1.png)

文字默认是居中对齐， 加选项`hjust = 0`表示左对齐， `hjust = 1`表示右对齐。

ggrepel扩展包提供了增强的图形文本功能。 `geom_text_repel()`提供了与`geom_text()`类似的功能。

考虑socviz扩展包的`elections_historic`数据集， 这是美国历次总统选举情况数据。 部分数据显示：

```
elections_historic %>%
  select(2:7) %>% head(10)
## # A tibble: 10 x 6
##     year winner                 win_party ec_pct popular_pct popular_margin
##    <int> <chr>                  <chr>      <dbl>       <dbl>          <dbl>
##  1  1824 John Quincy Adams      D.-R.      0.322       0.309        -0.104 
##  2  1828 Andrew Jackson         Dem.       0.682       0.559         0.122 
##  3  1832 Andrew Jackson         Dem.       0.766       0.547         0.178 
##  4  1836 Martin Van Buren       Dem.       0.578       0.508         0.142 
##  5  1840 William Henry Harrison Whig       0.796       0.529         0.0605
##  6  1844 James Polk             Dem.       0.618       0.495         0.0145
##  7  1848 Zachary Taylor         Whig       0.562       0.473         0.0479
##  8  1852 Franklin Pierce        Dem.       0.858       0.508         0.0695
##  9  1856 James Buchanan         Dem.       0.588       0.453         0.122 
## 10  1860 Abraham Lincoln        Rep.       0.594       0.396         0.101
```

取`popular_pct`(popular投票支持率)为横坐标， 取`ec_pct`(election college投票支持率)为纵坐标， 将历次结果标在坐标系中：

```
p <- ggplot(data = elections_historic,
    mapping = aes(
      x = popular_pct,
      y = ec_pct,
      label = winner_label))
p + geom_text()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-text-elect02-1.png)

因为点比较多，文字也比较长，有很多重叠。 ggrepel包的`geom_text_repel()`则很好地处理了这个问题：

```
library(ggrepel)
## Warning: 程辑包'ggrepel'是用R版本3.5.3 来建造的
p + geom_text_repel()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-text-elect02b-1.png)

可以看出，其解决重叠问题的方式是用短线指向实际的坐标位置。 在Rmd文件中， 还是有少量的重叠， 可以通过在R代码段选项中增大`fig.width`和`fig.height`参数实现， 下面的代码段用了选项`fig.width=20, fig.height=16`：

```
p + geom_text_repel()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-text-elect02c-1.png)

可以用`scale_x_continuous()`和`scale_y_continuous()`将坐标轴的比例值转换成百分数， 用`geom_hline(yintercept)`添加横线， 用`geom_vline(xintercept)`添加竖线， 适当地用标注改善图形：

```
p + geom_hline(yintercept = 0.5, size = 1.4, col = "gray80") + 
  geom_vline(xintercept = 0.5, size = 1.4, col = "gray80") +
  geom_point() + 
  geom_text_repel() +
  scale_x_continuous(labels = scales::percent) + 
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Winner's share of Popular Vote",
    y = "Winner's share of Electoral College Votes",
    title = "Presidential Elections: Popular & Electoral College Margins",
    subtitle = "1824-2016",
    caption = "Data for 2016 are provisional."
  )
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-text-elect02d-1.png)

为了画斜线，可以用`geom_abline()`函数。

### 30.5.4 标出特殊点

在坐标系中标注文字的功能更经常用来标出图形中的特殊点。

考虑organdata中各国的平均捐赠率数据。 作平均捐赠率对平均gdp的散点图：

```
organdata4 <- organdata %>%
  group_by(country) %>%
  summarize(
    donors_mean = mean(donors, na.rm=TRUE),
    gdp_mean = mean(gdp, na.rm=TRUE)
  )
p <- ggplot(data = organdata4,
    mapping = aes(x = gdp_mean, y = donors_mean))
p + geom_point() +
  labs(x = "平均GDP", 
       y = "平均器官捐赠率(单位：百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-outlier-organ01-1.png)

如果需要标出其中的特殊点， 就要生成一个数据子集， 并在`geom_text()`中指定输入数据为此子集：

```
p + geom_point() +
  geom_text(data = subset(organdata4, gdp_mean > 27500 | donors_mean > 25),
            mapping = aes(label = country)) +
  labs(x = "平均GDP", 
       y = "平均器官捐赠率(单位：百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-outlier-organ01b-1.png)

上面标的文字有超出边界的问题， ggrepel包的`geom_text_repel()`可以改进：

```
library(ggrepel)
p + geom_point() +
  geom_text_repel(data = subset(organdata4, gdp_mean > 27500 | donors_mean > 25),
            mapping = aes(label = country)) +
  labs(x = "平均GDP", 
       y = "平均器官捐赠率(单位：百万分之一)")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-moregeo-outlier-organ01c-1.png)

## 30.6 刻度(scale)

在`ggplot()`的`mapping`参数中指定`x`维、`y`维、`color`维等， 实际上每一维度都有一个对应的默认刻度(scale)， 即将数据值映射到图形中的映射方法。 如果需要修改刻度对应的变换或者标度方法， 可以调用相应的`scale_xxx()`函数。

可以映射的维度包括`x`、`y`、`color`、`fill`、`shape`、`size`等。 其中`x`、`y`维度多用于表示连续变量， 但是也可以用于分类变量， 如Cleveland点图就是将`y`维度分配给一个分类变量。 `color`、`fill`可以用于连续变量， 用于有序变量， 也可以用于无序的分类变量。 `shape`只能用于无序的分类变量。

数值或者不同类别可以用平面上的不同位置表示， 一般使用直角坐标系， 有有一对相互垂直的x轴和y轴， 但也可以有其他选择， 比如y轴可以不与x轴垂直， 某个轴的刻度可以不是线性的而是经过对数变换的， 可以用极坐标系，等等。 普通的直角坐标系不需要用`scale_xxx()`函数。

直角坐标系中的位置有x坐标与y坐标， 可以分别代表两个变量， 这两个变量经常是不同单位的， 比如， 身高与体重。 这时， x轴与y轴的数值之间没有可比性， 两个轴的数值范围与轴的实际长度只要不过于极端就没有什么关系。 但是， 应该尽可能使用比较合适的高宽比。

如果两个轴的变量含义相同， 最好使用完全相同的坐标轴范围与坐标轴长度， 使得水平与垂直方向上的等长距离在对应的坐标轴上也代表相等的距离。 用`coord_fixed()`函数指定两个轴的单位为1:1长度的坐标系， 其中参数xlim和ylim可以用来指定坐标范围。 也可以用ratio参数指定一个其他的宽高比。 如

```
d <- data.frame(
  t <- seq(0, 2*pi, length.out=100)
)
d$x <- cos(d$t)
d$y <- sin(d$t)
p <- ggplot(data = d, mapping = aes(
  x = x, y = y))
p + geom_path() +
  coord_fixed()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-fixed01-1.png)

上面的程序中， `geom_path()`按照输入数据集的次序将坐标点连接在一起。 如果改用`geom_line()`， 会将数据先按照`x`坐标值排序然后再顺序相连。 可以看出， 结果是一个正圆； 如果不使用`coord_fixed()`，结果不一定是正圆。

在`coord_fixed()`函数中， 还可以用`expand = FALSE`要求坐标轴范围严格等于数据范围或xlim和ylim的规定， 否则会比数据范围略宽一些。

`scale_x_log10()`和`scale_y_log10()`可以将x轴或者y轴用对数刻度， 这实际上是将数据做常用对数变换， 但是相应的坐标轴刻度的数值还标成变换之前的原始值。 对数轴方向相同的距离代表相差相同的倍数。 经济、金融数据常常需要用对数刻度。

对数轴最好用来代表比例， 尤其是使用条形图时， 应该从1开始而不是从0开始。

下图是我国2000-2015年的居民消费水平（元）, 可以看出， 增长是指数型的：

```
d <- data.frame(
  x = 2000:2015,
  y = c(3721L, 3987L, 4301L, 4606L, 5138L, 5771L, 6416L, 7572L, 8707L, 
9514L, 10919L, 13134L, 14699L, 16190L, 17778L, 19308L))
p <- ggplot(data=d, mapping = aes(
  x = x, y = y))
p + geom_point(size = 2)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-log01-1.png)

将y轴用对数刻度，则散点可以呈现为线性：

```
p + geom_point(size = 2) +
  scale_y_log10()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-log01b-1.png)

用`geom_smooth()`添加线性拟合线：

```
p + geom_point(size = 2) +
  geom_smooth(method="lm") + 
  scale_y_log10()
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-log01c-1.png)

注意`geom_smooth(method="lm")`在计算拟合时会自动采用`log10(y)`的值。

`scale_x_sqrt()`和`scale_y_sqrt()`与对数轴类似， 做的是平方根变换。 对于面积值， 这种变换有一定意义。

用`coord_polar()`指定极坐标系， 用`theta="x"`或者`theta="y"`指定那一维映射到极角。 如：

```
d <- data.frame(
  x <- (0:11)/12*2*pi, 
  y <- 11:22
)
p <- ggplot(data=d, mapping = aes(
  x = x, y = y))
p + geom_point(size=2) +
  scale_x_continuous(limits=c(0, 2*pi)) +
  scale_y_continuous(limits=c(0, 22)) +
  coord_polar(theta="x", start=-pi/2, direction=-1)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-polar01-1.png)

上图中y轴为极径的刻度， 圆周上的数字表示极角刻度。 程序中`start`指定极角为0的射线与12点方向的夹角弧度， `direction=1`表示顺时针计算角度， `direction=-1`表示逆时针。 `scale_continuous_x()`和`scale_continuous_y()`指定了两个维度的坐标范围。

用`scale_xxx()`函数指定非默认的刻度， 一般模式为`scale_映射维度_类型()`， “类型”包括`continuous`、`discrete`、`log10`等。 可以用来人为指定坐标轴的刻度值， 修改`color`或者`fill`维度所利用的颜色表，等等， 用其中的参数指定这些内容。 注意坐标轴的标签（标题）用`labs()`函数指定， 而不是用`scale_xxx()`函数指定。

例如， 在organdata中， 作`donors`对`roads`(每十万人的道路交通事故死亡率)的散点图， 并按`world`(不同福利类型)对散点染色， x、y、color这三个维度都用了默认的刻度:

```
p <- ggplot(data = organdata,
    mapping = aes(
      x = roads,
      y = donors,
      color = world ))
p + geom_point()
## Warning: Removed 34 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-organ01-1.png)

这里有三个维度：连续型的`x`、`y`维度与无序分类值的`color`维度。 `color`维度既可以取连续型， 也可以取有序或者无序的分类型。 `x`、`y`维度有自动的坐标轴， `color`维度有图例在图形右侧。 如果没有特殊要求，不必调用`scale_xxx()`函数。

下面将`y`轴的刻度值进行人为的规定， 将`color`维的标签人为指定：

```
p + geom_point() +
  scale_y_continuous(
    breaks = c(5, 15, 25),
    labels = c("百万分之五", "百万分之十五", "百万分二十五")  ) +
  scale_color_discrete(labels = c(
    "社团主义", "自由", "社会民主", "无分类"  ))
## Warning: Removed 34 rows containing missing values (geom_point).
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-scale-organ01b-1.png)

在`scale_维度_contiuous()`函数中， 可以用`breaks`指定坐标刻度标线的坐标数值表， 用`minor_breaks`指定细刻度的坐标数值表， 用`labels`指定在坐标刻度标线处标出的坐标值标签字符串表， 用`limits`指定坐标系的范围（两个数的向量）， 用`expand`指定在将坐标轴范围比数据的范围在两侧分别扩充多少， 取`c(0,0)`要求不扩充，默认会左右各扩充5%。

ggplot2的散点图默认使用灰色背景并带有白色的网格线。 `theme()`函数的`panel.background`可以指定背景色， `panel.grid`、`panel.grid.xxx`可以指定网格线做法。

## 30.7 如何使用颜色

可以用颜色来表示分组， 比如， 不同组的散点用不同颜色， 多条曲线用不同颜色； 可以用颜色表示数值， 用颜色深浅表示绝对值大小； 可以用颜色来突出某些要强调的图形元素。

将无序的分类值映射到颜色， 应该使用完全不相像、很容易区分的颜色， 各个颜色应该没有明显次序、没有哪一个与其他明显不同。 可以用RColorBrewer扩展包提供的调色盘， 在ggplot2中用`scale_color_brewer(palette)`和`scale_fill_brewer(palette)`选择。 图[30.1](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#fig:ggplot2-refine-color-brewer01)为无序分类适用的调色板。 称这样的调色板为名义型(qualitative)。

色盲的人会分辨不出某些颜色， 比如红绿色盲的人无法分辨红色和绿色， 蓝绿色盲的人无法分辨蓝色和绿色。 男性中有8%的人有色盲， 所以绘图时应该考虑到这个问题。 (Wilke [2019](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#ref-Wilke2019:visualization))提供了8种对色盲也可区分的颜色：

```
dcolorqua <- tribble(
  ~name, ~code,
         "black", "#000000",
        "orange", "#E69F00",
      "sky blue", "#56B4E9",
  "bluish green", "#009E73",
        "yellow", "#F0E442",
          "blue", "#0072B2",
     "vermilion", "#D55E00",
"reddish purple", "#CC79A7",
         "black", "#000000"
)
knitr::kable(dcolorqua)
```

| name           | code    |
| -------------- | ------- |
| black          | #000000 |
| orange         | #E69F00 |
| sky blue       | #56B4E9 |
| bluish green   | #009E73 |
| yellow         | #F0E442 |
| blue           | #0072B2 |
| vermilion      | #D55E00 |
| reddish purple | #CC79A7 |
| black          | #000000 |

将连续的或者有序的值映射到颜色， 应该使用渐变色， 如果都是正值， 可以使用从浅到深或者从深到浅的颜色， 并且应该使用同一个颜色，只是深浅程度不同。 图[30.2](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#fig:ggplot2-refine-color-brewer02)为单向的有序分类适用的调色板。 称这样的调色板为有序型(sequential)。

如果颜色代表有正有负的数值（比如反对、中立、支持）， 则应该以浅色为接近零值， 正值与负值分别用两个不同的颜色。 另外， 如果要代表的数值有明显的中间值， 为了强调较低的值与较高的值的对比， 也可以使用这样的颜色刻度。 图[30.3](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot2.html#fig:ggplot2-refine-color-brewer03)为有正有负的有序分类适用的调色板。 称这样的调色板为相异型(diverging)。 相异型的渐变色有可能对色盲的人不可辨识， `Colorbrewer::PiYG`刻度对色盲人群也可以分辨。

![无序分类适用的调色板](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/ggplot2-brewerqual-1.png)

![有序单向分类适用的调色板](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/ggplot2-brewerseq-1.png)

![有序正负分类适用的调色板](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/ggplot2-brewerdiv-1.png)

例如， 作gapminder数据集中各国在2007年期望寿命对人均GDP的散点图， 不同大洲使用不同的颜色， 指定ColorBrewer的Set1调色板：

```
p <- ggplot(data = subset(gapminder, year == 2007),
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
p + geom_point(mapping = aes(color = continent)) +
  scale_color_brewer(palette = "Set1")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-refine-color-gap01-1.png)

使用颜色进行强调时， 可以将要强调的点、线、条形用鲜明的颜色， 而非强调的用褪色的颜色。 最简单的做法是仅对要强调的内容指定一个鲜明的颜色。

## 30.8 标题、标注、指南、拼接

除了`ggplot()`指定数据与映射， `geom_xxx()`作图， 还可以用许多辅助函数增强图形。

- `labs()`可以设置适当的标题和标签。
- `annotate()`函数可以直接在坐标系内进行文字、符号、线段、箭头、长方形的绘制。
- `guides()`函数可以控制图例的取舍以及做法。
- `theme()`函数可以控制一些整体的选项如背景色、字体类型、图例的摆放位置等。

在需要修改图形时， 如果修改会影响到相应的`geom_xxx()`的主要结果， 一般需要在`ggplot()`或者该`geom_xxx()`函数中将适当的变量映射为某一维度， 或者用`scale_xxx()`函数进行变换。 如果仅仅是一些显示效果的修改， 则一般作为`geom_xxx()`的选项， 或者调用`labs()`、`theme()`、`guides()`完成。

### 30.8.1 标题

函数`labs()`可以用来指定图形上方的标题(title)、副标题(subtitle)、右下方的标注(caption)、左上方的标签以及坐标轴标题和其它维的名称。 例如：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
p + geom_point(alpha = 0.4) + 
  labs(
    title = "各国各年度人均GDP与期望寿命的关系",
    subtitle = "1952-2007",
    tag = "散点图",
    caption = "数据来源：gapminder",
    x = "人均GDP(单位：美元)",
    y = "期望寿命"
  )
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-labs01-1.png)

在`labs()`中用`x=`、`y=`、`color=`之类的选项指定坐标轴的标签或者其它维的名称， 如果该维用了`scale_xxx()`函数， 则应该则`scale_xxx()`函数中用`name=`指定轴标签（名字）。 数值型的维度除非是显然的应在标签中包含单位。 `labs()`中或者`scale_xxx(name=)`中如果指定文字为`NULL`则取消该标题或标签， 但是取消坐标轴标签必须是取消标签后含义也显而易见， 没有任何疑问的情况。

`labs()`只是提供了这些标题功能， 一般并不会同时使用这些功能。 在出版图书内， 图形下方一般伴随有图形说明， 这时一般就不再使用标题、副标题、标签、标注， 而只需写在图的伴随说明文字中， 当然，坐标轴标签一般还是需要的。

有一点要注意， 默认的标题、坐标轴标签、图例标签中的文字往往偏小， 如果单独放大这些图形来看并没有问题， 但是作为插图放在书中或者网页中就偏小了。 可以用`theme()`函数调整字体大小。

### 30.8.2 标注功能

通过`annotate(geom = "text")`调用`geom_text()`的功能， 可以在一个散点图中标注多行文字， 多行之间用`"\n"`分开：

```
p <- ggplot(data = gapminder,
  mapping = aes(
    x = gdpPercap,
    y = lifeExp))
p + geom_point() +
  geom_smooth(method="gam") +
  scale_x_log10() +
  annotate(
    geom = "text",
    x = 1E2, y = 85, hjust = 0,
    label="期望寿命与人均GDP的对数值呈线性关系，\n建议建立相应的线性回归模型。")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-anno-gap01-1.png)

将上面图形中最右侧偏低的点用长方形填充标出：

```
p + geom_point() +
  geom_smooth(method="gam") +
  scale_x_log10() +
  annotate(geom = "rect", 
           xmin = 5.5E4, xmax = 1.2E5,
           ymin = 54, ymax = 71,
           fill = "red", alpha = 0.2) + 
  annotate(geom = "line",
           x = c(5.9E4, 3.16E4),
           y = c(53,  40)) +
  annotate(geom = "text",
           x = 3.16E4, y = 38,
           label = "这些国家的期望寿命低于预期")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-anno-gap01b-1.png)

这样标注的缺点是坐标都需要读图并试错摆放。

上述被标注的国家是：

```
gapminder %>%
  filter(gdpPercap > 5.5E4 & gdpPercap < 1.2E5,
         lifeExp > 54 & lifeExp < 71) %>%
  select(country, gdpPercap, lifeExp)
## # A tibble: 6 x 3
##   country gdpPercap lifeExp
##   <fct>       <dbl>   <dbl>
## 1 Kuwait    108382.    55.6
## 2 Kuwait    113523.    58.0
## 3 Kuwait     95458.    60.5
## 4 Kuwait     80895.    64.6
## 5 Kuwait    109348.    67.7
## 6 Kuwait     59265.    69.3
```

### 30.8.3 指南(guides)

对于颜色、填充色等维度， 会自动生成图例。 用`guides(color = FALSE)`这样的方法可以取消指定维度的图例。

`theme()`可以调整一些整体的设置， 如背景色、字体、图例的摆放位置。 用`theme()`的`legend.position`改变图例的位置， 如`theme(legend.position = "top")`可以将图例放置在上方， 默认是放置在右侧的。 可取值有`"none"`、`"left"`、`"right"`、`"bottom"`、`"top"`，如：

```
p <- ggplot(data = iris, mapping = aes(
  x = Petal.Length, y = Petal.Width, color = Species))
p + geom_point(alpha = 0.4) +
  theme(legend.position = "top")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-guide-iris01-1.png)

图例位置`legend.position`还可以指定在作图区域内部用两个百分比数字给定， 同时可以用`legend.just`指定位置对准图例框的哪一个角，也是用两个百分比数字， 比如放在左上角内部：

```
p + geom_point(alpha = 0.4) +
  theme(
    legend.position = c(0.02, 0.98),
    legend.justification = c(0,1)  )
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-guide-iris01b-1.png)

某一维的图例做法可以在相应的`scale_xxx()`函数中用`guide=`指定， 或者在`guides()`中用`维名称=指南`方法指定， 如`guides(fill = "guides")`或者`guides(fill = "colorbar")`。 指定的指南还可以是`guide_legend()`或者`guide_colorbar()`的结果， 在这两个函数中可以用多个选项指定指南或颜色条的具体做法。

### 30.8.4 拼接图形

`facet_wrap()`和`facet_grid()`可以按照某一个或两个分类变量的值将输入数据集分为若干个子集， 将每个子集分别在一个小图上绘图。 有时还需要将几幅不同图形拼在一起， 这些图形可以是同一数据的不同类型图形， 也可以是完全无关的图形。

在拼接图形时， 各个小图应该具有类似的风格， 即背景、配色、字体等应该尽可能一致， 上下和左右的坐标轴应尽可能对齐， 小图的标签应该尽可能不显眼。

cowplot包提供了拼接图形的办法， 使用时先将每个小图分别赋值给一个R变量， 然后用`plot_grid()`函数摆放在一幅图中。

例如， 19个学生的性别、年龄、身高、体重数据：

```
library(cowplot)
dclass <- read_csv(
  "class.csv", 
  col_types=cols(
  .default = col_double(),
  name=col_character(),
  sex=col_factor(levels=c("M", "F"))
))
p1 <- ggplot(data = dclass, mapping = aes(x = sex, fill = sex)) +
  geom_bar() +
  scale_fill_manual(
    guide = FALSE,
    values = c("F" = "chocolate1", 
               "M" = "skyblue1")  ) 
p2 <- ggplot(data = dclass, mapping = aes(
  x = height, y = weight, color = sex)) +
  geom_jitter(size = 3) +
  scale_color_manual(
    values = c("F" = "chocolate1", 
               "M" = "skyblue1")  )
  
plot_grid(
  p1, p2, labels = "auto", 
  rel_widths = c(0.3, 0.6), 
  align = "h")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-auxfuncs-compfig-class01-1.png)

`plot_grid()`中用`rel_widths`指定了左右图的相对比例， 默认是均分的。 当图形上下排列时，可以用`rel_height`指定上下排的比例。 程序中用了`align = "h"`使得左右图上下对齐， `align`默认取`"none"`， 也可以取`"h"`、`"v"`或`"hv"`。 可以用`ncol`指定图的列数， 用`nrow`指定图的行数。

还可以通过嵌套调用`plot_grid()`方式实现非网格的排列。

## 30.9 图形定制调整

ggplot2的默认设置一般能够满足我们的要求， 只有在有特殊的图形类型需求或者制作出版用的图形时， 才需要对图形进行定制调整。 图形调整可以包括：

- 配色、位置摆放等审美方面的调整；
- 面向目标出版物或者目标读者的调整；
- 增加有意义的标注；
- 调整整体的观感。

### 30.9.1 图形逐步调整例子

socviz扩展包的asasec数据集是美国社会学学会(ASA)的各分会2005年到2015年的一些数据， 其中的财务数据(Beginning, Revenues, Expenses, Ending)虽然各年都有值， 但实际是用2015年的值填进去的。

作2014年收入对会员数的散点图与拟合曲线， 每个散点是一个分会：

```
p <- ggplot(data = subset(asasec, Year == 2014),
    mapping = aes(
      x = Members, 
      y = Revenues,
      label = Sname))
p + geom_point() +
  geom_smooth()
## `geom_smooth()` using method = 'loess' and formula 'y ~ x'
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-refine-asasec01-1.png)

程序中的映射`label = Sname`暂时不起作用， 在`geom_text()`中才需要这一维度。

下面按照有无期刊染色， 将平滑方法改为线性回归：

```
p + geom_point(mapping = aes(color = Journal)) +
  geom_smooth(method = "lm")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-refine-asasec01b-1.png)

注意`color = Journal`的映射仅对`geom_point()`有效， 如果写在`ggplot()`中， 就对`geom_smooth()`也有效了。

下面标出异常值：

```
p + geom_point(mapping = aes(color = Journal)) +
  geom_smooth(method = "lm") +
  geom_text_repel(data = subset(asasec, Year == 2014 & Revenues > 7000))
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-refine-asasec01c-1.png)

下面用`labs()`调整标题、用`scale_y_continuous()`调整y轴刻度标法、用`theme()`调整图例位置：

```
p + geom_point(mapping = aes(color = Journal)) +
  geom_smooth(method = "lm") +
  geom_text_repel(data = subset(asasec, Year == 2014 & Revenues > 7000)) +
  labs(
    title = "ASA分会",
    subtitle = "2014年",
    x = "分会会员数",
    y = "收益",
    color = "分会有无期刊",
    caption = "数据来源：ASA年报"  ) +
  scale_y_continuous(labels = scales::dollar) +
  theme(legend.position = "bottom")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/ggplot_files/figure-html/ggplot2-refine-asasec01d-1.png)

## 30.10 主题

ggplot2包作图可以实现内容与设计的分离， 这里内容就是指数据、映射、统计、图形类型等方面， 而设计就是指背景色、颜色表、字体、坐标轴做法、图例位置等的安排。 将作图任务分解为内容与设计两个方面， 可以让数据科学家不必关心设计有关的元素， 而设计可以让专门的艺术设计人才来处理。 这种工作分配已经在图书出版、网站、游戏开发等行业发挥了重要作用。

`theme()`函数用来指定设计元素，称为主题(theme)， 而且可以单独开发R扩展包来提供适当的主题。

`theme(legend.position)`可以用来选择图例位置。 `theme_set()`可以改变后续ggplot2作图的主题（配色、字体等）。 如`theme_set(theme_bw())`, `theme_set(theme_dark())`等。 对单次绘图， 可以直接用加号连接`theme_gray()`等这些主题函数。 主题包括`theme_gray()`（默认主题）、 `theme_minimal()`、`theme_classic()`等。 ggthemes扩展包提供了更多的主题选择。

`theme()`函数还可以直接指定颜色、字体、大小等设置。

## 30.11 参考文献

- Cleveland, W. S. (1993). The elements of graphing data. Hobart Press.
- Cleveland, W. S. (1994). Visualizing data. Hobart Press.
- Cleveland, W. S., & McGill, R. (1984). Graphical perception: Theory, experimentation, and application to the development of graphical methods. Journal of the American Statistical Association, 79, 531–534.
- Cleveland, W. S., & McGill, R. (1987). Graphical perception: The visual decoding of quantitative information on graphical displays of data. Journal of the Royal Statistical Society Series A, 150, 192–229.
- Edward R. Tufte((1983) The Visual Display of Quantitative Information
- Tufte, E. R. (1983). The visual display of quantitative information. Cheshire, CT: Graphics Press.
- Tufte, E. R. (1990). Envisioning information. Cheshire, CT: Graphics Press.
- Tufte, E. R. (1997). Visual explanations: Images and quantities, evidence and narrative. Cheshire, CT: Graphics Press.
- Wickham, H. (2016). Ggplot2: Elegant graphics for data analysis. New York: Springer.
- Wickham, H., & Chang, W. (2018). Ggplot2: Create elegant data visualisations using the grammar of graphics.
- Wilkinson, L. (2005). The grammar of graphics (Second). New York: Springer.

### References

Wilke, Claus O. 2019. *Fundamentals of Data Visualization: A Primer on Making Informative and Compelling Figures*. O’Reilly Media. https://serialmentor.com/dataviz/.





