---
layout: post
title: "R制作研究报告"
date: 2019-11-29
tag: sas
---







# 20 用R制作研究报告

一个统计或数据分析的科研项目， 都会产生一个或多个研究报告。 因为使用统计与数据分析不可避免地有很多计算涉及在内， 这里假设使用R软件做了计算。 科研是一个不断改进的过程， 所以每一次重新做了计算， 研究报告中的汇总表格、图形都要更新。 这样的任务比较繁琐， 也容易出错。

“文学式编程”(literate programming, (Knuth [1984](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/knitr.html#ref-Knuth1984:literate)))是这样一种思想， 把撰写报告与计算程序有机地结合在一起， 用一个源文件文件既包含报告内容， 又包含计算程序。 每次产生研究报告时， 先运行源文件中的计算程序得到计算结果， 这些结果包括文字性内容与图形， 然后利用适当软件自动地把这些原始文字、计算结果组合成最终的报告。 利用这样的思想， 可以自动生成重复的例行报告， 还可以作为“可重复科学研究”的载体。

上述的源文件一般是文本文件， 格式可以是Markdown格式， 也可以是LaTeX格式等许多格式。 R的knitr软件包就是用来支持这样的编程思想的一个扩展包。

Markdown是一种很简单的文本文件格式， 通常保存为.md扩展名， 利用R程序进行扩展的版本保存为.Rmd扩展名。 Markdown文件里面有一些简单的格式标注方法， 比如两个星号之间的文字会转化为斜体， 缩进四个空格或一个制表符的内容会看成代码。 Markdown仅适用于比较简单的文章、源程序说明等， 不太适用于复杂的含有大量数学公式、图表的文章， 从markdown格式比较适合转换为html(网页)格式， 也可以转换为MS Word的docx格式， 通过LaTeX编译器可以转换为PDF格式， 也可以将docx转存为PDF格式， 或者用输出到PDF文件的打印机将网页格式转换为PDF格式。

LaTeX是一个文档排版系统， 功能强大，结果美观， 设计合理。 缺点是需要学习类似于HTML的另一种语言。 LaTeX源文件主要是编译为PDF。

R扩展包knitr包支持在Markdown格式、LaTeX格式等类型的文件中插入R代码， 经过转换， 文中的R代码可以变成代码的结果文字、表格、图形， 与原有报告文字有机地结合在一起。

插入了R代码的markdowng格式的文件一般以`.Rmd`为扩展名， R的rmarkdown扩展包和knitr包一起为Rmd格式提供了支持。

R的bookdown包进一步增强了R Markdown格式的功能， 支持生成PDF、多文件互相链接的HTML、Word等输出， 其中的表格、图形可以变成浮动表， 公式、定理可以自动编号并支持文献、公式、定理、图表、章节的引用和链接， 所以比较适用于编写一本书或论文、研究报告。

knitr包也支持在LaTeX源文件中插入R代码， 通过编译使得R代码运行结果、图形自动插入生成的研究报告中。 原来有一个Sweave扩展包是支持在LaTeX中插入R代码的， 现在knitr的功能已经涵盖并增强了此包功能。

下面几章分别介绍markdown格式、R markdown格式、bookdown扩展包、简易网站制作和幻灯片制作。 参考：

- (Xie, Allaire, and Grolemund [2019](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/knitr.html#ref-Xie2019:rmarkdown))
- (Xie [2017](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/knitr.html#ref-Xie2017:bookdown))

利用R Markdown格式可以执行如下的任务：

- 将单一的R Markdown文件编译为不同的格式，如：
  - HTML;
  - PDF;
  - MS Word。
- 在RStudio软件内制作笔记本文档，可以在其中包含说明文字与R代码， 可以在笔记本文档内交互地运行R代码并能将结果交互地显示在笔记本内。
- 生成演示幻灯片，可以是基于HTML5的，也可以是基于LaTeX beamer扩展包的， 或者MS Powerpoint。
- 编写多章节组成的书籍。
- 编写期刊论文。
- 制作网站或者博客。
- 制作商业智能仪表盘(dashboards)，即数据可视化展示。

### References

Knuth, Donald E. 1984. “Literate Programming.” *The Computer Journal* 27 (2): 97–111.

Xie, Yihui. 2017. *Bookdown: Authoring Books and Technical Documents with R Markdown*.

Xie, Yihui, J. J. Allaire, and Garrett Grolemund. 2019. *R Markdown: The Definitive Guide*. CRC Press. https://bookdown.org/yihui/rmarkdown/.





# 21 Markdown格式

## 21.1 介绍

Markdown是一种很简单的文本文件格式， 通常保存为.md扩展名。 Mardown中文内容应该使用UTF-8编码。 Markdown文件里面有一些简单的格式标注方法， 比如两个星号之间的文字会转化为斜体， 缩进四个空格或一个制表符的内容会看成代码。

Markdown适用于比较简单的文章、源程序说明等， 不太适用于复杂的含有大量数学公式、图表的文章， 从markdown格式比较适合转换为html(网页)格式， 也可以转换为MS Word的docx格式， 通过docx格式可以转存为PDF格式。 R扩展包knitr、rmarkdown和bookdown与pandoc软件一起大大扩展了markdown格式的适用范围。

如果需要作为一本书发布在网站上或者出版， 可考虑使用R的bookdown扩展包。 如果需要对出版格式进行精确控制， 可考虑用LaTeX格式， LaTeX格式很复杂， 学习比较困难， 但是表达能力强。

## 21.2 Markdown格式文件的应用

Markdown格式用在一些微博、论坛中作为缺省格式， 用户在网络浏览器软件的输入框中按照markdown格式输入， 网站自动将其转换为html富文本内容显示出来。

因为markdown格式就是纯文本， 而且其格式十分简单， 所以可以仅仅用普通文本编辑器编写markdown格式的文件， 不需要转换为其它格式。

有一些独立运行的编辑软件， 在其中输入了markdown格式文件后， 可以并列地显示转化为html富文本后的结果， 很多还支持自动备份到云服务中。 但是，这些独立运行的编辑器大都有商业因素。 比如，国内的印象笔记软件是提供了云存储的笔记软件， 在其PC端就支持创建markdown格式的笔记， 可以在输入时即时显示html效果。

RStudio软件不是专用的Markdown编辑器， 它是一个R程序的集成编辑、运行环境， 对个人用户免费， 在R Studio中可以编辑Markdown文件和含有R代码的Markdown文件， 可以一键将其转化成HTML、MS Word docx文件， 在单独安装的LaTeX编译软件支持下还可以直接编译成PDF。 RStudio支持下的增强的Mardown格式， 称为RMarkdown格式， 以`.Rmd`为扩展名， 支持大多数的LaTeX公式， 在bookdown扩展包支持下还支持公式、定理、图表等自动编号和引用、链接。

## 21.3 markdown格式说明

这部分内容参考了markdown手册和Rstudio的文档， 以及(Xie, Allaire, and Grolemund [2019](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/markdown.html#ref-Xie2019:rmarkdown))。

### 21.3.1 概述

Markdown格式是John Gruber于2004年创造的， Markdown 的目标是实现“易读易写”。 Markdown定义了一种简单好用的文本文件格式， 作为单独的文本文件， 此格式没有什么多余的标签， 又可以转化为很多其它的格式。

Markdown 的语法全由一些符号所组成， 这些符号经过精挑细选，其作用一目了然。 比如：在文字两旁加上星号，看起来就像*强调*。 Markdown 的列表看起来就像我们平常在邮件中写一个列表的方法。 Markdown 的区块引用看起来就真的像是引用一段文字， 就像你曾在电子邮件中见过的那样。

需要时， 可以直接在markdown中写HTML标记内容。 markdown能实现的功能是HTML的一部分， 但是比HTML内容更干净， 没有掺杂过多的与要表达的意思无关的标签。 Markdown的理念是，能让文档更容易读、写和随意改。

### 21.3.2 段落

一个段落由一行或连续的多行组成。 段落之间以空行分隔。 同一段落内的不同行在转换成HTML或docx等格式后会重新排列， 原来的段内换行被当成了空格，这样的规定与LaTeX类似。 普通段落不该用空格或制表符来缩进， 不应在行尾留有空格。

为了在段内换行并且转化后仍保持段内换行， 输入时在前面行的末尾输入两个或两个以上空格。例如：

```
白日依山尽，黄河入海流。    
欲穷千里目，更上一层楼。
```

显示结果为：

白日依山尽，黄河入海流。
欲穷千里目，更上一层楼。

这样做的缺点是末尾的空格时不可见的。 可以使用HTML的` `标签在段内换行，如：

```
白日依山尽，黄河入海流。<br>
欲穷千里目，更上一层楼。
```

结果为

白日依山尽，黄河入海流。
欲穷千里目，更上一层楼。

### 21.3.3 段内文字格式

在一段内，用星号或下划线包围的内容如`*强调*`是*强调*格式。 用双星号或双下划线包围的内容如`**加重**`是**加重**格式。 星号、下划线与要强调或加重的内容之间不要空开， 否则会当作普通星号或下划线解释， 在行首还会当作列表。 为了插入普通的星号或下划线，可以使用反斜杠保护， 或者写成段内代码格式。

可以用一对`~`作为界定符给出下标， 如`HO~2~`会变成HO2。 可以用一对`^`作为界定符给出上标， 如`Cu^2+^`会变成Cu2+。 但是，数学公式一般还是应该使用LaTeX数学公式形式（见[22.8](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#markdown-formula)）。

在普通段落内一部分内容希望显示成代码， 对其中的特殊字符不进行解释， 只要包在两个反向单撇号内。 如``if(_x_ > 0) y=1;``会变成`if(_x_ > 0) y=1;`。 如果内容本身就包含反向单撇号， 可以在两边使用更多个数的反向单撇号， 如``` `x` ```会变成``x``。

在Markdown文件中， 为了使得某些有特殊意义的字符不作特殊解释， 可以在该字符前面加上反斜杠`\`， 取消其特殊含义。

在Rmarkdown文件中， 为了原样显示反向单撇号， 可以在两边用双写的反向单撇号界定字符串。

### 21.3.4 标题和分隔线

以一个井号`#`开始的行是一级标题， 以两个井号`#`开始的行是二级标题， …………， 以六个井号`#`开始的行是六级标题。 标题行前面应该空一行， 否则可能把某些偶然出现在行首的`#`号误认为标题行的标志。

对一级标题， 也可以用标题内容下面输入一行等于号`=`表示上一行内容是一级标题。 对二级标题， 可以用标题内容下面输入一行减号`-`表示上一行内容是二级标题。 等于号和减号的个数不限。

用三个或三个以上连续的星号组成的行， 可以转换成分隔线。下面是一个分隔线：

------

### 21.3.5 引用段落

可以用类似Email的回复包含原始邮件内容的办法输入引用段落， 即，在段落的每行前面加一个大于号。 比如下面的诗：

```
> 白日依山尽，黄河入海流。
> 欲穷千里目，更上一层楼。
```

转换成

> 白日依山尽，黄河入海流。 欲穷千里目，更上一层楼。

注意引用也是段落模式，内容中的换行不起作用，空行导致分段。

引用段落也可以仅在段落第一行写大于号， 其它行顶格写，例如下面的两段引用：

```
> 远上寒山石径斜，
白云生处有人家。
>
> 停车坐爱枫林晚，
霜叶红于二月花。
```

转换成

> 远上寒山石径斜， 白云生处有人家。
>
> 停车坐爱枫林晚， 霜叶红于二月花。

引用也可以嵌套，如：

```
> 张三说：李四这样说过
>
>> 不想当将军的木匠不是好厨子。
>
```

转换成

> 张三说：李四这样说过
>
> > 不想当将军的木匠不是好厨子。

注意嵌套内容前后都有空的引用行，否则不能实现嵌套引用。

引用内也可以嵌套其它的Markdown格式如标题、列表等。 引用前后应该有空行把引用内容与其他内容分隔开。

### 21.3.6 列表

列表分为不编号的列表和编号的列表。 不编号的列表转化后通常显示圆点开头的列表项。

在Markdown中， 用星号表示一个不编号的列表项。 星号也可以替换成加号或减号， 后面必须有一个或多个空格。 每个列表项可以输入多行， 各行的内容最好左对齐， 左对齐在使用文本格式时较易阅读， 但不是必须的。 两个列表项之间不要空行。 例如：

```
* 白日依山尽，
  黄河入海流。
* 欲穷千里目，
  更上一层楼。
```

转换为

- 白日依山尽， 黄河入海流。
- 欲穷千里目， 更上一层楼。

段落顶头的数字加句点和空格表示编号列表， 两个列表项之间尽量不要空行。 例如：

```
1. 第一种解决方法，
   收买敌人的高官。
2. 第二种解决方法，
   尽可能拖延。
```

转换为

1. 第一种解决方法， 收买敌人的高官。
2. 第二种解决方法， 尽可能拖延。

标准的markdown编号列表不能自己定义数字的显示格式， 不允许开始值不等于1。 pandoc支持更自由的列表， 允许输入时有括号或右括号，允许使用字母和罗马数字，但是括号会被去掉。如

```
(1) 顶层一；
    a) 内层二；
    b) 内层三；
(2) 顶层二。
```

转换为

1. 顶层一；
   1. 内层二；
   2. 内层三；
2. 顶层二。

为了避免错误地产生非本意的编号列表， 在行首写数字加句点和空格时，可以在句点前加反斜杠， 或者在句点前加空格。例如，下面是一个年号：

```
2016\. 
```

如上输入将不会错误地解释为有序列表。

如果列表项目中有多个段落， 这时两个列表项之间应该以空行分隔， 每个项目除了第一行外，输入的每行内容都应该缩进4个空格或者一个制表符。 例如：

```
*   R语言第一个版本开发于1976-1980，基于Fortran；
    于1980年移植到Unix, 并对外发布源代码。
    1984年出版的“棕皮书”
    总结了1984年为止的版本, 并开始发布授权的源代码。
    这个版本叫做旧S。与我们现在用的S语言有较大差别。

    1989--1988对S进行了较大更新，
    变成了我们现在使用的S语言，称为第二版。
    1988年出版的“蓝皮书”做了总结。

*   1992年出版的“白皮书”描述了在S语言中实现的统计建模功能，
    增强了面向对象的特性。软件称为第三版，这是我们现在用的多数版本。

    1998年出版的“绿皮书”描述了第四版S语言，主要是编程功能的深层次改进。
    现行的S系统并没有都采用第四版，S-PLUS的第5版才采用了S语言第四版。
```

转换为

- R语言第一个版本开发于1976-1980，基于Fortran； 于1980年移植到Unix, 并对外发布源代码。 1984年出版的“棕皮书” 总结了1984年为止的版本, 并开始发布授权的源代码。 这个版本叫做旧S。与我们现在用的S语言有较大差别。

  1989–1988对S进行了较大更新， 变成了我们现在使用的S语言，称为第二版。 1988年出版的“蓝皮书”做了总结。

- 1992年出版的“白皮书”描述了在S语言中实现的统计建模功能， 增强了面向对象的特性。软件称为第三版，这是我们现在用的多数版本。

  1998年出版的“绿皮书”描述了第四版S语言，主要是编程功能的深层次改进。 现行的S系统并没有都采用第四版，S-PLUS的第5版才采用了S语言第四版。

列表项目内如果有引用段落， 需要都缩进4个空格。 如果有程序代码， 需要缩进4个空格后用三个反单撇号表示开始与结束。

列表可以嵌套， 嵌套的列表需要缩进4个空格， 中间不需要空行。 例如：

```
1.  第一类工作包括：
    + 技术服务；
    + 咨询服务。
2.  其它工作略。
```

转换为

1. 第一类工作包括：
   - 技术服务；
   - 咨询服务。
2. 其它工作略。

如果需要把每个列表项当作段落排版，可以在每个列表项后空行。

### 21.3.7 源程序

为了让源程序能够自动显示成源程序的样式， 而不至于自动分行、特殊字符解释， 用空行把源程序与其它内容隔开， 并把源程序行都缩进4个空格（或以上）或者一个制表符。 源程序格式持续到不缩进4个空格的地方为止。

例如，下面的输入：

```
    f <- function(x){
        n <- length(x)
        y <- numeric(n)
        y[x >= 0] <- 1
        ##y[x < 0] <- 0
        
        y
    }
```

转换为

```
f <- function(x){
    n <- length(x)
    y <- numeric(n)
    y[x >= 0] <- 1
    ##y[x < 0] <- 0
    
    y
}
```

更适当的做法是用三个连续的反向单撇号表示代码开头与代码结束， 中间就会当作源程序代码处理。 例如下面的输入

```
​```
> x <- rnorm(100)
> hist(x)
​```
```

转换为

```
> x <- rnorm(100)
> hist(x)
```

R的knitr包在Markdown格式的文件中插入R可执行代码时， 就用了这样的方法。 而且，R Markdown格式的代码块不需要用空行与前后分隔开。

在pandoc程序的支持下， 代码段还可以采用栅栏式代码段， 在代码段开头前面一行加上至少三个连续`~`符号， 在结尾后面一行加同样数目的`~`符号。 这样的代码段前后也必须空行以与其它内容分开。 另外，如果代码内本身含有`~`行， 只要使得开头与结尾标志中的`~`个数更多就可以了。 例如下面的输入

```
~~~
#include <math.h>
double sqr(double x){
  return(x*x);
}
~~~
```

转换为

```
#include <math.h>
double sqr(double x){
  return(x*x);
}
```

使用栅栏式代码段时可以在开始行尾写大括号， 在大括号内写选项。 其中一种选项是要求按照某种编程语言对结果进行彩色语法显示， 如.cpp表示C++，.c表示C，.r表示R，.python表示python等。 选项`.numberLines`要求该代码行编号， 选项`startFrom=`指定开始行号。如 如:

```
~~~{.cpp .numberLines startFrom=101}
#include <math.h>
double sqr(double x){
  return(x*x);
}
~~~
```

转换为

```
#include <math.h>
double sqr(double x){
  return(x*x);
}
```

### 21.3.8 链接

最简单的链接是原样显示的可点击的链接， 只要把链接地址用小于号和大于号包在中间， 两边用空格和其它内容隔开。 如果是网页，需要加`http://`， 如果是邮箱，需要加`mailto:`。 例如，如下代码:

```
北京大学的网页地址是： <http://www.pku.edu.cn/> 。
```

显示为

北京大学的网页地址是： http://www.pku.edu.cn/ 。

除此之外， Markdown 还支持两种形式的链接语法： 行内式和引用式两种形式。 不管是哪一种，链接的显示文字都是用方括号`[...]`来标记。

要建立一个行内式的链接， 只要在方括号内写链接的显示文字， 右方括号后面紧接着圆括号， 并在圆括号中间插入网址链接即可。 方括号部分与圆括号部分之间不能断开。 例如：

```
请参考：[李东风的教学主页](http://www.math.pku.edu.cn/teachers/lidf/course/index.htm)
```

变成了

请参考：[李东风的教学主页](http://www.math.pku.edu.cn/teachers/lidf/course/index.htm)

在圆括号中，链接后面还可以包含用双撇号包围的标题文字， 与链接之间用空格分开。

引用式的链接， 需要在某处（比如文章结尾）定义一些链接的标识符， 然后用方括号包围链接的显示文字， 后面紧接着方括号包围着链接的标识符。

为了定义链接标识符， 用方括号包围链接标识符， 前面可以有至多3个空格缩进， 右方括号后面紧接着冒号和一个空格， 空格后写链接地址， 然后空格，在两个双撇号中间写一个链接地址的标题。 例如

```
[baidu]: http://baidu.com/ "百度"
[pku]: http://www.pku.edu.cn/ "北大"
```

这时，在文章中就可以用标识符调用链接， 如`[北京大学主页][pku]`将变成链接[北京大学主页](http://www.pku.edu.cn/)。

使用引用式的链接， 有些像论文中把所有参考文献排列在文章末尾， 文中用到某一篇文献只要提及其序号。

还有一种链接是内部链接，用于文内跳转。 在各级标题行的末尾， 可以添加`{#自定义标签}`这样的内容， 其中“自定义标签”是自己写的一个标识符， 标识符仅使用英文字母、数字、下划线、减号， 用来区分不同的位置。 比如，本文第一节“介绍”添加了`markdown-intro`为标签， 就可以用“`[回到介绍](#markdown-intro)`”产生链接 [回到介绍](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/markdown.html#markdown-intro)。

### 21.3.9 插入图形

图形只能用链接形式， 不可能保存到一个纯文本文件内。 图形文件可以存在于远程服务器上， 也可以是与生成的HTML文件在同一目录结构中的文件。 语法仍使用行内式和参考式两种形式。 转化成HTML、PDF、Word格式后可以把图形内嵌在输出文件内部。

行内式的图片链接， 是普通行内链接格式前面添加了一个叹号， 惊叹后面紧接着方括号， 方括号内写图片的标题，标题可以空缺， 在右方括号后面紧接着圆括号， 圆括号内写图片的链接。

例如，下面的代码可以插入百度的一个logo，使用的是网上的资源:

```
![](http://www.baidu.com/img/baidu_jgylogo3.gif)
```

结果为

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/baidu_jgylogo3.png)

为了插入保存在本地的与Markdown源文件在同一子目录或下级子目录的图形， 只要在圆括号中写图片文件名（如果与Markdown源文件在同一子目录）或相对路径。 例如，在`D:\work\figs`下的图形文件`baidu_logo.gif`在本Markdown源文件所在目录的figs子目录中, 可以用代码

```
![](figs/bd_logo.png)
```

结果为

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/figs/bd_logo.png)

这样含有网上图片和本地图片的Markdown源文件转化为HTML和docx格式， 都可以正常显示插入的图片。

与链接类似， 也可以在文章某处（比如末尾）定义图片的标识符， 然后把行内图片引用中图片地址替换成图片标识符即可。

### 21.3.10 表格

Markdown文本格式的表格就像是用减号、等号、竖线画的文本格式表格一样， 转化为HTML、docx等格式后就变成了富文本的表格。 有如下几种表格：

- 管道表
- 简单表
- 换行表
- 有格表

#### 21.3.10.1 管道表

管道表在两列之间用竖线分开， 在列标题下面用减号画横线， 用如下方法指定各对齐方式：

- 在列标题下的横线开始加冒号，表示左对齐；
- 在列标题下的横线末尾加冒号，表示右对齐；
- 在列标题下的横线两端加冒号，表示居中对齐；
- 列标题下面仅有横线没有冒号，表示缺省对齐方式，一般是左对齐。

在表格内容后面空一行后写用`Table:`开头的表格说明。

这种方法不需要输入内容上下对齐，适用于中文内容。 后面所讲的简单表、换行表、有格表需要能够输入内容对齐， 对于中英文混合内容很难做到对齐， 所以仅管道表比较适合中文内容。

例如:

```
| 姓名   |  收入      |    职业          | 颜色偏好  |
|:------|-----------:|:---------------:|-----------|
| 赵四海  |    123456  |   业务经理      |   红      |
| 刘英    |        50   |     无        |   蓝      |
| 钱德里  |      3200   |    保洁        |    灰     |

Table: 管道表示例
```

结果为

| 姓名   | 收入   | 职业     | 颜色偏好 |
| ------ | ------ | -------- | -------- |
| 赵四海 | 123456 | 业务经理 | 红       |
| 刘英   | 50     | 无       | 蓝       |
| 钱德里 | 3200   | 保洁     | 灰       |

管道表不允许输入单元格换行， 单元格内容太宽时转换结果可能自动换行， 自动换行时列宽度与输入的列标题下横线宽度成比例。

#### 21.3.10.2 简单表

简单表的格式是， 第一行是各列标题， 第二行是各标题下面用减号组成的表格线， 同一行的不同列要用空格分开， 从第三行开始是内容。

在表格前或表格后用空行隔开的以`Table:`开头的行是表格说明或标题。

为了确定表格每列单元格内容如何对齐， 用列标题下的表格线给出提示：

- 表格线与列标题右对齐，表示该列右对齐；
- 表格线与列标题左对齐，表示该列左对齐；
- 列标题在表格线中间，表示该列居中对齐；
- 列标题左右都与表格线对齐，表示该列为缺省对齐方式，一般是左对齐。

一定要使用一个等宽字体来编辑这样的表格，否则对齐与否无法准确分辨。 单元格内容不能超出表格线左端。 经过试验发现， 中文内容很难按这种方法对齐。

例如：

```
Name        Income          Job              Color
------    --------     ------------------    -----
Jane        123456     Research Assistant    red 
John           50        N/A                 blue
William      3200      Cleaner               blue

Table: 一个简单表的例子
```

结果为：

| Name    | Income | Job                | Color |
| ------- | ------ | ------------------ | ----- |
| Jane    | 123456 | Research Assistant | red   |
| John    | 50     | N/A                | blue  |
| William | 3200   | Cleaner            | blue  |

#### 21.3.10.3 换行表

换行表在输入列标题和单元格内容时， 允许输入内容拆分行，但是转化后并不拆分行。 这样的表以一行减号开始，以一行减号结束， 中间的表格用空行分开实际的不同行。 例如：

```
----------------------------------------------------
Name                     
of
Subject     Income        Job                color           
------    --------     ------------------    -----
Jane        123456       Research            red 
Ayer                     Assistant

John           50        N/A                 blue
Tukey

William      3200      Cleaner               blue
Tale
----------------------------------------------------

Table: 一个换行表的例子
```

结果为：

| Name of Subject | Income | Job                | color |
| --------------- | ------ | ------------------ | ----- |
| Jane Ayer       | 123456 | Research Assistant | red   |
| John Tukey      | 50     | N/A                | blue  |
| William Tale    | 3200   | Cleaner            | blue  |

换行表输入时各列的输入宽度是有作用的， 输入较宽的列结果也较宽。

#### 21.3.10.4 有格表

完全用减号、竖线、等于号、加号画出表格线。 这样的表在文本格式下呈现出很好的表格形状。 转化后不能指定对齐方式。

例如：

```
Table: 有格表示例

+---------------+---------------+--------------------+
| Fruit         | Price         | Advantages         |
+===============+===============+====================+
| Bananas       | $1.34         | - built-in wrapper |
|               |               | - bright color     |
+---------------+---------------+--------------------+
| Oranges       | $2.10         | - cures scurvy     |
|               |               | - tasty            |
+---------------+---------------+--------------------+
```

结果为

| Fruit   | Price | Advantages                   |
| ------- | ----- | ---------------------------- |
| Bananas | $1.34 | built-in wrapperbright color |
| Oranges | $2.10 | cures scurvytasty            |

## 21.4 附录：pandoc软件介绍

[pandoc](https://www.pandoc.org/)是一个杰出的开源软件， 作者为John MacFarlane。 RStudio软件中已经包含了这个软件。 软件在命令行运行， 可以用来在多种不同的文件格式之间进行转换， 输入格式一般是文本格式， 比如markdown、LaTeX、MediaWiki、reStructured Text、 HTML、DocBook， 但是也可以输入MS Word docx、Open Office ODT、EPUB格式。 输出可以是这些文本格式， 也可以是MS Word docx、Open Office ODT、EPUB、LaTeX等格式， 在安装了LaTeX编译系统如MikTeX时可以输出为PDF。 RStudio软件中包括了一份pandoc软件程序。

可以用普通文本编辑器编写markdown格式的文件， 用pandoc转换为HTML或MS Word docx等格式。 因为pandoc需要UTF8编码的输入文件， 所以应该把markdown文件保存为UTF格式， MS Windows下的Notepad++软件可以很容易地编辑文本文件 并在各种编码之间转换。 实际上，MS Windows下有一个markdown编辑程序Smarks就是基于pandoc软件的。

首先， 从pandoc网站下载并安装pandoc。 安装程序很奇怪地安装到了 `C:\Users\登录用户名\AppData\Local\Pandoc`中， 请将此子目录复制到一个合适的位置， 比如`C:\Pandoc`。 如果把此路径加入到Windows系统的可执行文件搜索路径中 （在“控制面板-系统和安全-系统-高级系统设置-环境变量”中， 为系统变量的Path添加一个分号分开的路径`C:\Pandoc`即可以不用全路径访问 pandoc.exe可执行文件。

为了用pandoc转化某个markdown文件， 首先在该文件所在子目录打开一个Windows命令行窗口， 在MS Win10系统中只要在文件管理器的“文件”菜单选择 “打开命令提示符”即可。 比如，文件名是`test.md`, 用如下pandoc命令可以转换为.docx文件(MS Word文件的新版本):

```
C:\Pandoc\pandoc -o test.docx test.md 
```

用如下pandoc命令可以转换为.html文件:

```
C:\Pandoc\pandoc -s -o --mathjax test.html test.md
```

如果把pandoc.exe加入了Windows操作系统的Path环境变量中， 上面的 `C:\Pandoc\pandoc` 可以简写为 `pandoc`。

pandoc在其它操作系统中也有相应的版本。 软件下载与文档见Pandoc的网站[http://pandoc.org](http://pandoc.org/)。

如果使用RStudio编辑markdown文件或者R Markdown文件， 它会自动调用内置的pandoc程序。

------

### References

Xie, Yihui, J. J. Allaire, and Garrett Grolemund. 2019. *R Markdown: The Definitive Guide*. CRC Press. https://bookdown.org/yihui/rmarkdown/.







# 22 R Markdown文件格式

## 22.1 R Markdown文件

借助于R的knitr和rmarkdown扩展包的帮助， 可以在Markdown格式的源文件中插入R代码， 使得R代码的结果能够自动插入到最后生成的研究报告中。 这种格式称为R Markdown格式，简称为Rmd格式， 相应的源文件扩展名为.Rmd。 输出格式可以是HTML、docx、pdf、beamer等。 R Markdown的基础格式是markdown格式， 严格说来是Pandoc软件支持的增强版的markdown格式， 比如， 支持LaTex格式的数学公式， 支持各种编程语言语法彩色加亮显示，等等。

knitr的详细文档参见网站[knitr文档](http://yihui.name/knitr/)。 关于R Markdown可参考专著(Xie, Allaire, and Grolemund [2019](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#ref-Xie2019:rmarkdown))。 RStudio网站提供了一个R Markdown使用摘要下载： (rmarkdown-2.0.pdf)[rmarkdown-2.0.pdf]。 Pandoc的文档见[pandoc网站](https://www.pandoc.org/)。

一个Rmd文件中包含元数据(metadata)、正文内容和R代码三种成分， 比如，下面是一个简单的Rmd文件样例：

```
---
title: "R语言简介"
author: "李东风"
date: "2019-08-29"
output: html_document
---
这里是正文段落。
段落中仍可以利用一般的Markdown语法，
比如在两边用双星号表示**粗体加重**，
在用两边反单撇号表示代码，如`y <- sin(x)`。

下面是一个R代码段，有文字输出：
​```{r}
set.seed(1)
x <- round(rnorm(10), 2)
print(x)
​```

下面是一个R代码段，有图形输出：

​```{r}
plot(x)
​```

下面是一个R代码段，
有富文本表格输出：

​```{r}
knitr::kable(as.data.frame(x))
​```

在文字段落内部也可以有代码，
比如，x的第一个元素值为`r x[1]`。

​```
```

在文件开头用三个减号组成的行包围的内容称为**元数据**， 可以用来规定文章标题、作者、日期、输出格式、输出设置等属性。 见[22.11](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#rmarkdown-attryaml)。

## 22.2 R Markdown文件的编译

RStudio是一个集成的R软件环境， 可以用来编辑和执行R程序， 这个软件也可以用来编辑和编译R Markdown格式的文件， 使得R Markdown格式的文件变得容易使用。 在RStudio中可以直接用一个快捷图标一次性地把R代码结果插入内容中并编译为HTML或MS Word docx格式， 还支持Markdown中LaTeX格式的数学公式。 建议使用RStudio软件作为R Markdown文件的编辑器。

在RStudio软件中，用菜单“File–New File–R Markdown”新建一个R Markdown文件，扩展名为`.Rmd`。 用快捷图标Knit可以将文件转换成HTML格式、PDF格式（需要安装LaTeX编译软件）、MS Word格式。

从HTML格式可以转换成PDF格式。 为此， 安装Google的Chrome浏览器， 在Chrome中打开HTML文件后， 从Chrome浏览器的菜单中找到打印菜单， 从中选择打印机为“保存到PDF”选项， 就可以将HTML网页转换成PDF， 其中的数学公式、表格、图形都可以比较好地转换。 但是，经试验，slidy幻灯片用Internet Explorer浏览器转换PDF更合适。 其它浏览器在转换数学公式时容易将公式右侧的编号裁切掉。

从Word文件也可以转换成PDF格式， 用MS Word软件的“文件-导出”或者“文件-另存为”功能即可。

如果想将R Markdown文件借助于LaTeX格式转换为PDF， 需要在系统中安装一个TeX编译器， 如MS Windows下有MikTeX软件包。 如果仅在R Markdown文件中使用LaTeX功能， 可以安装谢益辉的[TinyTeX](https://yihui.name/tinytex/)软件包。

如果不借助于RStudio软件， 可以用R软件、knitr包、rmarkdown包、pandoc软件来完成R Markdown源文件的编译。 比如，假设`test.Rmd`是一个这样的R Markdown格式的文件， 注意一定要使用UTF-8编码保存， 可以在R或RStudio中运行如下命令以生成含有运行结果的html文件:

```
rmarkdown::render("myfile.Rmd", output_format = "html_document", encoding="UTF-8")
```

其中`myfile.Rmd`是源文件， 产生的HTML文件带有图形、支持数学公式。

在R或RStudio中可以用如下命令把.Rmd文件转化为MS Word docx格式:

```
rmarkdown::render("myfile.Rmd", output_format = "word_document", encoding="UTF-8")
```

使用RStudio软件使得这些任务可以一键完成， 而且有很好的数学公式支持， 所以建议编辑R Markdown文件还是使用RStudio软件。

用RStudio的Knit图标一键编译与用`rmarkdown::render()`命令编译有一个重要差别：

- 用Knit图标编译，Rmd文件中的程序会在一个崭新的会话中执行， 当前会话中已经定义的函数、变量、导入的扩展包不会影响到编译结果；
- 用`rmarkdown::render()`编译， Rmd文件中的程序是在当前会话中执行的， 会带来一定的兼容性问题， 有可能在别人的环境下就不能正确执行或者会给出不同结果。 但是，`rmarkdown::render()`可以通过程序调用， 比如，循环地从同一个Rmd生成一系列不同的报告。 为了不让当前会话环境干扰结果， 可以人为地打开一个新会话。

## 22.3 在R Markdown文件中插入R代码

插入的R代码分为行内代码与代码块。

行内代码的结果插入到一个段落中间， 代码以``r`开头，以```结尾， 如`r sin(pi/2)`在结果中会显示为1。 为了原样显示一个反向单撇号， 可以在两边用双反向单撇号界定并用空格隔开内部的内容。

代码块则把结果当作单独的段落， 按照Markdown格式的规定， 代码块的前后需要有空行， 但是R Markdown实际上放松了这个要求， 允许前后不空行。 R代码段以单独的一行开头， 此行以三个反单撇号开始， 然后是`{r}`，如````{r}`。 代码段以占据单独一行的三个反单撇号`````结尾。 如

```
set.seed(1)
x <- round(rnorm(10), 2)
print(x)
```

结果将变成

```
set.seed(1)
x <- round(rnorm(10), 2)
print(x)
##  [1] -0.63  0.18 -0.84  1.60  0.33 -0.82  0.49  0.74  0.58 -0.31
```

可以看出，代码段程序会被插入到最终结果中， 代码段的文本型输出会插入到程序的后面。

代码块也可以嵌入到引用、列表等环境中。

代码块中作的图将自动插入到当前位置。 下面的程序：

```
plot(x)
```

结果将显示为:

```
plot(x)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown_files/figure-html/rmd-block02-1.png)

在RStudio中， 可以用Insert快捷图标插入代码段， 还可以用Ctrl+Alt+I快捷键插入代码段。

## 22.4 输出表格

knitr包提供了一个 `kable()` 函数可以用来把数据框或矩阵转化成有格式的表格， 支持HTML、docx、LaTeX等格式。

例如，计算线性回归后， `summary()`函数的输出中有coefficients一项，是一个矩阵， 如果直接文本显示比较难看：

```
x <- 1:10; y <- x^2; lmr <- lm(y ~ x)
co <- summary(lmr)$coefficients
print(co)
##             Estimate Std. Error   t value     Pr(>|t|)
## (Intercept)      -22  5.5497748 -3.964125 4.152962e-03
## x                 11  0.8944272 12.298374 1.777539e-06
```

可以用knitr包的kable函数来显示:

```
knitr::kable(co)
```

|             | Estimate | Std. Error | t value   | Pr(>\|t\|) |
| ----------- | -------- | ---------- | --------- | ---------- |
| (Intercept) | -22      | 5.5497748  | -3.964125 | 0.0041530  |
| x           | 11       | 0.8944272  | 12.298374 | 0.0000018  |

`kable()`函数的`digits=`选项可以控制小数点后数字位数， `caption=`选项可以指定表的标题内容。

R扩展包xtable提供了一个`xtable()`函数， 也可以用来生成HTML格式和LaTeX格式的表格， 但是需要指定要输出的格式。 xtable对比较多的R数据类型和输出类型提供了表格式显示功能， 包括矩阵、数据框、回归分析结果、方差分析结果、主成分分析结果、 若干分析结果的summary结果等。 例如，上面的回归结果用`xtable()`函数显示如:

```
print(xtable::xtable(lmr), type='html')
```

|             | Estimate | Std. Error | t value | Pr(>\|t\|) |
| ----------- | -------- | ---------- | ------- | ---------- |
| (Intercept) | -22.0000 | 5.5498     | -3.96   | 0.0042     |
| x           | 11.0000  | 0.8944     | 12.30   | 0.0000     |

这个代码段用了选项`results='asis'`， 因为xtable生成的是直接用来插入到结果中的html代码。 注意这里指定了输出为HTML类型。 如果将本文件转化为docx, xtable的结果不可用。

R扩展包pander提供了更好的表格能力， 也能与knitr包很好的合作输出。 其`pander()`函数可以将多种R输出格式转换成knitr需要的表格形式。 如

```
pander::pander(lmr)
```

|                 | Estimate | Std. Error | t value | Pr(>\|t\|) |
| --------------- | -------- | ---------- | ------- | ---------- |
| **(Intercept)** | -22      | 5.55       | -3.964  | 0.004153   |
| **x**           | 11       | 0.8944     | 12.3    | 1.778e-06  |

但是，经过试验发现， 表中中有中文时pander包会出错。

## 22.5 利用R程序插图

Rmd文件的插图有两种， 一种是已经保存为图形文件的， 主要是png和pdf图片； 另一种是文中的R代码生成的图形。

已经有图形文件的， 可以用markdown格式原来的插图方法， 见[markdown格式介绍](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/markdown.html)。 但是，这样做不能给图形自动编号， 另外因为制作图书是有网页和PDF书两种主要输出格式的， 原有的插图方式在这两种输出格式上有细微的不一致。 所以，最好是统一使用Rmd的插图方法。

Rmd的插图方法就是写一段R代码段来插图， 如果是用程序作图，则代码中写作图的代码； 如果是已有的图形文件， 可以在一个单独的R代码段中用类似下面的命令插图：

```
​```{r, echo=FALSE}
knitr::include_graphics("figs/myfig01.png")
​```
knitr::include_graphics("figs/myfig01.png")
```

其中`figs`是存放图形文件的子目录名， `myfig01.png`是要插入的图形文件名。 这样， 如果同时还有`myfig01.pdf`的话， 则HTML输出使用png图片而PDF输出自动选用pdf文件。 另外， 插图的选项在代码段的选项中规定： 用代码段的`fig.with`和`fig.height`选项指定作图的宽和高（英寸）， 用`out.width`和`out.height`选项指定在输出中实际显示的宽和高， 实际显示的宽和高如果使用如`"90%"`这样的百分数单位则可以自动适应输出的大小。

由于PDF中的中文编码不能自动识别， 所以在每个Rmd源文件的开头应该加上如下的设置， 使得生成PDF图时中文能够正确显示：

```
​```{r setup-pdf, include=FALSE}
pdf.options(family="GB1")
​```
```

其中`include=FALSE`表示要不显示代码段的代码， 有运行结果也不插入到输出结果中， 是否运行视缺省的`eval=`的值而定。

## 22.6 代码段选项

独立代码段以````{r}`开头， 在大括号内还可以写一些选项， 选项之间以及与开始的`r`之间用逗号分隔， 所有选项写在同一行内不要换行。 选项都使用“选项名=选项值”的格式， 选项值除了使用常量外也可以使用全局变量名或表达式。 在大括号内开头的 `r`空格后写一个由英文大小写字母、数字、减号组成的标识符， 作为代码段的标签。 标签中不要用其它类型的字符， 下划线也不要用。 如

```
​```{r firstCode}  
cat('This is 第一段, 有标签.\n')  
​```
```

关于代码段选项， 详见https://yihui.name/knitr/options。

### 22.6.1 代码和文本输出结果格式

R代码块和R代码块的运行结果通常是代码块原样输出， 运行结果用井号保护起来， 这样有利于从文章中复制粘贴代码。 如：

```
​```{r}
s <- 0
for(x in 1:5) s <- s + x^x
s
​```
```

结果为:

```
s <- 0
for(x in 1:5) s <- s + x^x
s
## [1] 3413
```

#### 22.6.1.1 highlight选项

转化后的R代码块缺省显示为彩色加亮形式。 用选项`highlight=FALSE`关闭彩色加亮功能。

#### 22.6.1.2 prompt和comment选项

如果希望代码用R的大于号提示符开始， 用选项`prompt=TRUE`。 如果希望结果不用井号保护， 使用选项`comment=''`。 例如：

```
​```{r prompt=TRUE, comment=''}
sum(1:5)
​```
```

结果为:

```
> sum(1:5)
[1] 15
```

#### 22.6.1.3 echo选项

如果希望不显示代码， 加选项`echo=FALSE`。 如

```
​```{r echo=FALSE}
print(1:5)
​```
```

结果为:

```
## [1] 1 2 3 4 5
```

#### 22.6.1.4 tidy选项

加选项`tidy=TRUE`可以自动重新排列代码段， 使得代码段格式更符合规范。例如：

```
​```{r tidy=TRUE}
s <- 0
for(x in 1:5) {s <- s + x^x; print(s)}
​```
```

结果为:

```
s <- 0
for (x in 1:5) {
    s <- s + x^x
    print(s)
}
## [1] 1
## [1] 5
## [1] 32
## [1] 288
## [1] 3413
```

#### 22.6.1.5 eval选项和include选项

加选项`eval=FALSE`, 可以使得代码仅显示而不实际运行。 这样的代码段如果有标签， 可以在后续代码段中被引用。

加选项`include=FALSE`， 则本代码段仅运行， 但是代码和结果都不写入到生成的文档中。

#### 22.6.1.6 child选项

加选项`child='文件名.Rmd'`可以调入另一个.Rmd文件的内容。 如果有多个.Rmd文件依赖于相同的代码，可以用这样的方法。

#### 22.6.1.7 collapse选项

一个代码块的代码、输出通常被分解为多个原样文本块中， 如果一个代码块希望所有的代码、输出都写到同一个原样文本块中， 加选项`collapse=TRUE`。 例如， 没有这个选项时：

```
​```{r}
sin(pi/2)
cos(pi/2)
​```
```

结果为：

```
sin(pi/2)
## [1] 1
cos(pi/2)
## [1] 6.123032e-17
```

代码和结果被分成了4个原样文本块。 加上`collapse=TRUE`后，结果为：

```
sin(pi/2)
## [1] 1
cos(pi/2)
## [1] 6.123032e-17
```

代码和结果都在一个原样文本块中。

#### 22.6.1.8 results选项

用选项`results=`选择文本型结果的类型。 取值有：

- `markup`, 这是缺省选项， 会把文本型结果变成HTML的原样文本格式。
- `hide`, 运行了代码后不显示运行结果。
- `hold`, 一个代码块所有的代码都显示完， 才显示所有的结果。
- `asis`, 文本型输出直接进入到HTML文件中， 这需要R代码直接生成HTML标签， knitr包的`kable()`函数可以把数据框转换为HTML代码的表格。

例如：`results='hold'`的示例:

```
​```{r collapse=TRUE, results='hold'}
sin(pi/2)
cos(pi/2)
​```
```

结果为:

```
sin(pi/2)
cos(pi/2)
## [1] 1
## [1] 6.123032e-17
```

#### 22.6.1.9 错误信息选项

选项`warning=FALSE`使得代码段的警告信息不进入编译结果， 而是在控制台(console)中显示。 有一些扩展包的载入警告可以用这种办法屏蔽。

选项`error=FALSE`可以使得错误信息不进入编译结果， 而是出错停止并将错误信息在控制台中显示。

选项`message=FALSE`可以使得message级别的信息不进入编译结果， 而是在控制台中显示。

### 22.6.2 图形选项

#### 22.6.2.1 图形大小

用`fig.width=`指定生成的图形的宽度， 用`fig.height=`指定生成的图形的高度， 单位是英寸（1英寸等于2.54厘米）。

下面给出一个长宽都是10厘米的图例。

```
​```{r fig.width=10/2.54, fig.height=10/2.54}
curve(exp(-0.1*x)*sin(x), 0, 4*pi)
abline(h=0, lty=3)
​```
```

结果为:

```
curve(exp(-0.1*x)*sin(x), 0, 4*pi)
abline(h=0, lty=3)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown_files/figure-html/rmd-knitop-figw01-1.png)

`fig.width=`和`fig.height=`规定的是生成的图形大小， 实际生成图形的显示大小会受到dpi（分辨率）影响， 默认dpi是72（每英寸72个点）， 也可以用`dpi=`选择分辨率。 转化后的HTML文件显示时不一定按原始大小显示。 用`out.width=`和`out.height=`可以指定显示大小， 但是必须是最终文件格式承认的单位， 比如HTML的图形大小单位是点（平常说屏幕分辨率的单位）。 或者写成如`90%`这样的百分比格式。 例如在上面的例子中加上输出度为页面宽度80%的选项：

```
​```{r fig.width=10/2.54, fig.height=10/2.54, out.width="80%"}
curve(exp(-0.1*x)*sin(x), 0, 4*pi)
abline(h=0, lty=3)
​```
```

注意所有选项都要写在一行中，不能换行。 结果为:

```
curve(exp(-0.1*x)*sin(x), 0, 4*pi)
abline(h=0, lty=3)
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown_files/figure-html/rmd-knitop-outw01-1.png)

当输出结果为HTML结果或者LaTeX转换的PDF时， 只要两个图形的总宽度小于页面宽度， 两个连续的图形就可以左右并列放置。 Word不支持这种功能。 例如：

```
​```{r, echo=FALSE, fig.width=10/2.54, fig.height=10/2.54, out.width="45%"}
curve(exp(-0.1*x)*sin(x), 0, 2*pi)
abline(h=0, lty=3)
curve(exp(-0.1*x)*cos(x), 0, 2*pi)
abline(h=0, lty=3)
​```
```

结果为

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown_files/figure-html/rmd-knitop-double01-1.png)![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown_files/figure-html/rmd-knitop-double01-2.png)

#### 22.6.2.2 图形结果选择

用`fig.keep=`选项可以选择保留哪些R代码生成的图。 缺省是`fig.keep='high'`, 即保留每个高级图形函数的结果图形， 低级图形函数对高级图形函数的更改不单独保存而汇总到高级图形函数结果中。 如

```
par(mar = c(3, 3, 0.1, 0.1))
plot(1:10, ann = FALSE, las = 1)
text(5, 9, "Testing low level graphics")
```

![img](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown_files/figure-html/rmd-knitop-keep01-1.png)

其中`text()`函数的结果与高级图形函数`plot()`的结果一起显示。

`fig.keep`还可以取：`all`, 会把低级图形函数修改后的结果单独保存； `last`, 仅保留最后一个图形；`first`, 仅保留第一个图； `none`, 所有图都不显示出来。

### 22.6.3 缓存(cache)选项

当R Markdown文章比较长，包含的R代码比较多， 或者代码段运行需要比较长时间时， 反复编译整篇文章会造成不必要的计算， 因为有些代码段并没有修改， 依赖的数据也没有改变。 knitr提供了缓存功能， 代码段选项`cache=TRUE`对代码段打开缓存， 允许暂存上次运行的结果（包括文本结果和图形） 而不需要重复运行代码段。 当代码段被修改时， 缓存被放弃， 编译时重新运行代码段。

缓存这种功能需要慎重使用， 免得错误地使用了旧的结果。 当后面的代码段需要使用前面代码段结果时， 如果前面结果改了， 后面的代码段就不能使用缓存的结果而必须重新计算。 为此， 在后面的代码段中应该加上`dependson=`选项， 比如`dependson=c('codeA', 'codeB')`， 其中`codeA`和`codeB`是前面的缓存了的代码段的标签， 其结果会用在本代码段中。 也可以使用代码段选项`autodep=TRUE`， knitr试图自动确定前后代码段之间的依赖关系， 每当前面的代码段改变时， 后面的用到其结果代码段也自动重新计算而不使用缓存的旧结果。

建议仅对计算一次需要较长时间的代码段使用缓存功能， 后面依赖于其结果的代码一定要加上`dependson=`选项。 建议代码段尽可能有标签，这样在编译失败时能马上看出失败的地点。

为了保险起见， 可以尽量不使用缓存功能， 而是用`save()`功能将需要长时间结算的结果保存下来， 用`load()`载入然后输出到结果文档中。

## 22.7 章节目录链接问题

对于英文文件， R Markdown基于的pandoc软件可以自动从标题生成适当的链接标签， 将HTML输出或者PDF输出设置属性`toc: true`后可以生成可点击的章节目录。 但是，目前Pandoc对于中文文件的支持差一些， 所以中文文件要自动生成可点击的目录， 需要在每个标题行的末尾，空格后添加`{#label}`， 其中`label`是自己指定的标签内容， 但是建议仅使用英文字母、数字、减号。 如

```
### 第三章第一节标题 {#c3-s1-int}
```

如果希望某个标题不参与自动编号， 可以在标题末尾空格之后加上`{-}`标记。

## 22.8 数学公式

### 22.8.1 在Markdown中输入数学公式

原始的Markdown格式并不支持数学公式。 Pandoc扩展的markdown格式提供了对数学公式的支持， 可以在Markdown文件中插入LaTeX格式的数学公式。 虽然不能提供所有的LaTeX公式能力， 但是常用的数学公式还是能做得很好， 转换到HTML、docx都可以得到正常显示的公式。

用RStudio软件编译Markdown文件，可以在其中插入LaTeX格式的数学公式， 编译成HTML或者docx格式后都可以正常显示数学公式, 在另外安装的LaTeX编译器的支持下也可以将.Rmd格式编译LaTeX格式然后再转换为PDF格式， 这种方法对数学公式的支持会更完善。

关于数学公式的软件设置参见下面设置部分的内容。

### 22.8.2 数学公式类别

数学公式公式分为行内公式和独立公式。 行内公式和段落的文字混排， 写在两个美元符号`$`中间，或者`\(`和`\)`之间。 例如`$f(x)=\frac{1}{2} \int_0^1 \sin^2 (t x) dt$`变成 。 开头的`$`后面不能紧跟着空格， 结尾的`$`不能紧跟在空格后面。

独立公式写在成对的美元符号中间，或者`\[`和`\]`之间。 例如：

```
$$
  f(x) = \frac{1}{2} \sum_{j=1}^\infty \int_0^1 \sin^2(j t x) dt .
$$
```

显示为







### 22.8.3 基本功能

在数学公式中， 用下划线表示下标， 比如`$x_1$`结果为。 用`^`表示上标， 如`$x^2$`结果为。 上下标都有，如`$x_1^2$`结果为。

公式中用大括号表示一个整体， 比如`$x^(1)$`不能得到， 需要用`$x^{(1)}$`。

公式中用反斜杠开始一个命令， 命令仅包含字母而不能包含数字， 数字只能作为参数。 如`$\frac{1}{2}$`和`$\frac12$`都可以生成。 类似的命令如`$\sqrt{2}$`为。

希腊字母都有对应的命令， 如`$\alpha$`为， `$\Sigma$`为。

常用数学函数有自己的命令， 如`$\sin x$`变成， `$\exp (x)$`为。

圆括号与方括号可以直接使用， 绝对值符号用`|`， 如`$|x|$`变成。 但是，大括号必须写成`\{`和`\}`的形式， 如`$\exp\{-\frac12 x^2\}$`变成。

为了使得括号能够与括号内部的内容等高， 可以用`\left`和`\right`命令进行修饰， 如

```
$$
\phi(x) = \frac{1}{\sqrt{2\pi}} \exp\left\{ \frac{1}{2} x^2 \right\}
$$
```

变成



注意`\left``\right`



求和如`$\sum_{i=1}^n x_i$`变成。 乘积如`$\prod_{i=1}^n x_i$`变成。 积分如`$\int_0^1 f(x) dx$`变成。

### 22.8.4 修饰符

`$f'(x)$`显示为， 表示导数； `$f''(x)$`显示为， 表示二阶导数。 顺便说一句， 偏导数写法如`$\frac{\partial f(x,t)}{\partial x}$`， 显示为。

的写法是`$\bar{x}$`。 的写法是`$\overline{\text{span}}$`。 的写法是`$\hat{x}$`。 的写法是`$\tilde{x}$`。 的写法是`$\vec{x}$`。

### 22.8.5 对齐与矩阵

为了产生对齐的公式， 在独立公式中使用aligned环境。 公式中的环境以`\begin{环境名}`开始， 以`\end{环境名}`结束， 用`\\`表示换行，用`&`表示一个上下对齐位置。 如

```
$$
\begin{aligned}
  f(x) =& \sum_{k=0}^\infty \frac{1}{k!} x^k \\
  =& e^x
\end{aligned}
$$
```

转化成





可以用pmatrix环境制作写在圆括号中的矩阵， 用bmatrix环境制作写在方括号中的矩阵， 用vmatrix制作写在绝对值号中的矩阵，如



列向量、行向量也可以用这种办法制作。



### 22.8.6 特殊字体

数学公式中的单词、文字必须用`\text{...}`保护，比如

```
$$
\text{CV} = \frac{S}{\bar x} \times 100 \%
$$
```

变成



上例中如果不用`\text{}`



有时用粗体表示向量或者矩阵， 用`\boldsymbol{...}`说明。如

```
$$
\boldsymbol{v} = (v_1, v_2)^T
$$
```

变成





美术体英文字母用`\mathcal{...}`， 如写法为`$\mathcal{A, B, C}$`。

手写花体字母用`\mathscr{...}`， 如写法为`$\mathscr{B, C, F, G}$`。

## 22.9 其它编程语言引擎

Rmd文件中除了R代码段以外， 还可以插入Rcpp、Python、Julia、SQL等许多编程语言的代码段， 常用编程语言还可以与R代码段进行信息交换。

## 22.10 交互内容

在Rmd生成HTML结果时， 可以在结果中包含允许读者交互操作的内容， 比如， 用户修改模型参数， 使得模型报表、图形交互地改变。 有两种方法可以实现交互：

- HTML小程序(widgets)， 由R扩展包[htmlwidgets](https://www.htmlwidgets.org/)实现， 利用JavaScript函数库进行交互。 在这一功能基础上有一些派生的扩展包， 如DT，leaflet, dygraph。
- 利用shiny框架，这也是一个R扩展包， 交互功能由R的一个会话驱动。 Rmd文件的YAML元数据中需要设置`runtime: shiny`。

## 22.11 属性设置

### 22.11.1 YAML元数据

可以在RStudio软件中编辑markdown文件与Rmarkdown文件， RStudio的markdown支持来自knitr、rmarkdown、bookdown扩展包和pandoc软件， .Rmd文件支持一些特殊的文件设置， 这些设置写在markdown文件和.Rmd文件的开头位置， 用三个减号组成的行作为开始标记与结束标记， 称为YAML元数据块(YAML meta data block)， 块后面必须用空行分隔。 元数据块中可以用“设置属性名: 设置属性值”的办法设置属性， 用缩进表示属性内容，用上下对齐的行表示多项列表。 常用属性有`title`(标题)、`author`(作者)、`date`(日期)、`output_format`(输出格式)等，如

```
---
title: "临时测试"
author: "李东风"
date: "2016年7月6日"
---
```

这三个设置会出现在转换后结果的标题部分。 RStudio的中文支持还是有时出现问题， 如果出现涉及到YAML的错误， 先将中文内容替换为英文试一试。

因为冒号`:`在属性设置中有特殊意义， 属性设置值如果含有冒号， 需要把整个属性值两边用单撇号界定。

属性值可以是列表或多项，例如：

```
---
title:  'This is the title: it contains a colon'
author:
  - name: Author One
    affiliation: University of Somewhere
  - name: Author Two
    affiliation: University of Nowhere
tags: [nothing, nothingness]
abstract: |
  This is the abstract.

  It consists of two paragraphs.
---
```

此例中有title、author、tags、abstract四个属性。 author属性包含两个作者， 每个作者又有name和affiliation两个属性。 tags属性是一个两项的列表。 abstract属性用管道符号`|`表示开头，不需要结束标志，内容缩进。

### 22.11.2 输出格式

.Rmd文件开头的YAML元数据中， 属性`output`选择输出的格式， 如

- `html_document`是HTML输出;
- `pdf_document`是PDF输出，通过系统中另外安装LaTeX编译系统转换；
- `word_document`是docx格式的Word文件输出，等等。

输出格式指定如：

```
output: 
  html_document: default
  word_document: default
  pdf_document: default
```

其中default表示该输出格式完全使用默认设置。 在输出格式没有定制设置时必须有default指定。

### 22.11.3 输出格式设置

在每种输出格式后面还可以继续添加该输出特有属性。 如：

```
output: 
  html_document:
    toc: true
    number_sections: true
  word_document:
    toc: true
  pdf_document:
    toc: true
```

### 22.11.4 目录设置

输出格式的`toc: true`选项指定自动生成目录， HTML输出、PDF输出、Word输出都支持此功能。 见上例。

```
output: 
  html_document:
    toc: true
    toc_depth: 2
```

上例中，`html_document`是`output`的属性， 隶属关系用缩进表示； `html_document`又有自己的属性`toc`和`toc_depth`， 隶属关系用缩进表示。 属性`toc: true`表示要自动生成可点击的目录。 输出格式的属性`toc_depth`是目录包含的章节层级数。

对`html_document`输出， 属性`toc_float: true`使得生成的文档在左侧显示一个目录导览窗格。 而`toc_float`属性又可以指定一些属性，隶属关系用缩进表示。 `toc_float`的属性`collapse: true`表示仅展开章节第一层级， `smooth_scroll: true`使得通过导览窗格跳跃时页面有平滑滚动过程显示。 用如：

```
output: 
  html_document:
    toc: true
    toc_float:
      collapse: true
      smooth_scroll: true
```

### 22.11.5 章节自动编号

输出格式的属性`number_sections`为`true`可以自动对章节编号。 HTML输出与PDF输出都支持此功能。

在章节自动编号时， 如果不是利用bookdown包而是基于基本的R Markdown， 文中的分节最高层级最好用一个井号， 对应于节， 如果用两个井号， 编号会变成`0.1`，`0.2`这样。

### 22.11.6 Word输出章节自动编号及模板功能

Word文件不能自动编号， 解决办法是生成适当的模板文件， 如wordstyle.docx, 然后在Rmd文件的元数据部分为`word_document`输出增加`reference_docx`选项，如:

```
output: 
  html_document:
    toc: true
    number_sections: true
  word_document:
    toc: true
    reference_docx: wordstyle.docx
```

这样，新编译的Rmd文件就可以采用`wordstyle.docx`的格式设置， 比如章节自动编号等。 目前目录标题还是英文， 需要在结果中人为地修改为中文。 一个样例模板下载如下： [wordstyle.docx](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/wordstyle.docx)

### 22.11.7 HTML特有输出格式设置

对于`html_document`输出类型， 可以用`theme`属性设置一个主题， 取值如default, cerulean, journal, flatly, darkly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, yeti。

用`highlight`属性设置程序语言语法高亮样式， 可取值有default, tango, pygments, kate, monochrome, espresso, zenburn, haddock, and textmate。 用`null`表示取消语法高亮。

可以用`css`属性指定一个自定义的CSS样式表文件。 如果希望完全用自己的样式代替原有样式， 可以设置`theme: null`。

`code_folding`属性设置HTML结果中代码折叠选项， 取值`hide`可以隐藏代码， 但读者通过选项可见。 取值`show`可以显示代码， 但读者通过选项可隐藏代码显示。

### 22.11.8 关于数学公式支持的设置

Rmd格式支持数学公式， 在生成的HTML、Word、PDF中都可以正常显示数学公式。

以HTML为输出时， 会使用MathJax库显示数学公式。 这是一个用于在浏览器中显示数学公式的Javascript程序库， 显示效果很好， 还支持多种显示实现方式， 支持包括LaTeX在内的多种数学公式输入方法。

MathJax库很大， 所以一般是从其网站按需远程调用的， 但是远程调用MathJax库在网络不畅通时会使得公式显示极为缓慢甚至无法显示， 所以Rmd允许将MathJax本地化。 在.Rmd文件头部YAML元数据的某种HTML输出格式的属性中， 设置属性`mathjax: local`和就可以使得MathJax库被放在生成的HTML的一个下层目录中。 设置如

```
output: 
  html_document:
    toc: true
    self_contained: false
    mathjax: local
```

注意设置`mathjax: local`同时必须设置`self_contained: false`。 在不使用本地MathJax副本时， 可以设置`self_contained: true`， 这使得图形文件、JavaScript代码等依赖项也打包在生成的单一HTML文件中， 如果设为`false`， 这些依赖文件会存放在单独文件中。 可以用`lib_dir`属性指定一个子目录用来存放这些依赖文件， 多个Rmd文件可以共用同一个`lib_dir`值。

将MathJax用`mathjax: local`属性本地化有明显的缺点。 这时，每个Rmd项目都需要一个MathJax库副本， 使得文件备份变得很麻烦。 下面的设置方法可以令多个Rmd项目共享一个共同的本地MathJax库。

### 22.11.9 输出设置文件

如果一个项目包含多个.Rmd文件， 每个文件单独用YAML元数据进行设置比较繁琐， 修改时也很麻烦。 可以在项目目录中增加一个`_output.yml`文件， 其中包含所有.Rmd文件共用的`output`属性的设置， 各个.Rmd文件还可以有自己单独的output属性， .Rmd文件YAML元数据中的属性优先级高于共同设置的属性。

例如，`_output.yml`文件内容如下：

```
html_document:
  toc: yes
  number_sections: yes
  mathjax: "../../MathJax/MathJax.js"
  includes:
    in_header: "_header.html"
word_document:
  toc: yes
  reference_docx: wordstyle.docx
pdf_document:
  includes:
    in_header: preamble.tex
  latex_engine: xelatex
```

上面设置了使用本地硬盘的MathJax库， 位于项目目录的上两层目录中的MathJax子目录中。 这样可以使得多个项目共享一个MathJax库。 将生成的结果当作网站发布时， 只要将MathJax库也安装到项目在网站的目录的上两层的MathJax子目录中就可以。 其中`_header.html`内容如下，是关于MathJax具体的一些设置：

```
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX","output/SVG"],
  extensions: ["tex2jax.js","MathMenu.js","MathZoom.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
  }
});
</script>
```

注意， `_output.yml`文件都是输出设置， 所以不能再有`output`属性，所以下面的`_output.yml`写法是不正确的：

```
output:
  html_document:
    toc: yes
```

## 22.12 LaTeX和PDF输出

Rmd文件的`pdf_document`输出类型是先转换为LaTeX文件， 再借助计算机系统中另外安装的LaTeX编译程序转换为PDF。 需要在系统中安装一个TeX编译器， MS Windows下有MikTeX软件包或者CTEX软件包。 如果仅在R Markdown文件中使用LaTeX功能， 可以安装谢益辉的[TinyTeX](https://yihui.name/tinytex/)软件包， 优点是直接用R命令就可以安装， 更新也由R自动进行，不需要用户干预。

许多LaTeX相关的YAML元数据不是设置在输出属性中， 而是设置为文件的顶级元数据。 如

```
---
title: "R语言简介"
author: "李东风"
date: "2019-08-29"
output: pdf_document
fontsize: "11pt"
geometry: "margin=1in"
---
```

其中属性`fontsize`和`geometry`都是LaTeX选项， 但是没有作为`output--pdf_document`的属性， 而是作为Rmd文件的顶级元数据属性。

用属性`documentclass`指定LaTeX文档类型， 比如article是论文格式， book是图书格式。 ctexart和ctexbook是适用于中文的格式。

`fontsize`是正文字体大小， 可取`10pt`, `11pt`, `12pt`， 其中`10pt`是缺省大小。

`geometry`用来指定geometry包的参数。

默认的LaTeX编译引擎是pdfLaTeX。 可以在`pdf_document`输出的属性中设置`latex_engine: xelatex`将引擎替换成xeLaTeX。 xeLaTeX的优点是支持UTF8编码，可以使用系统中现有字体， 而我们在写中文的R Markdown文档时必须使用UTF-8编码。

Rmd文件中的文献引用可以由pandoc软件执行， 但是在用LaTeX转换PDF时， 可以指定用一个LaTeX引用包， 如：

```
---
output:
  pdf_document:
    latex_engine: xelatex
    citation_package: natbib
---
```

为了自动生成目录并自动为章节编号， 仍在`pdf_document`的属性中指定`toc: true`和`number_section: true`。

在使用bookdown管理Rmd文件时， 文献引用、目录、章节编号方式有另外的指定办法以及默认规则。

为了能够检查转换过程中的错误， 可以用`pdf_document`的属性`keep_tex: true`， 保留作为中间结果的.tex文件， 人工检查其中的错误。

可以在`pdf_document`输出的属性中指定若干个.tex文件插入到LaTeX文档的导言、正文最前面、正文最后后面，如

```
---
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
    citation_package: natbib
    toc: true
    number_sections: true
    includes:
      in_header: preamble.tex
      before_body: doc-prefix.tex
      after_body: doc-suffix.tex
---
```

`preamble.tex`主要用来载入额外的LaTeX包以及定义新的命令， 一个`preamble.tex`的例子如下

```
\usepackage{ctex}     % 支持中文的标点和章节模式

%\usepackage{xltxtra} % XeLaTeX的一些额外符号
% 设置中文字体
\setCJKmainfont[BoldFont={黑体},ItalicFont={楷体}]{新宋体}

\usepackage{amsthm,mathrsfs} % 基本的ams数学公式
\usepackage{booktabs}        % 增强的表格功能
\usepackage{longtable}       % 支持超过一页的表格

% 下面是自定义的定理环境排版方法
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother
```

## 22.13 生成期刊文章

节[22.12](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#rmd-latex)的办法可以用来生成LaTeX然后转换为PDF， 可以用来撰写学位论文和期刊论文。 但是学位论文和期刊论文都有比较严格的格式要求， 用节[22.12](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#rmd-latex)的一般方法需要对LaTeX比较熟悉才能达到格式要求。

用R扩展包rticles可以比较容易地将Rmd文件转换成期刊可接受的LaTeX和PDF格式。 见https://bookdown.org/yihui/rmarkdown/journals.html。 扩展包中对一些常见期刊提供了模板。

首先要安装rticles扩展包，命令为

```
install.packages("rticles")
```

为了生成新的论文源文件， 在RStudio中， 用“File – New File – R Markdown – from Template”菜单， 从列出的文章模板中选一个。

杂志投稿的Rmd模板是用许多元数据来规定格式的。 用户可以修改其中的标题、作者、作者单位等信息。

因为rticlels的输出只有PDF， 所以必要时可以在Rmd源文件中直接使用LaTeX命令， 但如果Rmd本身可以完成时尽可能用Rmd的功能。

因为定理、图表自动标号和索引功能是由bookdown包提供的， 而rticles的输出类型实际是`rmarkdown::pdf_docment`， 所以可以联合使用bookdown与rticles，如

```
output:
  bookdown::pdf_book
    base_format: rticles::peerj_article
```

其中`peerj_article`可以替换成rticles提供的其它格式。

如果自己需要的模板rticles没有提供， 可以自己设法定义模板， 参见https://bookdown.org/yihui/rmarkdown/document-templates.html。

## 22.14 附录：经验与问题

### 22.14.1 Word模板制作

如果有合适的Word格式样例， 可以在YAML元数据的`word_document`的属性中， 设置`reference_docs`属性指向该模板文件。

为了制作Word模板， 不应该从头开始， 而是在没有模板的情况下从Rmd文件转换生成一个Word文件， 将其作为模板文件的基础进行修改。 在修改过程中， 应该制作过程的备份，以便修改错误时能退回上一个版本。

如果文章的大标题样式不是“标题”， 将样式改为“标题”以免在后续的自动编号过程中参与编号。 修改的方法是选中大标题， 然后在Word软件主菜单的“开始–样式”选择框中选中“标题”， 就可以设置其样式。

Word的目录是与“标题1”同级的， 这样会在自动编号时参与编号； 为此， 选中“Contents”， 然后在主菜单的“开始–样式”选择框中， 找到突出显示的“TOC标题”， 右键单击“修改”， 在弹出的对话框中将“样式基准”从“标题1”改为“标题”， 并在同一对话框中将适当调整样式， 如字体类型、大小、颜色、是否居中。 改完后保存并保存一个副本。

如果需要修改“标题”，“作者”，“日期”，“标题1”等等的字体、大小、颜色、对齐方式， 可以选中该部分，并在“样式”中邮件单击相应的样式，选择“修改”进行修改， 保存样式文件并试验Rmd文件是否正确地利用了修改的样式。

为了实现自动编号， 先在正文中选中一个一级标题（不能是目录标题）， 从Word的主菜单栏找到“开始——段落——多级列表——定义新的多级列表”， 在打开的对话框中点击“更多”选项， 逐一地选择“单击要修改的级别”， 将级别1、2、3等分别修改， 主要是修改“将级别链接到样式”使得”级别1“与“标题1”对应， “级别2”与“标题2”对应，等等。 注意这个修改要一次性完成， 不能保存了文件后再次定义新的多级列表。

修改模板文件的页边距也会使得利用其为模板的Rmd文件转换结果被修改。 为了修改模板文件的页边距， 在主菜单“布局——页边距——自定义页边距”弹出的对话框中修改。

生成的目录的标题内容是“Table of Contents”， 目前只能对Rmd输出的docx文件直接修改， 修改模板文件的标题内容并不能使得Rmd输出被修改。

参考：Richard Layton的网站文章 https://rmarkdown.rstudio.com/articles_docx.html。

### 22.14.2 数学公式设置补充

如果不使用RStudio, R扩展包rmarkdown的`markdownToHTML()`函数可以把含有数学公式的内容转换成可显示公式的HTML文件， R扩展包knitr的`knit2html()`也可以实现此功能。 用rmarkdown扩展包的`markdownToHTML()`函数生成的含有数学公式的内容。

单独使用pandoc软件时， 也可以用普通文本编辑器在Markdown文件中输入LaTeX格式的数学公式， 然后用pandoc软件转化为带有数学公式的docx文件， 不需要额外选项。 但是，为了能够在转换的HTML文件中正常显示数学公式， 需要在运行Pandoc时增加运行选项`--maxjax`，如

```
  pandoc --mathjax -s -o test.html test.md
```

经试验，这样转化的HTML文件可以在Firefox以及Microsoft的 Edge浏览器和Internet Explorer浏览器中正常显示数学公式。 如果公式中的中文显示不正常， 对显示的公式右键单击弹出选项菜单， 选择“Math Settings–Math Renderer–SVG”或者“HTML-CSS”。

### References

Xie, Yihui, J. J. Allaire, and Garrett Grolemund. 2019. *R Markdown: The Definitive Guide*. CRC Press. https://bookdown.org/yihui/rmarkdown/.





# 23 用bookdown制作图书

## 23.1 介绍

R的bookdown扩展包(https://github.com/rstudio/bookdown) 是继knitr和rmarkdown扩展包之后， 另一个增强markdown格式的扩展， 使得Rmd格式可以支持公式、定理、图表自动编号和引用、链接， 文献引用和链接等适用于编写书籍的功能。 在bookdown的管理下一本书的内容可以分解成多个Rmd文件， 其中可以有可执行的R代码， R代码生成的文字结果、表格、图形可以自动插入到生成的内容中， 表格和图形可以是浮动排版的。 输出格式主要支持gitbook格式的网页图书， 这种图书在左侧显示目录， 右侧显示内容， 并可以自动链接到上一章和下一章； 通过单独安装的LaTeX编译器支持将书籍转换为一个PDF文件， 支持中文； 可以生成ePub等格式的电子书。

主要用于编写有多个章节的书籍， 也可以用来生成单一文件的研究报告。

建议使用RStudio集成环境制作这样的图书， 该软件内建了一键编译整本书的功能。 需要安装bookdown扩展包的最新版本。 bookdown扩展包现在还比较新， 还有一些BUG， 所以尽可能使用最新版的bookdown扩展包并且及时更新RStudio软件。 查看编译的网站建议使用Google Chrome浏览器， 此浏览器对gitbook的支持较好。

为了新写一本书或者从已有的书转换， 最简单的做法是从bookdown的网站下载bookdown配套的例书的zip文件 (见https://github.com/rstudio/bookdown-demo)， 将其解压到本地硬盘某个子目录， 然后修改其中的内容适应自己的书的需要。

因为中文需要一些特殊的设置， 以及在网络条件不好的条件下支持数学公式显示， 本书作者提供了一个粗浅的中文书bookdown模板， 下载链接为:

- [`Bookdown-template-v0-3.zip`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/Bookdown-template-v0-3.zip)。

## 23.2 一本书的设置

一本用bookdown管理的书， 一般放置在某个子目录下， 并作为一个RStudio项目(project)用RStudio管理。

也可以自己新建一个目录， 然后编辑生成必要的文件。 注意，所有的文本文件都要使用UTF-8编码。 一本bookdown书， 一般都需要有一个`index.Rmd`文件， 这是最后生成的网站的主页的原始文件， 可以在这个文件中写一些书的说明， 并在开头的YAML元数据部分进行有关设置， 如标题、作者、日期等。 `index.Rmd`的一个例子如下：

```
--- 
title: "统计计算"
author: "李东风"
date: "2019-08-29"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [myrefs.bib]
biblio-style: apalike
link-citations: yes
description: "本科生《统计计算》教材。采用R的bookdown制作，输出格式为bookdown::gitbook."
---
# 前言 {-}

统计计算研究如何将统计学的问题用计算机正确、高效地实现。
```

其中在三个减号组成的两行之间的内容叫做YAML元数据， 是一本书的设置， 上例中有书的标题、作者名、日期（用R程序自动生成）、描述。 其中的`site`选项很重要， 一定要有这个选项， `site: bookdown::bookdown_site`使得RStudio软件能辨认这是一个bookdown图书项目， 从而为其提供一键编译快捷方式。 元数据中`output`项指定默认的输出格式。 `documentclass`项为借助LaTeX编译PDF格式指定LaTeX的模板， 现在还不能支持ctexbook模板所以使用了book模板。 `bibliography`项指定一个或者几个.bib格式的文献数据库。

一个bookdown图书项目除了`index.Rmd`文件之外， 一般还应该有一个`_bookdown.yml`文件存放与整本书有关的YAML元数据。 例如

```
new_session: true
book_filename: 'statcompc'
language:
  label:
    thm: '定理'
    def: '定义'
    exm: '例'
    proof: '证明: '
    solution: '解: '
    fig: '图'
    tab: '表'
  ui:
    chapter_name: ''
delete_merged_file: true
```

其中`new_session: true`设置很重要， 这使得每一个Rmd文件中的R程序都在一个单独的R会话中独立地运行， 避免了不同Rmd文件之间同名变量和同名标签的互相干扰。 `book_filename`是最终生成的LaTeX PDF图书或者ePub电子书的主文件名。 `language`下可以定制一些与章节名、定理名等有关的名称。

另外一个需要的设置文件是`_output.yml`文件， 用于输出格式的设置。 这部分内容也可以包含在`index.Rmd`的元数据部分。 内容如

```
bookdown::gitbook:
  includes:
    in_header: mathjax-local.html
  config:
    toc:
      before: |
        <li><a href="http://www.math.pku.edu.cn/teachers/lidf/course/statcomp/_book/index.html">统计计算</a></li>
      after: |
        <li><a href="http://www.math.pku.edu.cn/teachers/lidf/" target="blank">编著：李东风</a></li>
    download: ["pdf"]
bookdown::pdf_book:
  includes:
    in_header: preamble.tex
  latex_engine: xelatex
  citation_package: natbib
  keep_tex: yes
bookdown::epub_book: default
```

其中的`style.css`是自定义的CSS显示格式， 可以去掉这一行，使用默认的CSS格式。 这个例子文件分为三部分， gitbook、pdf_book和epub_book三种输出格式分别设置了一些输出选项。 在gitbook部分， 设置了目录上方显示的书的主页的链接（`before`项）和目录下方显示的作者信息。 在`in_header`部分插入了一部分个性化的HTML代码， 这部分代码是使用本地的数学公式显示支持以免外网不同时数学公式不能显示， 插入的内容将出现在每个生成的HTML文件的head部分。

在`pdf_book`部分，设置了通过LaTeX编译整本书为PDF的一些选项。 指定了`latex_engine`为`xelatex`， 这对中文支持很重要。 `in_header`选项要求在LaTeX文件导言部分插入一个`preamble.tex`文件， 内容如：

```
\usepackage{ctex}

%\usepackage{xltxtra} % XeLaTeX的一些额外符号
% 设置中文字体
\setCJKmainfont[BoldFont={黑体},ItalicFont={楷体}]{新宋体}

\usepackage{amsthm,mathrsfs}
\usepackage{booktabs}
\usepackage{longtable}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother
```

其中很重要的是使用ctex包来支持中文。 在元数据中也可以指定一些LaTeX选项，比如指定页边距等：

```
classoption: twoside
fontsize: 12pt
linestretch: 1.5
geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
```

在bookdown项目中与`index.Rmd`同级的所有.Rmd文件都自动作为书的一章， 除非文件名以下划线开头。 这样做的好处是作者可以任意地增删章节， 编译整本书时章节编号会自动调整。 但是， 章节的顺序将按照文件名的字典序排列， 所以， 所有的包含一章内容的.Rmd文件， 最好命名为类似`0201-rng.Rmd`这样的名字， 文件名前面人为地加上排序用的序号， 使得章节按照自己的次序排列。 实际上， 也可以设置不自动将每个.Rmd文件都作为一章， 而是在`_output.yml`中设置一项`rmd_files`， 列出所有需要作为一章的文件，并以列出次序编译，如

```
rmd_files: ["index.Rmd", "rng.Rmd", "simulation.Rmd", "refs.Rmd"]
```

这时，应该添加一个`_site.yml`文件，内容如：

```
site: "bookdown::bookdown_site"
output: bookdown::gitbook
```

## 23.3 章节结构

除了`index.Rmd`文件， 项目中每个.Rmd文件都作为一章。 每个.Rmd文件第一行， 应该是以一个井号和空格开头的一级标题， 后面再加空格然后有大括号内以井号开头的章标签， 如

```
# 随机数 {#rng}
```

这些章标签去掉井号后会作为生成的HTML文件的名字， 所以一定要有章标签， 而且章节标签在全书中都不要重复以免冲突。 文件内可以用两个井号和一个空格开始的行表示节标题， 最后也应该有大括号内以井号开头的节标签，如

```
# 随机数 {#rng}

## 均匀随机数发生器 {#rng-unif}
```

使用bookdown写书， 一般每章不要太长， 否则编译预览很慢， 读者浏览网页格式也慢。

内容相近的章节可以作为一个“部分”。 为此， 在一个部分的第一个章节文件的章标题前面增加一行， 以`# (PART)`开头， 以`{-}`结尾， 中间是部分的名称，如

```
# (PART) 随机数和随机模拟 {-}

# 随机数 {#rng}
```

书的最后可以有附录， 附录的章节将显示为`A.1`, `B.1`这样的格式。 为此， 在附录章节的第一个文件开头加如下前两行的标题行：

```
# (APPENDIX) 附录 {-}
# (PART) 附录 {-}

# 一些定理的证明 {#formula}
```

## 23.4 书的编译

建议使用RStudio软件编辑内容， 管理和编译整本书。

在`index.Rmd`或者`_bookdown.yml`中设置`site: bookdown::bookdown_site`后， RStudio就能识别这个项目是一个bookdown项目， 这时RStudio会有一个Build窗格，其中有“Build book”快捷图标， 从下拉菜单中选择一个输出格式（包括gitbook、pdf_book、epub_book）， 就可以编译整本书。 对gitbook格式， 即HTML网页格式， 编译完成后会弹出一个预览窗口， 其中的“Open in Browser”按钮可以将内容在操作系统默认的网络浏览器中打开。

另一种办法是在命令窗口用如下命令编译（以输出gitbook为例）， 我个人认为这种办法更好用：

```
bookdown::render_book("index.Rmd", 
  output_format="bookdown::gitbook", encoding="UTF-8")
```

编译结果默认保存在`_book`子目录中， 可以在`_bookdown.yml`中设置`output_dir`项改为其它子目录。 编译整本书为pdf_book格式时，如果成功编译， 也会弹出一个PDF预览窗口。 可以在`_book`子目录中找到这个PDF文件。

将书编译为PDF需要利用LaTeX编译器， 这需要单独安装LaTeX编译软件， 如Windows下的CTEX套装软件。 LaTeX编译器对输入要求十分严格， 一丁点儿错误都会造成整本书的编译失败， 所以对于不熟悉LaTeX的用户， 不建议使用bookdown的pdf_book输出格式。 如果仅在R Markdown中使用LaTeX编译器， 可以安装谢益辉的[TinyTeX](https://yihui.name/tinytex/)。

对于较短的书， 做了一定修改后都可以重新编译gitbook结果和pdf_book结果。 在书比较长了以后， 每次编译都花费很长时间， 所以可以仅编译gitbook格式的一章， 修改满意后再编译整本书。 仅编译一章也需要所有的.Rmd文件都是已经编译过一遍的， 新增的Rmd文件和图形文件会使得编译单章出错， 每次新增了Rmd文件和图形文件都应该重新编译整本书， 但是内容修改后不必要重新编译整本书， 可以仅编译单章。

编译单章现在没有快捷图标， 只能在RStudio控制台（命令行）运行如下命令：

```
bookdown::preview_chapter("chap-name.Rmd", 
  output_format="bookdown::gitbook", encoding="UTF-8")
```

其中`chap-name.Rmd`是要编译的单章的文件名。 编译完成后在结果目录（默认是`_book`）中找到相应的HTML文件打开查看， 再次编译后仅需在浏览器中重新载入文件。 建议使用Google chrome浏览器， 用MS IE或者Edge浏览器对gitbook的Javascrpt支持不够好， 使得目录的层级管理、自动滚动、单章编译后的目录更新不正常， 而chrome则没有问题。

编译单章也不能解决所有的问题， 有些问题还是需要编译整本书， 而章节很多时整本书编译又太慢。 为此， 可以在项目中增加一个临时的部分内容子目录， 如`testing`子目录， 在子目录中存放相同的设置文件`index.Rmd`、`_bookdown.yml`、`_output.yml`， 以及图形文件、文献数据库文件， 并将要检查的若干章节复制到`testing`子目录中， 在`testing`中新建一个bookdown项目， 然后编译其中的整本书。 这在调试部分章节的HTML和PDf输出时很有效。 解决问题后主要将修改过的章节复制回原始的书的目录中。

有时仅仅想验证某个长数学公式或者表格， 用上述的编译单章或者单独一个小规模测试项目的办法也不经济。 这时，单独开一个备用的普通RStudio项目， 不能是bookdown项目， 在其中的Rmd文件中验证数学公式和表格的编排， 这样效率最快了。

## 23.5 交叉引用

在写作时，每个一级到三级标题都应该有自定义的标签， 格式是在标题行末尾空格后添加`{#label}`， 其中label是自己指定的标签， 使用英文、数字、减号， 不要使用中文， 而且整本书不要有重复的标签。 为避免不同章节使用了重复标签， 可以取`label`的前一部分为所在章节的文件名。

如果要引用某一章节， 有如下的做法：

- `§\@ref(label)`，`label`是某个标题对应的标签。 结果显示为如`§3.1.1`这样的章节号，并可点击， 点击时跳跃到相应的章节。
- `[链接文本](#label)` 其中`label`是某个标题对应的标签。 结果产生一个链接，显示为`链接文本`，点击时跳到`label`对应的章节。

## 23.6 数学公式和公式编号

通过R的knitr和rmarkdown扩展包， .Rmd格式文件已经支持数学公式， 见[R Markdown说明](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html)。

在用`$$`符号在两端界定的公式后面， 可以用`\tag{标号}`命令增加人为的公式编号，如

```
$$
y = f(x)
\tag{*}
$$
```

结果显示为







要注意的是， 在`$$`界定的数学公式内用了aligned环境后， 仅能在`\end{aligned}`之后加`\tag{标号}`命令， 而不能写在aligned环境内。 这样， 多行的公式将不能为每行编号。

用`\tag`命令人为编号比较简单易用， 但是在有大量公式需要编号时就很不方便， 只要增加了一个公式就需要人为地重新编号并修改相应的引用。 bookdown包支持对公式自动编号， 并可以按公式标签引用公式， 引用带有超链接。

bookdown的自动编号对LaTeX的equation环境、align环境都可以使用， 而且不需要在两端用`$$`界定。 在公式的末尾或者一行公式的`\\`换行符之前， 写`(\#eq:mylabel)`， 其中`mylabel`是自己给公式的文字标签， 文字标签可以使用英文字母、数字、减号、下划线。 如

```
\begin{align}
f(x) =& \sum_{k=0}^\infty \frac{1}{k!} x^k (\#eq:efunc-sum) \\
  = e^x (\#eq:efunc-ex)
\end{align}
```

将会对两行公式自动编号。 引用公式时， 用如`\@ref(eq:mylabel)`，其中`mylabel`是公式的自定义标签， 编译后这样的引用会变成带有链接的圆括号内的编号。

公式编号在全书中都不要有冲突（不同的公式定义了相同的编号）。 一种办法是，自定义的公式标签的开头以章节文件名开头。

## 23.7 定理类编号

定理、引理、命题、例题等， 使用特殊的markdown代码格式， 以三个反单撇号开头， 以三个反单撇号结尾， 在开头的三个反单撇号后面写`{theorem}`表示定理。 在`theorem`后面，用逗号分隔后写一个定理的自定义标签， 因为现在bookdown的功能还不完善， 所以所有的定理类都应该自定义一个标签。 可以用`name="定理名称"`指定一个显示的定理名。 标签也可以写成`label="mythlabel"`，其中`mythlabel`是自定义的标签。

设某个定理的自定义标签是`mythlabel`， 则可以用如`\@ref(thm:mythlabel)`引用此定理的编号， 编号有自动生成的链接。

例如：

```
``{theorem norlim-weakconv, name="弱收敛"}
$\xi_n$依分布收敛到$\xi$，
当且仅当对任意$\mathbb R$上的一元实值连续函数$f(\cdot)$都有
$$
  E f(\xi_n) \to E f(\xi), \ n \to \infty
$$
​```
```

当定理或例子内有列表时， 一定注意列表前后要空行， 否则会导致嵌套错误。 这种错误在编译HTML时无法发现， 但是会造成结果莫名其妙地出错。

bookdown提供了证明环境， 但是不太实用。

对例题， 将`theorem`替换成`example`， 在引用时将`thm`替换成`exm`。 如：

```
``{example noralim-aspr-ce, name="依概率收敛不a.s.收敛反例"}
a.s.收敛推出依概率收敛，
但是反之不然。给出反例。
​```
```

## 23.8 文献引用

bookdown使用.bib格式的文献数据库， 关于.bib格式的文献数据库请参考LaTeX的有关说明。 在`index.Rmd`的YAML元数据部分或者`_bookdown.yml`中用`bibliography`可以设置使用的一个或者多个.bib格式的文献数据库文件。 设某篇文章的.bib索引键是`Qin2007:comp`， 用 `@Qin2007:comp` 可以引用此文献， 用`[@Qin2007:comp]` 可以生成带有括号的引用， 引用都有超链接。

指定.bib文件时可以用相对路径， 如“`../docs/mybib.bib`”。

下面是一个样例.bib文件的内容（主要要用UTF-8编码保存）：

```
% Encoding: UTF-8

@Book{MWP06-HighStat,
  author    = {茆诗松 and 王静龙 and 濮晓龙},
  title     = {高等数理统计},
  year      = {2006},
  edition   = {第二版},
  publisher = {高等教育出版社}
}


@BOOK{Unwin-Visualize06,
  title = {Graphics of Large Datasets Visualizing a Million},
  publisher = {Springer},
  year = {2006},
  author = {Antony Unwin and Martin Theus and Heike Hofmann}
}


@Article{Wichmann1982:RNG,
  author  = {Wichmann, B. A. and Hill, I. D.},
  title   = {Algorithm as 183: An efficient and portable pseudo-random number generator},
  journal = {Applied Statistics},
  year    = {1982},
  volume  = {31},
  pages   = {188–190. Remarks: 34, 198 and 35, 89},
}

@Book{QGCZ2011:StochProc,
  author    = {钱敏平 and 龚光鲁 and 陈大岳 and 章复熹},
  title     = {应用随机过程},
  year      = {2011},
  publisher = {高等教育出版社},
}
```

## 23.9 插图

bookdown图书的插图有两种， 一种是已经保存为图形文件的， 主要是png、jpg和pdf图片； 另一种是文中的R代码生成的图形。

已经有图形文件的， 可以用markdown格式原来的插图方法， 见[markdown格式介绍](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/markdown.html)。 但是，这样做不能给图形自动编号， 另外因为制作图书是有网页和PDF书两种主要输出格式的， 原有的插图方式在这两种输出格式上有细微的不一致。 所以，最好是统一使用Rmd的插图方法。

Rmd的插图方法就是写一段R代码段来插图， 如果是用程序作图，则代码中写作图的代码； 如果是已有的图形文件， 可以在一个单独的R代码段中用类似下面的命令插图：

```
knitr::include_graphics("figs/myfig01.png")
```

其中`figs`是存放图形文件的子目录名， `myfig01.png`是要插入的图形文件名。 这样， 如果同时还有`myfig01.pdf`的话， 则HTML输出使用png图片而PDF输出自动选用pdf文件。 另外， 插图的选项在代码段的选项中规定： 用代码段的`fig.with`和`fig.height`选项指定作图的宽和高（英寸）， 用`out.width`和`out.height`选项指定在输出中实际显示的宽和高， 实际显示的宽和高如果使用如`"90%"`这样的百分数单位则可以自动适应输出的大小。

为了使得插图可以自动编号并可以被引用， 为代码段指定标签并增加一个`fig.cap="..."`选项指定图形标题。 代码段的标签变成浮动图形的标签，如`myfiglabel`， 则为了引用这个图只要用`\@ref(fig:myfiglabel)`。 注意，在整本书中这些标签都不能重复， 否则编译LaTeX支持的PDF输出会失败。

有些插图会伴随很长的说明文字， 这可以用代码段的`fig.cap=`选项指定， 但是其中的Markdown特有的格式在转换LaTeX时不一定支持， 而且在代码段选项中写太长的文字说明也是的程序难以辨认。 所以， 可以使用文字引用的方式： 在单独的一段中， 用如下格式定义一段可引用的文字内容：

```
(ref:mylabel) 这里用实际的文字内容代替，
可以有多行，不能分段。
```

其中`mylabel`是自己定义的仅由英文大小写字母、数字和减号组成的引用标志符。在需要使用这段文字的位置，用`(ref:mylabel)`这种格式引用。 注意定义和引用都是用的`(ref:mylabel)`语法。

由于PDF中中文不能自动识别， 所以在每个源文件的开头应该加上如下的设置， 使得生成PDF图时中文能够正确显示：

```
​```{r setup-pdf, include=FALSE}
pdf.options(family="GB1")
​```
```

其中`include=FALSE`表示要不显示代码段的代码， 有运行结果也不插入到输出结果中， 是否允许运行视缺省的`eval=`的值而定。

## 23.10 表格

bookdown书的表格也有两种， 一种是原来markdown格式的表格， 最好仅使用管道表， 管道表对中文内容支持最好。 为了对这样的表格自动编号， 需要在表格的前面或者后面空开一行的位置， 写

```
Table: (\#tab:mylabel) 表的说明 
```

其中`mylabel`是自定义的表格标签。 在引用这个表时用如 `\@ref(tab:mylabel)`。

另一种表格是R代码生成的表格， 主要使用`knitr::kable()`函数。 在`knitr::kable()`函数中用选项`caption=`指定表格的说明文字（标题）， 这时生成表格的R代码段的标签，如`myfiglab`， 就自动构成了表格的引用标签主干， 实际引用如 `\@ref(tab:myfiglab)`。

为了适应较长的表， 可以在LaTeX的`preamble.tex`中引入longtable包， 并在`knitr::kable()`中加选项`longtable=TRUE`。

## 23.11 数学公式的设置

bookdown在生成PDF时使用LaTeX软件， 所以PDF输出的数学公式的支持很好， 但是LaTeX编译器也很挑剔， 稍微一点错误也造成编译失败。 比如，在行内公式内部如果紧邻`$`符号有多余的空格， 如`$ y $`，编译PDF时会出错。

bookdown 0.6版生成的gitbook格式的网页书籍， 在有数学公式时， 使用MathJax库在浏览器中显示数学公式。 MathJax是用于网络浏览器中显示数学公式的优秀的Javascript程序库， 可免费使用。 但是， 当数学公式中含有中文（用`\text{}`或`\mbox{}`命令）时， 数学公式可能会显示不正常。 另外，数学公式默认使用远程服务器上的MathJax程序库处理， 在网络不通畅时显示很慢或者无法显示。

MathJax有多种渲染输出选择， gitbook的模板中已经固化了一种CommonHTML， 这种输出与gitbook的`style.css`配合，当中文公式在`section`标记内时， 使得中文显示不正常。 如果不修改gitbook的模板， 通过在`_output.yml`设置文件中插入设置命令的办法不奏效， 因为gitbook的模板是动态调入MathJax库的， 不能在HTML文件头或尾插入静态设置命令修改输出格式。

为此， 直接修改bookdown包中的gitbook.html模板， 删去文件末尾动态调入MathJax的部分， 改为在`_output.yml`中要求调入一个设置文件。 但是，bookdown的0.9版本已经没有这个问题， 不需要人为修改bookdown包的gitbook.html模板了。

为了避免远程调用MathJax程序库的麻烦， 改为本地使用。 将MathJax安装在了书生成的网站主目录的上三层，用`../../../MathJax/mathjax.js`路径访问。 假设下载整个MathJax库后解压放在了书的网页文件所在子目录的上三层的位置。

增加设置文件`_header.html`：

```
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX","output/SVG"],
  extensions: ["tex2jax.js","MathMenu.js","MathZoom.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
  }
});
</script>
<script type="text/javascript"
   src="../../../MathJax/MathJax.js">
</script>
```

如果希望用远程服务器上的MathJax，可以使用如下的`mathjax-cdnjs.html`设置文件：

```
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX","output/HTML-CSS"],
  extensions: ["tex2jax.js","MathMenu.js","MathZoom.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
  }
});
</script>
<script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js">
</script>
```

为了调用这样的设置文件，在`_output.yml`设置文件中如下设置：

```
bookdown::gitbook:
  css: style.css
  includes:
    in_header: _header.html
```

注意，MathJax要求先设置再调入。 由于浏览器对MathJax输出方式有记忆， 所以如果不能正常显示中文公式， 需要右键单击公式，选择“Math Settings—Math Renderer”中的“SVG”或者“HTML-CSS”。

## 23.12 使用经验

Ed Berry在网上分享了用bookdown生成PDF学位论文的经验： https://eddjberry.netlify.com/post/writing-your-thesis-with-bookdown/ 。 Chester Ismay提供了一个R扩展包thesisdown， 见 https://github.com/ismayc/thesisdown， 例子见https://thesisdown.netlify.com/。

有数学公式时， 对行内公式边缘处多余的空格十分敏感， 所以行内公式边缘不要有空格。

如果已经有用LaTeX写的书， 要转换为bookdown的Rmd格式， 可以用RStudio的支持RegEx的替换模式，如

- `\\keyword{([^}]+?)}`替换成`**\1**`。
- `\\textbf{([^}]+?)}`替换成`**\1**`。
- `\\texttt{([^}]+?)}`替换成`\1`。

可以写一个函数对LaTeX文件进行转换生成Rmd文件， 再手工修改。函数如

```
latex2rmd <- function(fname="_tmp/tomd.tex", encoding="UTF-8"){
  lines <- readLines(fname, encoding=encoding)
  if(encoding != "UTF-8")
    lines <- iconv(lines, from=encoding, to="UTF-8")
  print(head(lines, 10))
  lines <- gsub("\\\\keyword[{]([^}]+?)[}]", "**\\1**", lines, perl=TRUE)
  lines <- gsub("\\\\textbf[{]([^}]+?)[}]", "**\\1**", lines, perl=TRUE)
  lines <- gsub("\\\\texttt[{]([^}]+?)[}]", "`\\1`", lines, perl=TRUE)
  lines <- gsub("\\\\label[{](eq:[^}]+?)[}]", "(\\\\#\\1)", lines, perl=TRUE)
  lines <- gsub("\\\\eqref[{]([^}]+?)[}]", "\\\\@ref(\\1)", lines, perl=TRUE)
  lines <- gsub("\\\\bs\\\\", "\\\\boldsymbol\\\\", lines, perl=TRUE)
  lines <- gsub("\\\\bs ", "\\\\boldsymbol ", lines, perl=TRUE)
  lines <- gsub("\\\\Rbb", "\\\\mathbb R", lines, perl=TRUE)
  lines <- gsub("\\\\Zbb", "\\\\mathbb Z", lines, perl=TRUE)
  lines <- gsub("\\\\Var[(]", "\\\\text\\{Var\\}(", lines, perl=TRUE)
  lines <- gsub("\\\\Cov[(]", "\\\\text\\{Cov\\}(", lines, perl=TRUE)
  lines <- gsub("(\\\\S)(\\d)", "§\\2", lines, perl=TRUE)
  lines <- gsub("(\\\\S) ", "§ ", lines, perl=TRUE)
  lines <- gsub("(\\\\defeq)", "\\\\stackrel{\\\\triangle}{=}", lines, perl=TRUE)
  lines <- gsub("\\\\argmin_", "\\\\mathop{\\\\text{argmin}}_", lines, perl=TRUE)
  lines <- gsub("^\\s*\\\\item", "*", lines, perl=TRUE)
  lines <- gsub("\\\\begin[{]frame[}]", "", lines, perl=TRUE)
  lines <- gsub("\\\\end[{]frame[}]", "", lines, perl=TRUE)
  lines <- gsub("\\\\begin[{]itemize[}]\\[<\\+->\\]", "", lines, perl=TRUE)
  lines <- gsub("\\\\end[{]itemize[}]", "", lines, perl=TRUE)
  lines <- gsub("\\\\begin[{]itemize[}]", "", lines, perl=TRUE)
  lines <- gsub("\\\\bm ", "\\\\boldsymbol ", lines, perl=TRUE)
  lines <- gsub("\\\\bm\\\\", "\\\\boldsymbol\\\\", lines, perl=TRUE)
  lines <- gsub("\\\\tr[(]", "\\\\text{tr}(", lines, perl=TRUE)
  lines <- gsub("\\begin{align*}", "$$\\begin{aligned}", lines, fixed=TRUE)
  lines <- gsub("\\end{align*}", "\\end{aligned}$$", lines, fixed=TRUE)
  
  print(head(lines, 20))
  ##writeLines(lines, "_tmp/fromtex-clean.Rmd")
  con1 <- file("_tmp/fromtex-clean.Rmd", "wt", encoding="UTF-8")
  writeLines(lines, con=con1)
  close(con1)
}
```

Rmd格式对算法编排的支持不够好。 编排算法可以用表格来换行， 仍用`\qquad`和`\qquad`缩进， 不要用空格缩进，因为在LaTeX转PDF时空格会损失。 但是算法内容中有公式含有竖线时还是无法与表格线区分开来。

编排算法也可以用数学公式， 写在`$$`界定范围内， 用aligned环境分行， 缩进使用`\quad`和`\qquad`。 只是无法对`if`这样的关键字用重体排印。

为了能够生成中文的PDF，不要指定doclass为ctexbook， 而是指定为book，然后在`preamble.tex`中引入`ctex`包。

为了PDF输出，不要引入太多的数学包， 因为从markdown到HTML不支持复杂的数学。

用R作图时如果图形中有汉字， 在代码块选项中加上`dev="png", dpi=300`。 否则生成PDF时会有中文编码问题。 另一办法是在每个.Rmd文件开头的setup源代码段插入

```
pdf.options(family="GB1")
```

这样可以生成支持中文字的PDF图形。

在编译出错时，会在主目录留下编译的tex源文件及相关文件。 但是，此tex源文件中使用的R生成的图片路径不对， 需要将tex源文件复制到`bookdown_files`目录， 将直接插入的图片也复制到这个目录， 然后编译tex文件发现问题，逐个修复。 建议建立小的测试项目专门调试有问题的文件。

连分数的加号是`\genfrac{}{}{0pt}{}{}{+}`。

## 23.13 bookdown的一些使用问题

- 在数学公式中用`\text{\@ref(eq:label)}`引用公式，HTML成功， LaTeX版本会有BUG，重复了`\`。 如果使用文内的链接，则LaTeX成功， HTML不成功。
- YAML部分有的中文文字（如作者名）会出错， 代以ASCII则不出错。
- example的自动编号有问题，不加label的example， 其HTML结果在不同章之间会编号混淆， 避免问题的临时办法是example都加上label。
- 用本地文件格式提供的下载文件不能用中文文件名。













# 24 用R Markdown制作简易网站

## 24.1 介绍

为了从多个.Rmd源文件制作网站， 可以使用blogdown扩展包或者bookdown扩展包。 bookdown扩展包可以生成gitbook格式的网站， 带有左侧的章节目录和前后页面的导航链接， 很适用于一本书的网站。 但是， bookdown使用时需要重新编译整个网站才能产生正确的链接。

也可以仅利用rmarkdown包的`render.site()`功能制作简易的网站。

## 24.2 简易网站制作

一种简易的制作网站的办法是仅仅利用rmarkdown包的`render.site()`功能。 为了使得rmarkdown和RStudio将一个子目录（项目）看成一个网站项目， 只要此项目中含有`index.Rmd`和`_site.yml`文件。 所有网页.Rmd源文件都必须在项目的顶级目录中。 只要将编译所得的网站目录上传到任意的网站服务器就可以发布到网上。

### 24.2.1 网站结构

`index.Rmd`是主页内容， 可以在此处人工加入其它页面链接（参见markdown格式说明中链接写法）， 也可以制作单独的目录页面。 内容如

```
---
title: "概率论"
---
* [概率分布](dist.html)
* [期望](expect.html)
```

`_site.yml`是一个YAML文件， 其中包含站点的设定和输出设定。 内容如

```
name: "概率论"
output_dir: "_probbook"
output:
  html_document: 
    toc: true
    mathjax: "../../../MathJax/MathJax.js"
    self_contained: false
    includes:
      in_header: "_header.html"
navbar:
  title: "概率论"
  left:
    - text: "Home"
      href: index.html
    - text: "About"
      href: about.html
```

这里`name`设置站点名称， `output_dir`给出生成的html及其他辅助文件的存放目录，缺省时用`_site`子目录。 navbar域设置了网站的菜单，这里包括Home(主页), Contents(目录), About(关于)三个页面的导航菜单。 output域设定输出的选项， 其中`html_document`就是用`rmarkdown::render_site()`生成的网站的输出文件格式， 其中`toc: true`说明每个页面都有自身内容的目录, 关于`mathjax`, `self_contained`, `includes`都与数学公式设置有关， 这里设置数学公式使用与本网站在同一目录系统或同一网站地址存放的MathJax数学公式显示库， 该库放在生成的HTML文件所在目录向上两层的MathJax子目录中。 `in_header`指定一个要插入到生成的每个HTML的head部分的内容文件， 这里内容文件`_header.html`的内容是

```
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX","output/SVG"],
  extensions: ["tex2jax.js","MathMenu.js","MathZoom.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
  }
});
</script>
```

是对MathJax的一些设置，主要使用LaTeX作为输入格式。

### 24.2.2 编译

具有`index.Rmd`和`_site.yml`文件的项目， 在RStudio软件中会显示一个Build窗格， 点击其中的`Build Website`可以自动调用`rmarkdown::render_site()`生成整个站点， 存放在`output_dir`指定的输出目录中，默认目录名为`_site`。 为了将生成的站点发布到网站， 只要将输出目录的所有内容全部复制到服务器的某个子目录中就可以了。

`rmarkdown::render_site()`生成整个站点时会自动逐个编译.Rmd文件， 并将项目目录中其它的文件和子目录复制到输出目录中， 以句点或者下划线开头的文件和子目录不复制， .R, .r, .Rmd文件不复制。

因为是自动依次编译所有的.Rmd文件， 所以中间某个源文件编译错误就会使得整个编译失败， 修正错误后还是需要再次编译所有文件， 这一点不太方便。 但是，`rmarkdown::render_site()`提供了这样一种操作模式： 将有错的文件先移动到其它目录中， 编译整个站点，这时生成的站点仅包含确认无误的各个页面； 然后， 再将可能有错的文件移动回到项目目录， 逐个地打开每个未成功编译的文件， 用`Knit`按钮单独编译， 编译成功后结果文件也自动进入输出目录。

RStudio的Knit按钮或者`rmarkdown::render_site()`命令可以人工控制一个一个地编译.Rmd文件， 编译成功一个就存放到输出目录中一个， 这是用`rmarkdown::render_site()`制作网站比用bookdown扩展包制作网站的一个优点。 因为网站的目录是自己编写的链接， 所以这样逐个编译不会破坏网站的链接。 编译单个文件的命令如

```
rmarkdown::render_site("sec1.Rmd", output_format = "html_document", encoding="UTF-8")
```

其中`sec1.Rmd`是某个网页内容源文件。

可以用`rmarkdown::clean_site()`删除生成的文件， 包括程序结果缓存。

如果用bookdown包， 只有编译所有文件才能生成正确的网站目录， bookdown也能编译单个文件， 但是仅能作为调试， 调试成功后还是需要编译所有文件才能使得网站目录正确。

bookdown站点的优势在于自动生成网站目录而不需要人工管理目录， 而且bookdown支持图书的公式、定理、图标自动编号和链接， 文献列表和文献引用， 所以bookdown是比`rmarkdown::render_site()`编译调试速度比较慢但是功能更强大的一种制作网站的工具， 而且还可以生成PDF版图书。

所以，一本书如果不需要很多的公式自动编号、图表编号、文献， 在编写阶段可以使用`rmarkdown::render_site()`制作， 定稿后再改成bookdown图书格式， 实际上每个源文件内容部分不需要改变， 只需要修改一下头部就可以了。 站点的设置需要将`_site.yml`中的`site`域的值改为`bookdown::bookdown_site`， 并增加`_bookdown.yml`和`_output.yml`两个设置文件。 详见[23](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/bookdown.html#bookdown)。

### 24.2.3 内容文件

内容文件只要用普通的Rmd文件即可，如某一网页的源文件如

```
---
title: "期望"
---
随机变量**数学期望**可以看成是对随机变量取值的加权平均，
某个值的取值概率越大，加权越大。

对离散随机变量，
期望是加权和；
对连续型随机变量，
期望是用密度函数加权对`x`积分。
```

### 24.2.4 网站设置

在`_site.yml`文件中进行网站设置， 样例见[24.2.1](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmdsite.html#rmdsite-rmarkdown-struct)。 顶级设置有：

- `name`: 网站名称；
- `output_dir`: 保存编译结果的子目录名，默认为`_site`， 如果设置为`.`，则表示编译结果放在项目的顶级目录中而不是子目录中；
- `includes`: 指定输出的网站中要包含的文件， 输出时默认不包含.R，.r, .Rmd，.RData, .rds文件和文件名以小数点或者下划线开头的文件， 所以例外要写在这里， 如`includes: ["data1.R", "data2.R"]`;
- `excludes`: 指定项目中不希望输出的结果网站的文件， 可以有通配符，如 `excludes: ["backup.txt", "*.xlsx"]`;
- `output`: 其中的`html_document`属性的设置是所有Rmd网页源文件的共同设置， 参见[22.11.3](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#rmd-output-attr)， 每一个Rmd文件本身也可以有自己的属性设置；
- `navbar`: 用来设置导航菜单，属性`left`指定主菜单栏， 根据所用的网站主题，可能显示在左侧或者顶部。 属性`right`指定一个右侧导航栏。

`includes`和`excludes`设置主要是为了改变默认的文件发布规则， 所有的.Rmd文件只要不是文件名以下划线开头就都会被编译并且复制到结果子目录中。

## 24.3 用blogdown制作网站

R扩展包blogdown可以与Hugo软件配合制作简单的静态网站。 网站的所有文件都存在于一个目录中， 只要上传到任意的网站服务器就可以发布， 没有任何限制。

网站内容用R Markdown格式编写， 在R或者RStudio中编译为网站。 这样的做法使得网站内容容易再现， 而且也可以将内容转换为PDF、Word等格式。 blogdown包的R Markdown格式支持bookdown包的扩充， 如公式、图表编号与引用。

blogdown包的名称虽然包含了blog， 但是其建站并不限于博客类型， 任何类型的静态网站都可以构建， 比较适合的是个人网站。

参考：

- (Yihui Xie [2017](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmdsite.html#ref-Xie2017:blogdown))
- (Xie, Allaire, and Grolemund [2019](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmdsite.html#ref-Xie2019:rmarkdown))

### 24.3.1 生成新网站的框架

在RStudio中， 菜单“File – New Project – blogdown site”可以生成一个网站框架， 注意一定要新建目录而不是用已有目录， 而且第一次新建网站时还会自动下载Hugo静态网站生成程序。

生成的网站框架包括如下文件与子目录：

- index.Rmd：主页面的源文件。
- config.toml: 网站设置文件。
- ./content/: 存放作为网站内容的md或者Rmd文件。可以在下面再建立子目录。 ./content/post/用来保存博客类型的网页，但是不做要求。
- ./resources:
- ./static: 保存图片、CSS等文件，在发布网站时会被复制到./public子目录中。
- ./themes: 存放多个网站主题。
- ./public: 发布网站时所用到的所有文件。 生成的内容被复制到这个目录中。 只要将这个目录的内容全部复制到任何一个支持静态内容的网站服务器， 就可以发布网站。

这样建站， 建成的网站应该在RStudio的Viewer窗格自动显示， 如果没有自动显示网站或者再次打开网站项目， 点击图标栏的`Addins -- Serve site`可以启动网站服务器发布该网站。 或者用用命令

```
blogdown::serve_site()
```

启动网站服务器。 每次在RStudio或者R中打开一个网站项目， 都只需要启动一次服务器。 blogdown的服务器会在后台运行， 侦测到文件修改时会自动重建， 这称为在线重建(Live Reload)。 在线重建功能基于R扩展包servr。 所以用户只要发布新的消息或者修改已有消息， 不用关心后台的转换问题。

blogdown提供了一些RStudio的addin程序， 可以为网站功能提供方便， 比如`New Post`可以生成新消息， `Update Metadata`可以修改消息的YAML元数据， `Insert Image`可以在消息中插入图片。

使用在线重建功能时， 应关闭一些其他功能。 在RStudio的“Tools – Project Options – Build Tools”对话框中， 取消选定“Preview site after building”和“Re-knit current preview when supporting files change”。

如果不使用在线重建功能， 即不使用Serve site， 可以在RStudio的Build窗格中用“Build Book”功能手工控制网站的重建。

### 24.3.2 网页内容文件及其设置

网页内容文件可以用Rmd文件也可以用md文件， 但是Rmd文件使用Pandoc和bookdown包支持的文件格式， 功能更强， 比如支持LaTeX数学公式， 公式、图表自动标号与交叉索引，等等， 所以最好是用Rmd文件。

如果有某个Rmd源文件暂时不想编译输出， 可以将其扩展名临时改为一个不被编译的扩展名如.txt。

blogdown编译结果的网页是HTML格式， 其Rmd元数据输出类型为`blogdown::html_page`， 此类型基于`bookdown::html_document2`， 又基于`rmarkdown::html_document`。 这样，可以在Rmd源文件的元数据部分对该输出类型设置相应的属性， 如`toc: true`等。 例子：

```
---
title: "一个试验网页"
author: "李东风"
date: "2019-07-08"
output:
  blogdown::html_page:
    toc: true
    fig_width: 6
    dev: svg
---
```

为了给所有输出设置统一的属性， 可以在项目目录中添加`_output.yml`文件， 在其中设置输出文件的各种属性，如：

```
blogdown::html_page:
  toc: true
  fig_width: 6
  dev: svg
```

### 24.3.3 初学者的工作流程

Hugo建站程序比较复杂， 如果要挑选自己喜爱的网站主题(theme)， 移植网站也比较麻烦。 对于了解网站技术不多的建站者， 建议用如下的流程建立新站：

- 在https://themes.gohugo.io/仔细地挑选一个合适的网站主题(theme)；
- 在RStudio中通过生成一个在已有目录的新项目；
- 在新项目的控制台中提交命令`blogdown::new_site(theme = 'user/repo')`， 其中`user/repo`是前面所选的主题的用户名与资源(repository)名；
- 试验新网站看是否满意。 如果不满意可以重复以上步骤， 如果满意， 就可以修改`config.toml`中的设置。 如果某个选项不明白， 可以在该主题的文档中查找， 通常是资源的README文件。 只需要修改必须需改的选项。

为修改已有网站内容， 用如下的步骤：

- 点击RStudio的addin “Serve Site”， 可以在修改过程中动态地构建网站。 每次打开RStudio的网站项目仅需执行一次这个命令。
- 用“New Post” addin添加新的网页。
- 在修改某个网页时，用“Update Metadata” addin修改网页元数据， 主要是网页标签等。

为了发布网站， 只要将项目内的public目录上传到任一支持静态内容的网站服务器。 如果没有合适的服务提供商， 可以考虑https://www.netlify.com/， 可以用Github账户登录并有一定的免费建站服务。 如果熟悉Github， 还可以将自己的网站源文件作为一个Github 资源(repository)， 将Github资源发布到Netlify， 就不需将public的内容上传到网站， 而只要有源文件就可以了， Netlify支持Hugo。

### 24.3.4 网站设置文件

在项目根目录中有一个`config.toml`文件， 是Hugo软件的建站设置文件， 可以设置网站标题、描述、菜单等。 一个例子如下：

```
baseurl = "/"
languageCode = "en-us"
title = "试验Blogdown网站"
theme = "hugo-lithium"
googleAnalytics = ""
disqusShortname = ""
ignoreFiles = ["\\.Rmd$", "\\.Rmarkdown$", "_files$", "_cache$"]

[permalinks]
    post = "/:year/:month/:day/:slug/"

[[menu.main]]
    name = "About"
    url = "/about/"
[[menu.main]]
    name = "Li Dongfeng Homepage"
    url = "http://www.math.pku.edu.cn/teachers/lidf/"

[params]
    description = "用Hugo和blogdown制作的网站"

    # options for highlight.js (version, additional languages, and theme)
    highlightjsVersion = "9.12.0"
    highlightjsCDN = "//cdnjs.cloudflare.com/ajax/libs"
    highlightjsLang = ["r", "yaml"]
    highlightjsTheme = "github"

    MathJaxCDN = "//cdnjs.cloudflare.com/ajax/libs"
    MathJaxVersion = "2.7.5"

    # path to the favicon, under "static"
    favicon = "favicon.ico"

    [params.logo]
    url = "logo.png"
    width = 50
    height = 50
    alt = "Logo"
```

在设置文件中， 字符串要写成用双撇号界定的形式， 布尔值要写成没有双撇号的true或者false。 用方括号包围的项（如`[permalinks]`）会定义一个列表类型的变量， 下面缩进后的内容是列表的元素。 用双方括号包围的项是列表数组， 即每一项都是列表， 但是合并在一起由组成一个元素为列表的数组。 如上面`[[menu.main]]`有若干项， 每一项是一个主菜单项， 其设置是一个列表。 主菜单位置、配色等在其它地方设置， 主设置文件中仅设置其文字和对应链接。

不同的网站主题需要不同的`config.toml`文件。

下面给出一些选项的解释。

- `baseURL`：这是你的网页发布到网站上时， 该网站给你的主页面的地址。 一般是需要设置为自己发布以后的divide。
- `languageCode`: 中文是`zh-cn`，英文是`en-us`， 可能会影响一些排版规则， 但是编码都是UTF-8。
- `permalinks`: Hugo和blogdown在发布HTML与图片等内容时需要不变的链接， 默认是content中的每个Rmd文件变成`public`或`public/post`下的同名子目录中的`index.html`文件。可以用`permalinks`指定命名规则。 `slug`是网页元数据可以设置的一项类似于文章标识符的东西， 不设置则使用文章标题。
- `publishDir`: 生成的网站存放的文件，默认为`public`目录。
- `theme`：在`themes/`目录中保存所选主题的目录的名字。
- `ignoreFiles`: 项目中那些文件不被复制到生成结果网站中。
- `hasCJKLanguage`: 如果有大量中文、日文、韩文内容， 设置为`true`可以在网页统计和单词书统计时更准确。
- `[params]`: 主题特有的设置放在这里。

### 24.3.5 静态文件

项目中在`./static/`下的文件称为静态文件， 可以保存自己的图片、Javascript库等， 发布时自动复制到`./public/`中。 比如， 文件`.static/figs/mypic01.png`， 在Rmd文件中可以用`![](figs/mypic01.png)`引用。

每个主题中一般也有一个static目录， 自己的static目录中的同名文件在发布时可以覆盖主题中的同名文件， 这样可以修改主题的一些资源或者设置。 从Rmd编译生成的文件也可能会被static中的同名文件覆盖。

还可以将网页编译为PDF等格式存放在static目录中。 `rmarkdown::build_dir()`命令可以将目录中所有Rmd文件按照其元数据的输出格式编译输出。

### References

Xie, Yihui, J. J. Allaire, and Garrett Grolemund. 2019. *R Markdown: The Definitive Guide*. CRC Press. https://bookdown.org/yihui/rmarkdown/.

Yihui Xie, Alison Presmanes Hill, Amber Thomas. 2017. *Blogdown: Creating Websites with R Markdown*.











# 25 制作幻灯片

## 25.1 介绍

R Markdown文件(.Rmd)文件支持多种输出， 如网页(`html_document`)、MS Word(`word_document`)、PDF(`pdf_document`, 需要LaTeX编译器支持)等， 还支持生成网页格式的幻灯片(`slidy_presentation`, `ioslides_presentation`)， 以及LaTeX beamer格式的PDF幻灯片(`beamer_presentation`)。

## 25.2 Slidy幻灯片

Rmd文件选用输出格式`slidy_presentation`可以生成网页格式的幻灯片， 并具有缩放字体大小、显示幻灯片目录等功能。 只要在.Rmd文件开头的YAML元数据部分指定`output: slidy_presentation`。 因为幻灯片的单位是帧(frame)， 与论文的结构有很大区别， 所以幻灯片Rmd文件很难同时作为论文的源文件。

### 25.2.1 文件格式

幻灯片分为多个帧，每帧用二级标题作为标志并以其为标题。 二级标题就是行首以两个井号和空格开始的行， 或者在标题下面画由减号组成的线的行。 用一级标题作为单独的分节帧， 将单独显示在一帧中。 一级标题是行首以两个井号和空格开始的行， 或者在标题下面画由等于号组成的线的行。

帧也可以没有标题，比如仅有照片的帧， 这时， 用三个或三个以上的减号连在一起标识新帧的开始。

一个简单的slidy_presentation幻灯片源文件example-slidy.Rmd， 内容如：

```
---
title: "R幻灯片演示样例"
author: "李东风"
date: "2017-11-16"
output: slidy_presentation
---
# 用R Markdown的slidy输出作幻灯片

## 幻灯片结构

- 用二级标题标志一个页面开始
- 用一级标题制作单独的分节页面
- 用三个或三个以上减号标志没有标题的页面开始
- 每个页面一般用markdown列表显示若干个项目

## 幻灯片编译

- 用RStudio编辑
- 用RStudio的Knit按钮，选`slidy_presentation`作为输出格式

-----

[一个演示画面](figs/demoscreen.png)
```

### 25.2.2 幻灯片编译

幻灯片用RStudio的knit按钮编译， 选择输出格式为`slidy_presentation`， 结果在浏览器中播放， 最好使用外部浏览器而不使用RStudio自带的浏览器， 自带的浏览器在显示数学公式时对网络环境条件有要求而且不能完美地支持关于数学公式的本地设置。

除了使用knit按钮，还可以用类似如下命令：

```
rmarkdown::render("mydemo.Rmd", output_format = "slidy_presentation", encoding="UTF-8")
```

其中`mydemo.Rmd`是源文件。

为了制作幻灯片，最好单独设置一个RStudio项目， 并且此项目仅生成幻灯片， 而不生成普通网页、Word、PDF等输出， 否则可能造成结果混乱。 希望rmarkdown包的后续版本能取消这个限制。

### 25.2.3 播放控制

播放时，用如下方式控制：

- 鼠标左键单击、光标右移键、向下翻页键、空格键都可以翻到下一页；
- 光标左移键、向上翻页键回退一页；
- 单击下方的Contents或单击C键显示幻灯片目录列表，可单击转移到任意页面；
- Home键回到幻灯片开头；
- 用A键切换是否将所有页面合并显示成一个长的网页；
- 用S键缩写字体，用B键放大字体；
- 通过选择保存为PDF的打印机进行打印， 可以将幻灯片转换为PDF， 但是打印生成的PDF仍是每页仅有原来的一帧， 所以转换成一个单页的HTML再打印可能更合适。

### 25.2.4 生成单页HTML

对slidy幻灯片的Rmd源文件不加修改， 也可以通过命令直接转换为普通的单页HTML文件， 但是因为在slidy幻灯片源文件中二级标题用来分帧， 而普通Rmd文件中二级标题用来分小节， 所以生成的单页HTML文件会有许多小节。 这样的文件更适合打印以及转换为PDF文件。

命令如：

```
rmarkdown::render("mydemo.Rmd", output_file="handout.html", output_format="html_document", encoding="UTF-8")
```

### 25.2.5 数学公式处理与输出设置文件

讲课用的幻灯片经常会有数学公式， 比较关键的问题是数学公式如何处理。 网页中的数学公式一般使用一个公开的自由Javascript库MathJax显示， 但是这个库很大， 如果使用远程的库， 在网络不畅通时显示公式就不正常。 更好的办法是使用局部的MathJax库或将MathJax库安装在临近的网站服务器上。

为了使用局部的MathJax库， 简单的办法是在YAML的`ioslides_presentation`项目下面指定`mathjax: local`， 如：

```
---
title: "R幻灯片演示样例"
output: 
  slidy_presentation:
    mathjax: local
---
```

上述办法容易使用， 缺点是多个不同的演示项目无法共用一个局部的MathJax库， 生成的结果包含了许多小的支持文件。

为此， 可以将MathJax库装在演示项目所在目录的上层（比如上两层的`MathJax`目录内）， 将设置MathJax的代码放在`_header.html`文件中， `_header.html`中的内容如：

```
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX","output/SVG"],
  extensions: ["tex2jax.js","MathMenu.js","MathZoom.js"],
  TeX: {
    extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
  }
});
</script>
```

在演示项目所在目录中增加一个`_output.yml`文件， 这使得该项目所有输出的共用的输出设置，内容如：

```
slidy_presentation: 
    toc: false
    mathjax: "../../MathJax/MathJax.js"
    self_contained: false
    includes:
      in_header: "_header.html"
html_document: 
    toc: true
    number_sections: false
    mathjax: "../../MathJax/MathJax.js"
    self_contained: false
    includes:
      in_header: "_header.html"
```

这里关闭了`self_contained`选项， 设置了MathJax库在本地目录，具体是演示项目所在目录上面两层的MathJax目录中。

公式中如果有中文， 开始时可能显示不正常， 这时右键点击公式弹出菜单选择“Math Settings–Math Renderer”， 取为“HTML-CSS”或“SVG”应可解决问题。

上面的输出设置文件中也设置了输出`html_document`， 这是单页的HTML格式， 取消了自动章节编号， 因为源文件中每帧都是一个小节。

### 25.2.6 其它选项

用`slidy_presentation`的`font_adjustment: -1`可以缩小字体一号， 类似可以设为`+1`，`-2`等。 在播放时也可以用S和B键缩小或放大显示。

可以在播放时在浏览器状态栏显示倒数计时器， 用`slidy_presentation`的`duration: 5`表示每帧显示5分钟。 这是总的预计时间， 适用于演讲有时间限制的情况。

可以用`footer`属性指定每帧都显示的状态栏脚注，如：

```
---
output:
  slidy_presentation:
    font_adjustment: -1
    duration: 5
    footer: "北京大学"
---
```

`slidy_presentation`输出属性`incremental: true`可以使得列表显示需要每点击一次才显示下一项。

### 25.2.7 slidy幻灯片激光笔失效问题的修改

slidy幻灯片翻页是用空格、左右光标、上下翻页键， 而一般激光笔翻页是模拟上下光标键。 为此， 在安装的R软件目录的 `library/rmarkdown/rmd/slidy/Slidy2/scripts`子目录中， 找到slidy.js文件， 用编辑器打开， 用编辑器的搜索功能搜索`key == 37`， 将其替换成`key == 37 || key == 38`， 这里37是向左光标的编码， 替换后就是向左或者向上光标。 用编辑器的搜索功能搜索`key == 39`, 将其替换成`key == 39 || key == 40`， 这里39是向右光标的编码， 替换后就是向右或者向上光标。 修改完毕后保存， 然后将slidy.js用文件压缩程序（如7zip）压缩为slidy.js.gz。 这样就可以在用rmarkdown制作的`slidy_presentation`结果中支持激光笔翻页了。

这样修改后， 如果某帧超高， 需要滚动显示， 就只能通过鼠标滚轮滚动了。

## 25.3 MS PowerPoint幻灯片

`powerpoint_presentation`输出格式可以生成MS PowerPoint文件。 设置如：

```
---
output:
  powerpoint_presentation:
    slide_level: 2
---
```

可以用`powerpoint_presentation`的`reference_doc`属性指向一个.pptx的文件， 作为模板， 模板中的样式将被输出结果采用。

可以用Rstudio的Knit快捷图标实现转换（选其中的knit to PowerPoint）， 或者用如下命令：

```
rmarkdown::render("slides.Rmd", output_format="powerpoint_presentation", encoding="UTF-8")
```

## 25.4 Bearmer幻灯片格式

上述Slidy格式的幻灯片， 也可以通过LaTeX编译器转换成LaTeX beamer格式的幻灯片， 设置如：

```
---
output:
  beamer_presentation:
    latex_engine: xelatex
    slide_level: 2
    theme: CambridgeUS
    colortheme: dolphin
    includes:
      in_heaer: "preamble.tex"
---
```

其中`slide_level`用来规定几级标题开始新的一帧。 `theme`指定一种主题， `colortheme`指定一种配色方案， `in_header`在LaTeX导言部分插入`preamble.tex`， 内容见[22.12](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/rmarkdown.html#rmd-latex)。

编译命令如：

```
rmarkdown::render("mydemo.Rmd", output_format = "beamer_presentation", encoding="UTF-8")
```

结果是一个PDF文件。

截止到2019年7月时，编译不成功。 原因在于Rmd到Beamer幻灯片的转换是预期使用pdflatex引擎的， 而中文更适合用xelatex引擎， 但目前的rmarkdown包中beamer幻灯片功能对xelatex引擎支持不足。

如果是纯英文内容的幻灯片， 可以在上面的设置中去掉关于`latex_engine`的设置并在preamble.tex中去掉与中文有关的内容，则可以编译成功。

## 25.5 R Presentation格式

R Studio软件单独提供了对一种R Presentation格式的源文件的支持， 以.Rpres扩展名结尾， 是一种特殊的R Markdown文件， 与slidy的源文件也类似。

Rpres文件编译为HTML格式的幻灯片， 使用reveal.js控制显示。 reveal.js中也有对激光笔支持不好的问题， 这是因为reveal.js中用向右光标键翻页， 对向下光标另有定义， 激光笔一般是模拟向下和向上光标键来翻页的。 为了支持激光笔， 找到RStudio的安装目录， 在`resources/presentation/revealjs/js`中找到`reveal.js`文件， 在文件编辑器中打开， 通过搜索找到`case 38:`, 将其剪切到`case 33:`后面， 变成`case 33: case 38:`。 找到`case 40:`, 将其剪切到`case 34:`后面， 变成`case 34: case 40:`。 同一目录还有一个`reveal.min.js`文件， 也进行上述修改。







# 26 数据读取技巧

## 26.1 日期数据

设文件[`dates.csv`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/dates.csv)中包含如下内容，并设其文件编码为GBK:

```
序号,出生日期,发病日期
1,1941/3/8,2007/1/1
2,1972/1/24,2007/1/1
3,1932/6/1,2007/1/1
4,1947/5/17,2007/1/1
5,1943/3/10,2007/1/1
6,1940/1/8,2007/1/1
7,1947/8/5,2007/1/1
8,2005/4/14,2007/1/1
9,1961/6/23,2007/1/2
10,1949/1/10,2007/1/2
```

先把日期当作字符串读入:

```
d.dates <- read_csv('dates.csv', locale=locale(encoding="GBK"))
## Parsed with column specification:
## cols(
##   序号 = col_double(),
##   出生日期 = col_character(),
##   发病日期 = col_character()
## )
```

然后用`lubridate::ymd()`函数转换为R日期类型：

```
d.dates[["出生日期ct"]] <- lubridate::ymd(
  d.dates[["出生日期"]])
d.dates[["发病日期ct"]] <- lubridate::ymd(
  d.dates[["发病日期"]])
```

也可以用R本身的`as.POSIXct`函数转换：

```
d.dates[["出生日期ct"]] <- as.POSIXct(
  d.dates[["出生日期"]], format='%Y/%m/%d', tz='Etc/GMT+8')
d.dates[["发病日期ct"]] <- as.POSIXct(
  d.dates[["发病日期"]], format='%Y/%m/%d', tz='Etc/GMT+8')
```

经过转换后的数据为:

```
knitr::kable(d.dates)
```

| 序号 | 出生日期  | 发病日期 | 出生日期ct | 发病日期ct |
| ---- | --------- | -------- | ---------- | ---------- |
| 1    | 1941/3/8  | 2007/1/1 | 1941-03-08 | 2007-01-01 |
| 2    | 1972/1/24 | 2007/1/1 | 1972-01-24 | 2007-01-01 |
| 3    | 1932/6/1  | 2007/1/1 | 1932-06-01 | 2007-01-01 |
| 4    | 1947/5/17 | 2007/1/1 | 1947-05-17 | 2007-01-01 |
| 5    | 1943/3/10 | 2007/1/1 | 1943-03-10 | 2007-01-01 |
| 6    | 1940/1/8  | 2007/1/1 | 1940-01-08 | 2007-01-01 |
| 7    | 1947/8/5  | 2007/1/1 | 1947-08-05 | 2007-01-01 |
| 8    | 2005/4/14 | 2007/1/1 | 2005-04-14 | 2007-01-01 |
| 9    | 1961/6/23 | 2007/1/2 | 1961-06-23 | 2007-01-02 |
| 10   | 1949/1/10 | 2007/1/2 | 1949-01-10 | 2007-01-02 |

以上读入日期是比较保险的做法。 还可以直接在`read_csv()`函数中指定某列为`col_date()`：

```
d.dates <- read_csv(
  'dates.csv', locale=locale(encoding="GBK"),
  col_types=cols(
    `序号`=col_integer(),
    `出生日期`=col_date(format="%Y/%m/%d"),
    `发病日期`=col_date(format="%Y/%m/%d")
  ))
print(d.dates)
## # A tibble: 10 x 3
##     序号 出生日期   发病日期  
##    <int> <date>     <date>    
##  1     1 1941-03-08 2007-01-01
##  2     2 1972-01-24 2007-01-01
##  3     3 1932-06-01 2007-01-01
##  4     4 1947-05-17 2007-01-01
##  5     5 1943-03-10 2007-01-01
##  6     6 1940-01-08 2007-01-01
##  7     7 1947-08-05 2007-01-01
##  8     8 2005-04-14 2007-01-01
##  9     9 1961-06-23 2007-01-02
## 10    10 1949-01-10 2007-01-02
```

### 26.1.1 日期差计算

R的日期可以用`difftime`计算差值。 为了计算发病时的年龄，包括小数部分，可以这样计算：

```
d.dates[,'发病年龄（带小数年）'] <- as.numeric(
  difftime(d.dates[["发病日期"]], d.dates[["出生日期"]], units='days')/365.25)
knitr::kable(d.dates, digits=2)
```

| 序号 | 出生日期   | 发病日期   | 发病年龄（带小数年） |
| ---- | ---------- | ---------- | -------------------- |
| 1    | 1941-03-08 | 2007-01-01 | 65.82                |
| 2    | 1972-01-24 | 2007-01-01 | 34.94                |
| 3    | 1932-06-01 | 2007-01-01 | 74.58                |
| 4    | 1947-05-17 | 2007-01-01 | 59.63                |
| 5    | 1943-03-10 | 2007-01-01 | 63.81                |
| 6    | 1940-01-08 | 2007-01-01 | 66.98                |
| 7    | 1947-08-05 | 2007-01-01 | 59.41                |
| 8    | 2005-04-14 | 2007-01-01 | 1.72                 |
| 9    | 1961-06-23 | 2007-01-02 | 45.53                |
| 10   | 1949-01-10 | 2007-01-02 | 57.98                |

### 26.1.2 计算周岁

如果按照我们通常计算周岁的方法计算年龄， 算法就不仅包括年的差， 还要判断是否到了本年的生日。

用lubridate包的功能计算周岁如下：

```
age.int <- function(birth, now){
  age <- year(now) - year(birth)
  sele <- (month(now) * 100 + mday(now)
              < month(birth) * 100 + mday(birth))
  ## sele 是那些没有到生日的人
  age[sele] <- age[sele] - 1

  age
}
```

用R本身的功能实现周岁计算如下：

```
age.int <- function(birth, now){
  date1 <- as.POSIXlt(birth)
  date2 <- as.POSIXlt(now)
  age <- date2$year - date1$year
  sele <- (date2$mon * 100 + date2$mday
              < date1$mon * 100 + date1$mday)
  ## sele 是那些没有到生日的人
  age[sele] <- age[sele] - 1

  age
}
```

用`d.dates()`计算发病时周岁年龄：

```
d.dates[["发病年龄"]] <- age.int(d.dates[["出生日期"]], d.dates[["发病日期"]])
knitr::kable(d.dates, digits=2)
```

| 序号 | 出生日期   | 发病日期   | 发病年龄（带小数年） | 发病年龄 |
| ---- | ---------- | ---------- | -------------------- | -------- |
| 1    | 1941-03-08 | 2007-01-01 | 65.82                | 65       |
| 2    | 1972-01-24 | 2007-01-01 | 34.94                | 34       |
| 3    | 1932-06-01 | 2007-01-01 | 74.58                | 74       |
| 4    | 1947-05-17 | 2007-01-01 | 59.63                | 59       |
| 5    | 1943-03-10 | 2007-01-01 | 63.81                | 63       |
| 6    | 1940-01-08 | 2007-01-01 | 66.98                | 66       |
| 7    | 1947-08-05 | 2007-01-01 | 59.41                | 59       |
| 8    | 2005-04-14 | 2007-01-01 | 1.72                 | 1        |
| 9    | 1961-06-23 | 2007-01-02 | 45.53                | 45       |
| 10   | 1949-01-10 | 2007-01-02 | 57.98                | 57       |

## 26.2 缺失值处理

设有如下的[`bp.csv`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/bp.csv)数据，以GBK编码保存：

```
序号,收缩压
1,145
5,110
6,未测
9,150
10,拒绝
15,115
```

其中的血压有非数值内容。 直接用`read.csv`读入:

```
d.bp <- read_csv('bp.csv', locale=locale(encoding="GBK"))
## Parsed with column specification:
## cols(
##   序号 = col_double(),
##   收缩压 = col_character()
## )
print(d.bp)
## # A tibble: 6 x 2
##    序号 收缩压
##   <dbl> <chr> 
## 1     1 145   
## 2     5 110   
## 3     6 未测  
## 4     9 150   
## 5    10 拒绝  
## 6    15 115
```

读入的收缩压被当成了字符型列，无法进行计算。

把字符型的收缩压转换为数值型:

```
d.bp[["收缩压数值"]] <- as.numeric(d.bp[["收缩压"]])
## Warning: 强制改变过程中产生了NA
knitr::kable(d.bp)
```

| 序号 | 收缩压 | 收缩压数值 |
| ---- | ------ | ---------- |
| 1    | 145    | 145        |
| 5    | 110    | 110        |
| 6    | 未测   | NA         |
| 9    | 150    | 150        |
| 10   | 拒绝   | NA         |
| 15   | 115    | 115        |

收缩压中非数值的项被转换为数值型缺失值， 并在转换时有警告信息。 注意这里同时保存了原始输入的收缩压和转换为数值的收缩压， 这样便于数据核对。

## 26.3 练习

- 读入[`patients.csv`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/patients.csv)， 把其中的日期转换为R日期类型， 计算发病年龄。保存为tibble数据框d.patients。
- 读入[`cancer.csv`](http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/cancer.csv)， 保存为d.cancer。 v0是放疗前肿瘤体积， v1是放疗后肿瘤体积。 计算放疗后肿瘤缩减率。











