---
layout: post
title: "python！！每日早上八点自动向QQ邮箱发送天气预报邮件"
date: 2019-11-29
tag: sas
---



## python！！每日早上八点自动向QQ邮箱发送天气预报邮件





```python
目录
1.注册免费天气API
1.1打开和风天气注册账号
1.2打开天气API接口说明，看看和风天气的开发文档。
2.编写获取天气代码
2.1获取天气预报情况
2.2所在城市经纬度等信息查询
2.3查询所在城市未来7天信息
2.4 获取自己所需要的天气信息
3.编写发送邮件代码
4.完整代码
5.部署代码到服务器，以便每日准时运行代码
5.1 首先拷贝文件到服务器
5.2 无
前言：近来天气转凉，我是每日起床都会查一下当天的天气情况。但我又觉得查天气麻烦，于是乎产生了一个每日定时自动获取天气预报并且发送到个人邮箱的想法。

如果你也觉得查天气麻烦，那看这篇文章就对了。
而这篇文章！！将详细讲解如何实现每日早上八点将最近7天的天气状况发送到你的个人邮箱。
自动将天气状况发送到你的个人邮箱共有以下四个步骤。

1.注册免费天气API
1.1打开和风天气注册账号
1.下图是和风天气：https://dev.heweather.com/的首页，打开注册即可。
在这里插入图片描述
2.账号注册成功后点击 新建应用 ，创建一个Key，这个Key是用来进行和风天气API调用的。
可以看到新建成功后的Key是一串长长的字符串，这个就是获取天气信息需要用到的密钥啦。
在这里插入图片描述

1.2打开天气API接口说明，看看和风天气的开发文档。
API开发文档，点击即可跳转。
在这里插入图片描述
从上图中可以看到(有商业版与免费版我这里使用的是免费版)，有多种weather-type，这里我们使用forecast，这个是获取3-10天预报。

根据上图的请求URL示例可知，我们需要调用的url为

https://free-api.heweather.net/s6/weather/forecast?location=城市代码&key=自己创建的Key

2.编写获取天气代码
城市可以填写中文，也可以填写城市代码城市代码查询。

2.1获取天气预报情况
import requests

url = 'https://free-api.heweather.net/s6/weather/forecast?location=广州&key=xxxxxxxxx'
res = requests.get(url)
print(res.text)
1
2
3
4
5
返回的是json格式的文件，可以看到返回了从查询当天的起始的7天天气预报信息。
在这里插入图片描述
接下的任务就是解析这一堆json格式的数据啦。

2.2所在城市经纬度等信息查询
import json
import requests

url = 'https://free-api.heweather.net/s6/weather/forecast?location=广州&key=xxxxxxxxx'
res = requests.get(url)
res = json.loads(res.text)	# 转换json数据为字典
result = res['HeWeather6'][0]['basic']
print(result)
# 这是所查询城市的经纬度，时区等等信息。
## {'cid': 'CN101280101', 'location': '广州', 'parent_city': '广州', 'admin_area': '广东', 'cnty': '中国', 'lat': '23.12517738', 'lon': '113.28063965', 'tz': '+8.00'}

2.3查询所在城市未来7天信息
import json
import requests

url = 'https://free-api.heweather.net/s6/weather/forecast?location=广州&key=xxxxxxxxx'
res = requests.get(url)
res = json.loads(res.text)	# 转换json数据为字典
result = res['HeWeather6'][0]['daily_forecast']
print(result)

因为这里调用的API会返回7天的数据，所以会返回7组下图的数据。

        {
          "cond_code_d": "100",		# 白天天气状况 100为晴 101为多云 104为阴 等
          "cond_code_n": "100",		# 夜间天气状况 
          "cond_txt_d": "晴",		# 白天天气状况描述
          "cond_txt_n": "晴",		# 晚间天气状况描述
          "date": "2019-11-10",		# 预报日期
          "hum": "50",				# 相对湿度
          "mr": "16:33",			# 月升时间
          "ms": "04:21",			# 月落时间
          "pcpn": "0.0",			# 降水量
          "pop": "0",				# 降水概率
          "pres": "1013",			# 大气压强
          "sr": "06:37",			# 日出时间
          "ss": "17:43",			# 日落时间
          "tmp_max": "27",			# 最高温度
          "tmp_min": "16",			# 最低温度
          "uv_index": "7",			# 紫外线强度指数
          "vis": "25",				# 能见度，单位：公里
          "wind_deg": "-1",			# 风向360角度
          "wind_dir": "无持续风向",	# 风向
          "wind_sc": "1-2",			# 风力
          "wind_spd": "6"			# 风速，公里/小时
        }
       	......

2.4 获取自己所需要的天气信息
import csv
import json
import requests

url = 'https://free-api.heweather.net/s6/weather/forecast?location=广州&key=xxxxxx'
res = requests.get(url)
res = json.loads(res.text)
result = res['HeWeather6'][0]['daily_forecast']
city = location['parent_city']+location['location']
names = ['城市','时间','天气状况','最高温','最低温','日出','日落']
for data in result:
    date = data['date']
    cond = data['cond_txt_d']
    max = data['tmp_max']
    min = data['tmp_min']
    sr = data['sr']
    ss = data['ss']
    print(city,date,cond,max,min,sr,ss)
## 返回的数据
广州广州 2019-11-10 晴 27 16 06:37 17:43
广州广州 2019-11-11 晴 28 18 06:38 17:43
广州广州 2019-11-12 晴 29 18 06:39 17:42
广州广州 2019-11-13 多云 28 17 06:39 17:42
广州广州 2019-11-14 晴 25 15 06:40 17:42
广州广州 2019-11-15 晴 26 15 06:40 17:42
广州广州 2019-11-16 晴 27 16 06:41 17:41

3.编写发送邮件代码
这里参考菜鸟教程的Python SMTP发送邮件
1.首先去QQ邮箱
打开 设置-账户-开启服务-开启POP3/SMTP服务，然后点击生成授权码，python发送邮件要用。
在这里插入图片描述
直接上代码，不解释。

# 简单邮件传输协议
import smtplib
import email
import time
from email.mime.text import MIMEText
from email.mime.image import MIMEImage
from email.mime.multipart import MIMEMultipart

# 设置邮箱的域名
HOST = 'smtp.qq.com'
# 设置邮件标题
SUBJECT = '今日份天气预报到了哟，主子'
# 设置发件人邮箱
FROM = 'xxx@qq.com'
# 设置收件人邮箱
TO = 'xxx@163.com,xxx@qq.com'	# 可以填写多个邮箱，用逗号分隔，后面会用split做逗号分割
message = MIMEMultipart('related')
# --------------------------------------发送文本-----------------
# 发送邮件正文到对方的邮箱中
message_html = MIMEText("主子你的邮件到了\n\nThis is test", 'plain', 'utf-8')	# \n为换行
message.attach(message_html)

# -------------------------------------添加文件---------------------
# 要确定当前目录有test.csv这个文件
message_xlsx = MIMEText(open('test.csv', 'rb').read(), 'base64', 'utf-8')
# 设置文件在附件当中的名字
message_xlsx['Content-Disposition'] = 'attachment;filename="test01.csv"'
message.attach(message_xlsx)

# 设置邮件发件人
message['From'] = FROM
# 设置邮件收件人
message['To'] = TO
# 设置邮件标题
message['Subject'] = SUBJECT

# 获取简单邮件传输协议的证书
email_client = smtplib.SMTP_SSL()
# 设置发件人邮箱的域名和端口，端口为465
email_client.connect(HOST, '465')
# ---------------------------邮箱授权码------------------------------
result = email_client.login(FROM, '你的授权码')
print('登录结果', result)
email_client.sendmail(from_addr=FROM, to_addrs=TO.split(','), msg=message.as_string())
# 关闭邮件发送客户端
email_client.close()

4.完整代码
# coding=gbk		## 注：linux服务器上不需要这一行,window需要
import csv
import time
import json
import requests
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

url = r'https://free-api.heweather.net/s6/weather/forecast?location=广州&key=xxxxxx'
# 获取当日时间	2019-11-10
today_time = time.strftime('%Y-%m-%d', time.localtime(time.time()))

def get_weather_data():
    res = requests.get(url)
    res.encoding = 'utf-8'
    res = json.loads(res.text)
    result = res['HeWeather6'][0]['daily_forecast']
    location = res['HeWeather6'][0]['basic']
    city = location['parent_city'] + location['location']
    names = ['城市', '时间', '天气状况', '最高温', '最低温', '日出', '日落']
    with open('today_weather.csv', 'w', newline='')as f:
        writer = csv.writer(f)
        writer.writerow(names)
        for data in result:
            date = data['date']
            cond = data['cond_txt_d']
            max = data['tmp_max']
            min = data['tmp_min']
            sr = data['sr']
            ss = data['ss']
            writer.writerows([(city, date, cond, max, min, sr, ss)])
    send_email()

def send_email():
    # 设置邮箱的域名
    HOST = 'smtp.qq.com'
    # 设置邮件标题
    SUBJECT = '%s日份天气预报信息，请查收'%today_time
    # 设置发件人邮箱
    FROM = 'xxx@qq.com'
    # 设置收件人邮箱
    TO = 'xxx@163.com,xxx@qq.com'		# 可以同时发送到多个邮箱
    message = MIMEMultipart('related')
    # --------------------------------------发送文本-----------------
	# 发送邮件正文到对方的邮箱中
    message_html = MIMEText("%s日份天气预报到账啦，请查收" % today_time, 'plain', 'utf-8')
    message.attach(message_html)

    # -------------------------------------添加文件---------------------
    # today_weather.csv这个文件
    message_xlsx = MIMEText(open('today_weather.csv', 'rb').read(), 'base64', 'utf-8')
    # 设置文件在附件当中的名字
    message_xlsx['Content-Disposition'] = 'attachment;filename="today_weather.csv"'
    message.attach(message_xlsx)

    # 设置邮件发件人
    message['From'] = FROM
    # 设置邮件收件人
    message['To'] = TO
    # 设置邮件标题
    message['Subject'] = SUBJECT

    # 获取简单邮件传输协议的证书
    email_client = smtplib.SMTP_SSL()
    # 设置发件人邮箱的域名和端口，端口为465
    email_client.connect(HOST, '465')
    # ---------------------------邮箱授权码------------------------------
    result = email_client.login(FROM, '你的授权码')
    print('登录结果', result)
    email_client.sendmail(from_addr=FROM, to_addrs=TO.split(','), msg=message.as_string())
    # 关闭邮件发送客户端
    email_client.close()

get_weather_data()

5.部署代码到服务器，以便每日准时运行代码
说的好听就叫代码部署，换句话说就是将代码拷贝到服务器，然后让代码运行。
这里会用到一丢丢linux的知识，

5.1 首先拷贝文件到服务器
这一步很简单，直接复制黏贴即可。

5.2 无
创建一个和 python文件在同一个文件夹的 startup.sh文件(命名随意),然后在 startup.sh文件的里面填写

python3 ./python文件名称 # 记得 / 前面有个小点 .

在这里插入图片描述
然后再 /etc/crontab 里面填写 stratup.sh文件的路径即可。
在这里插入图片描述
既然你学会了发送天气预报，那再加上每天发送一句语音如何？ ，用定制的萝莉音，御姐音给对方发送天气预报信息的语音。点击下方文章链接跳转，get文字转换语音的方式吧。

肥宅福利！！python。文字转语音，你想要御姐音还是萌妹音？
https://blog.csdn.net/weixin_45081575/article/details/103043870

以上，动手操作一番即可，就可以每天8点准时收到最新的天气预报信息了。
如果你懒得动手，可以尝试在留言里动手留下你的邮箱+城市（反正我也不会给你弄）
这次的分享就到这里。如果有什么疑问可以在下方留言哦。

对于没有服务器的小伙伴在这里推荐一个免费的云服务器： 三丰云免费服务器：https://www.sanfengyun.com/freeServer/


```







## python开机发邮件



本软件用于查看有摄像头的电脑使用，获取开机启动后10s之内的一张照片，并发送到指定邮箱。 下载软件后放置到D盘根目录，然后双击一下，将接收到一封邮件，并自动添加到启动项，下次开机自启动； 注意点：只支持放置到D盘，必须在开机时就拥有网络。

```python
python开机自启动拍照并发送到邮箱(Windows)
Python拿了出来玩一玩, 上网找了一些好玩的程序,发现有一篇文章写如何在Linux系统开机拍照并发送给邮箱, 就想着在windows上也实现一下.

首先分析一下流程: 开机自启动->拍照->发送邮件->退出

第一步:    配置windows下的python代码开机自启动




代码:

import win32api
import win32con
 
class AutoRun():
    def __init__(self):
        name = 'Test'  # 要添加的启动项名称
        AutoPath = 'D:\\GetImage.exe'  # 要添加的exe路径
        # 注册表项名
        KeyName = 'Software\\Microsoft\\Windows\\CurrentVersion\\Run'
        # 异常处理
        try:
            key = win32api.RegOpenKey(win32con.HKEY_CURRENT_USER,  KeyName, 0,  win32con.KEY_ALL_ACCESS)
            win32api.RegSetValueEx(key, name, 0, win32con.REG_SZ, path)
            win32api.RegCloseKey(key)
        except:
            print('添加失败')
        print('添加成功！')
if __name__=='__main__':
    auto=AutoRun();    #引用启动项
第二步:    拍照:

此功能需要用到open-python的功能,我们在控制台中用pip安装一下opencv

pip install opencv-python
然后使用代码拍照:

import cv2
 
def GetPicture():                 #拍照
	cap = cv2.VideoCapture(0)
	ret,frame = cap.read()
	cv2.imwrite('D:\\person.jpg',frame)
	cap.release
此代码将会拍照并放置在D盘中

第三步:    发送邮件:

关于只用邮箱发送邮件的功能我也参考了以为博主:

https://www.cnblogs.com/zhongfengshan/p/9763366.html

特此感谢此博主, 各位可以参考他的关于发送邮件的文章.

关于邮箱的登录密码,由于算是第三方客户端,所有我们需要使用授权码,关于QQ邮箱的授权码,有链接:

https://service.mail.qq.com/cgi-bin/help?subtype=1&&id=28&&no=1001256

 

下面贴上全部代码:

'''
本文件设计于获取开机后的照片
流程:复制到电脑后打开软件,然后会收到测试邮件,下次开机后将自动打开该软件,并获取照片
发送到指定邮箱
'''
 
import cv2
import smtplib
import sys
import os
import time
import win32api
import win32con
from email.mime.image import MIMEImage
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
 
 
host = "smtp.qq.com"    #发服务器接口
port = 25               #端口号
sender = "xxxxxxxx@qq.com" #消息发送方
pwd = "xxxxxxxx"   #授权码
receiver = "xxxxxx@qq.com"  #消息接收方
exit_count = 5     #尝试联网次数
# path = os.getcwd()  #获取图片保存路径  返回当前进程的工作目录
path = "D:"       #文件路径
 
# def mkdir(path):                 #创建文件夹路径
# 	folder = os.path.exists(path)
# 	if folder:
# 		print ("Have Done")
# 	else:
# 		os.mkdir(path)
# 		print ("New Folder")
 
def GetPicture():                 #拍照
	cap = cv2.VideoCapture(0)
	ret,frame = cap.read()
	cv2.imwrite(path+'/person.jpg',frame)
	cap.release
 
def SetMsg():         #邮件格式设置
	msg = MIMEMultipart("mixed")
	msg['Subject'] = '电脑启动'  #标题
	msg['From'] = sender
	msg['To'] = receiver
	#邮件正文
	text = "您的电脑已开机!已经为你获取开机照片"
	text_plain = MIMEText(text,'plain','utf-8')      #正文转码
	msg.attach(text_plain)
	#构造图片链接
	SendImageFile = open(path+'/person.jpg','rb').read()
	image = MIMEImage(SendImageFile)
	#将收件人看见的附件照片名称改为people.png.
	image['Content-Disposition'] = 'attachment; filename = "people.png"'
	msg.attach(image)
	return msg.as_string()
 
def SendEmail(msg):			#发送邮件	
	smtp = smtplib.SMTP()
	smtp.connect(host)
	smtp.login(sender,pwd)
	smtp.sendmail(sender,receiver,msg)
	time.sleep(2)
	smtp.quit()
 
class AutoRun():             #添加开机启动项
    def __init__(self):
        name = 'Test'  # 要添加的项值名称
        AutoPath = path + '\\GetImage.exe'  # 要添加的exe路径
        # 注册表项名
        KeyName = 'Software\\Microsoft\\Windows\\CurrentVersion\\Run'
        # 异常处理
        try:
            key = win32api.RegOpenKey(win32con.HKEY_CURRENT_USER,  KeyName, 0,  win32con.KEY_ALL_ACCESS)
            win32api.RegSetValueEx(key, name, 0, win32con.REG_SZ, AutoPath)
            win32api.RegCloseKey(key)
        except:
            print('添加失败')
        print('添加成功！')
 
# def IsLink():     #判断网络是否连通
# 	return os.system('ping -c 4 www.baidu.com')
 
# def main():       #主函数
# 	reconnect_times = 0
# 	# while IsLink():
# 	# 	time.sleep(10)
# 	# 	reconnect_times += 1
# 	# 	if reconnect_times == exit_count:
# 	# 		sys.exit()
# 	# time.sleep(10)
	# GetPicture()
	# msg = SetMsg()
	# SendEmail(msg)
 
if __name__ == '__main__':
	# mkdir(path)        #先设置路径
	auto = AutoRun()   #设置开机自启动
	GetPicture()       #拍照
	msg = SetMsg()	   #设置格式
	SendEmail(msg)	   #发送
 



```



## 可行方案



网络环境：ipv4/ipv6双栈，其中ipv4有计费系统需登陆，ipv6无需登录。
    这里我利用python调用邮箱的SMTP服务发送邮件，自动的获取本机的ip地址并通过邮件发送出去。并设置开机自启，开机时自动通过批处理程序，启动该python程序，从而获取ip并发送邮件。下面我将给出.py源代码，需要注意以下几个步骤，
**步骤1**：远程电脑上应该成功安装python并且安装了与发送邮件相关的包（参考下面py代码的头部就知道了），python版本应该是3.x的版本。
**步骤2**：对于邮箱，应该设置邮箱开启SMTP服务。         
在本文作者的网络环境下，ipv4需要登录，ipv6不需登陆，而考虑到开机的时候ipv4可能是未登录的状态，而qq邮箱是没法在纯ipv6的环境下使用的，因此我采用ipv6下可以发送邮件的outlook邮箱。另外通过SMTP登录outlook邮箱时，与qq邮箱不同之处在于需要握手，反映在代码中，与qq邮箱不同之处在于多了如下两行代码：



```python

server.ehlo()
server.starttls()
```

另外qq邮箱登录时需要以授权码代替实际登陆邮箱时的qq密码，outlook的密码就是登录邮箱时的密码。
**我的.py的代码如下**（注意我这里用的是outlook的邮箱，而不是qq邮箱，只不过我的outlook的邮箱地址是qq邮箱）：

````
#下面四行导入依赖的包
import smtplib
import socket
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
# 获取本机计算机名称
hostname = socket.gethostname()
# 获取本机ip
ip = socket.gethostbyname(hostname)
 
#设置服务器所需信息 该部分需要修改
#outlook邮箱SMTP服务器地址
 
mail_host = 'smtp.office365.com' 
 
#outlook邮箱用户名
 
mail_user = 'XXX@qq.com' 
 
#密码(部分邮箱如qq邮箱为授权码) 
 
mail_pass = 'hahaha'  
 
#邮件发送方邮箱地址
 
sender = 'XXX@qq.com' 
 
#邮件接受方邮箱地址，注意需要[]包裹，这意味着你可以写多个邮件地址群发
 
receivers = ['YYY@gmail.com']  
 
#以上部分需要修改
 
#设置email信息
 
#邮件内容设置
 
message = MIMEText('正文说点啥好呢','plain','utf-8')
 
#邮件主题       
 
message['Subject'] = ip
 
#发送方信息
 
message['From'] = sender 
 
#接受方信息     
 
message['To'] = receivers[0]  
 
 
 
#登录并发送邮件
 
server = smtplib.SMTP(mail_host,587)
 
server.set_debuglevel(1)
 
server.ehlo()
 
server.starttls()
 
server.login(mail_user,mail_pass)
 
server.sendmail(sender,receivers,message.as_string())
 
server.quit()
 
exit()
````



```
步骤3：设置该python程序开机自启，即在C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp目录下加入一个批处理文件，方法是用记事本写下如下代码：python 1.py（我命名上面的py程序为1.py，按照实际的文件名来处理），保存之后将该.txt改成.bat即变成了批处理文件。然后把你的.py文件拷贝到C:\Windows\System32下即可。       需要注意远程的电脑设置好这些之后不要反复的开机折腾，要不邮箱可能被视为发送垃圾邮件而被暂时锁定。
       一切都设置好之后收到的邮件效果如下：
```







### 免费评分

## 参考文献

```
也可以去我的Github上寻找我的代码:

https://github.com/shuanghan0922/Python/tree/master/GetImageToEmail

https://blog.csdn.net/wickedvalley/article/details/80099566
代码地址
https://github.com/shuanghan0922/Python/blob/master/GetImageToEmail/GetImage.py

```

