# 任务和实用程序

## 任务-1.数据-1.1列出表特性

SASHELP.AACOMP

```sas
/*
 *
 * 任务代码由 SAS Studio 3.8 生成
 *
 * 生成时间: “19/12/22 下午9:02” 
 * 生成人员: “sasdemo” 
 * 生成服务器: “LOCALHOST” 
 * 生成 SAS 平台: “Linux LIN X64 2.6.32-754.6.3.el6.x86_64” 
 * 生成 SAS 版本: “9.04.01M6P11072018” 
 * 生成浏览器: “Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36” 
 * 生成 Web 客户端: “http://192.168.236.132/SASStudio/38/main?locale=zh_CN&zone=GMT%252B08%253A00&http%3A%2F%2F192.168.236.132%2FSASStudio%2F38%2F=” 
 *
 */
 
ods noproctitle;
ods select attributes variables;

proc datasets;
	contents data=SASHELP.AACOMP order=collate;
quit;
```



## 1.2 描述数据特征-wu

```
/*
 *
 * 无法生成代码，因为以下 
 * 要求无法满足: 
 *
 * 至少选择一个要描述其特性的变量。
 *
 *
 */

```



## 1.3描述缺失数据-wu

```
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  分析变量:（最小值: 1）
 *
 *
 */


```



## 1.4列出数据

```sas

/*
 *
 * 任务代码由 SAS Studio 3.8 生成
 *
 * 生成时间: “19/12/22 下午9:24” 
 * 生成人员: “sasdemo” 
 * 生成服务器: “LOCALHOST” 
 * 生成 SAS 平台: “Linux LIN X64 2.6.32-754.6.3.el6.x86_64” 
 * 生成 SAS 版本: “9.04.01M6P11072018” 
 * 生成浏览器: “Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36” 
 * 生成 Web 客户端: “http://192.168.236.132/SASStudio/38/main?locale=zh_CN&zone=GMT%252B08%253A00&http%3A%2F%2F192.168.236.132%2FSASStudio%2F38%2F=” 
 *
 */

title1 '列出数据 - SASHELP.VDCTNRY';

proc print data=SASHELP.VDCTNRY label;
run;

title1;
```



## 1.5 转置数据-wu

```
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  要转置的变量:（最小值: 1）
 *
 *
 */


```





## 1.6堆叠/拆分列-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  要拆分的列:（最小值: 1）
 *  观测标识符:（最小值: 1）
 *  水平标识符:（最小值: 1）
 *
 *
 */


```



## 1.7过滤数据-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 选项未设置: 
 *
 * 值:
 *
 *
 */

/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  变量 1:（最小值: 1）
 *
 *
 */


```

## 1.8 选择随机抽样

```sas
/*
 *
 * 任务代码由 SAS Studio 3.8 生成
 *
 * 生成时间: “19/12/22 下午9:28” 
 * 生成人员: “sasdemo” 
 * 生成服务器: “LOCALHOST” 
 * 生成 SAS 平台: “Linux LIN X64 2.6.32-754.6.3.el6.x86_64” 
 * 生成 SAS 版本: “9.04.01M6P11072018” 
 * 生成浏览器: “Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36” 
 * 生成 Web 客户端: “http://192.168.236.132/SASStudio/38/main?locale=zh_CN&zone=GMT%252B08%253A00&http%3A%2F%2F192.168.236.132%2FSASStudio%2F38%2F=” 
 *
 */

proc surveyselect data=SASHELP.ADSMSG out=work.RandomSample method=srs 
		sampsize=10;
run;
```



## 1.9 分区数据-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 选项未设置: 
 *
 * 分区 1 的观测所占比例:
 *
 *
 */


```



## 1.10 排序数据-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  排序依据:（最小值: 1）
 *
 *
 */


```



## 1.11 排名数据-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  要排名的列:（最小值: 1）
 *
 *
 */


```



## 1.12 转换数据-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  变量 1:（最小值: 1）
 *
 *
 */


```

## 1.13 标准化数据-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  要标准化的变量:（最小值: 1）
 *
 *
 */


```



## 1.14 重编码值-wu

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  要重编码的变量:（最小值: 1）
 *
 *
 */

/*
 *
 * 无法生成代码，因为以下
 * 选项表包含一个或多个错误:
 *
 *  重编码值:
 *
 *
 */


```

## 1.15 重编码范围

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  要重编码的变量:（最小值: 1）
 *
 *
 */

/*
 *
 * 无法生成代码，因为以下
 * 选项表包含一个或多个错误:
 *
 *  重编码值:
 *
 *
 */


```

## 1.16 组合表

```sas
/*
 *
 * 未生成代码。
 * 必须选择有效的数据源。 
 * 
 */

/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  必需的匹配列:（最小值: 1）
 *
 *
 */


```

## 2.图形 ---2.1条形图

```sas
/*
 *
 * 无法生成代码，因为以下 
 * 角色未设置: 
 *
 *  类别:（最小值: 1）
 *
 *
 */


```



## 2.2 条线图 -盒形图- 气泡图-热图

## 直方图-线图-马赛克图- 饼图



## 3 地图

## 4 统计分析

## 5 线性模型

## 6生存分析

## 7 多元分析-7.1主成分分析

## 7.2 因子分析

## 8 功效和样本大小

## 9 组合与概率

## 10 预测



## 二-实用程序







# 1.目录（代码段）

## 编辑 源 条目

```sas
ODS HTML5(ID=WEB);
ODS PDF(ID=WEB);
ODS RTF(ID=WEB);

PROC PRINT DATA=SASHELP.CARS; RUN;
ODS _ALL_ CLOSE;

filename entry catalog "work.test.program.source";

data _null_;
file entry;
put "proc print data=sashelp.class;";
put "run;";
run;

/** Now navigate to File Shortcuts and you should be able edit 
    the new source entry. */
    
```

## 列出目录条目

```sas

%macro web_list_entries(catalog,type);

%let typearg=;
%let type=%upcase(&type);
%if &type^=_ALL_ and &type^=_all_ %then %let typearg= entrytype=&type;

proc catalog catalog=&catalog &typearg;
contents;
title "Catalog Entries in &catalog";
run;
quit;

%mend;

%web_list_entries(SASHELP.FSP, _all_);
%web_list_entries(SASHELP.FSP, class);
```



## 列出目录

```sas
%macro web_list_catalogs(library);
	%let library=%upcase(&library);
    proc sql ;
        create table work.catalogs as select memname as Catalog, memtype as 
            Type, engine as Engine from sashelp.vmember where 
            libname="&library" and memtype="CATALOG";
        run;
        title "Catalogs in &library";

    proc print data=work.catalogs;
    run;
%mend;
%web_list_catalogs(SASHELP);
```





# 2.数据---

## DS2 代码

```sas
ODS HTML5(ID=WEB);
ODS PDF(ID=WEB);
ODS RTF(ID=WEB);

PROC PRINT DATA=SASHELP.CARS; RUN;
ODS _ALL_ CLOSE;



/** FOR CSV Files uploaded from Windows **/
FILENAME CSV "<Your CSV File>" TERMSTR=CRLF;
/** FOR CSV File/* Stream an XML representation of SASHELP.CARS directly to the user's browser. */
filename _dataout temp encoding="utf-8";
libname _dataout xml;
data _dataout.cars;
set sashelp.cars;
run;

libname _dataout;
%let _DATAOUT_MIME_TYPE=text/xml;
%let _DATAOUT_NAME=cars.xml;/** Import an XLSX file.  **/

PROC IMPORT DATAFILE="<Your XLSX File>"
		    OUT=WORK.MYEXCEL
		    DBMS=XLSX
		    REPLACE;
RUN;

/** Print the results. **/
PROC PRINT DATA=WORK.MYEXCEL; RUN;ODS HTML5(ID=WEB);
ODS PDF(ID=WEB);
ODS RTF(ID=WEB);
PROC PRINT DATA=SASHELP.CARS; RUN;
ODS _ALL_ CLOSE;
s uploaded from Unix/MacOS **/

FILENAME CSV "<Your CSV File>" TERMSTR=LF;
/** Import the CSV file.  **/
PROC IMPORT DATAFILE=CSV
		    OUT=WORK.MYCSV
		    DBMS=CSV
		    REPLACE;
RUN;

/** Print the results. **/
PROC PRINT DATA=WORK.MYCSV; RUN;
/** Unassign the file reference.  **/
FILENAME CSV;

```



## Ds2 包

```sas
/* DS2 Package */

proc ds2;
package my_package / overwrite=yes;
  dcl double k;
  method my_package();
    put 'Constructor';
  end;

  method delete();
    put 'Destructor';
  end;

  method my_meth(double x) returns double;
    return(x * 2);
  end;
endpackage;
run;

data out(overwrite=yes);
  dcl package my_package p();
  dcl double x;

  method init();
    x = p.my_meth(5);
    put x=;

    p.k = 2112;
    x = p.k;
    put x=;
  end;
enddata;
run; quit;

```





## ds2线程

```sas

/* DS2 Thread Program Template */

proc ds2;
thread thread_pgm / overwrite=yes;
  dcl double x;
  dcl char(32) c;

  method init();
  end;

  method run();
    x = _threadid_;
    c = put(_threadid_, ROMAN.);
    put 'Thread id as a number and Roman character: ' x c;
  end;

  method term();
  end;
endthread;
run;

data out(overwrite=yes);
  dcl thread thread_pgm t;
  method run();
    set from t threads=4;
  end;
enddata;
run; quit;

```



## 生成csv文件

```sas
/* Stream a CSV representation of SASHELP.CARS directly to the user's browser. */

proc export data=sashelp.cars
            outfile=_dataout
            dbms=csv replace;
run;

%let _DATAOUT_MIME_TYPE=text/csv;
%let _DATAOUT_NAME=cars.csv;
```



## 生成powerpoint 幻灯片

```sas
/* Stream powerpoint output directly to the user's browser. */

ods graphics on / border=off;
filename _dataout "&_SASWSTEMP_/SGPlot.pptx";

ods powerpoint file=_dataout;
title 'PROC SGRENDER';
footnote 'ODS Destination for PowerPoint';

title 'Horsepower by Type and Origin';
proc sgplot data=sashelp.cars;
  dot type / response=horsepower limits=both stat=mean
      markerattrs=(symbol=circlefilled size=9);
  xaxis grid;
  yaxis display=(nolabel) offsetmin=0.1;
  keylegend / location=inside position=topright across=1;
  run;

ods powerpoint close;

%let _DATAOUT_MIME_TYPE=application/vnd.openxmlformats-officedocument.presentationml.presentation;
%let _DATAOUT_NAME=sgplot.pptx;

```



## 生成 xml 文件

```sas
/* Stream an XML representation of SASHELP.CARS directly to the user's browser. */

filename _dataout temp encoding="utf-8";
libname _dataout xml;

data _dataout.cars;
set sashelp.cars;
run;

libname _dataout;

%let _DATAOUT_MIME_TYPE=text/xml;
%let _DATAOUT_NAME=cars.xml;
```



## 导入csv 文件

```sas
/** FOR CSV Files uploaded from Windows **/
FILENAME CSV "<Your CSV File>" TERMSTR=CRLF;
/** FOR CSV Files uploaded from Unix/MacOS **/
FILENAME CSV "<Your CSV File>" TERMSTR=LF;
/** Import the CSV file.  **/
PROC IMPORT DATAFILE=CSV
		    OUT=WORK.MYCSV
		    DBMS=CSV
		    REPLACE;
RUN;
/** Print the results. **/
PROC PRINT DATA=WORK.MYCSV; RUN;
/** Unassign the file reference.  **/
FILENAME CSV;

```





## 导入xlsx文件

```sas
/** Import an XLSX file.  **/

PROC IMPORT DATAFILE="<Your XLSX File>"
		    OUT=WORK.MYEXCEL
		    DBMS=XLSX
		    REPLACE;
RUN;

/** Print the results. **/

PROC PRINT DATA=WORK.MYEXCEL; RUN;
```



## 模拟线性回归数据

```sas
/* Simulate linear regression data */
data regdata;
   call streaminit(112358);
   keep x1-x3 y;
   b0 = 4; b1 = 0.8; b2 = 1.2; b3 = 2.4;
   do i=1 to 100;
      x1 = rand( 'NORMAL',5,0.5 );
      x2 = rand( 'NORMAL',8,0.3 );
      x3 = rand( 'NORMAL',6,0.1 );
      epsilon = rand( 'NORMAL',0,0.8 );
      y = b0 + b1*x1 + b2*x2 + b3*x3 + epsilon;
      output;
   end;
run;
proc print;
run;
```

## 模拟单因子 anova数据

```sas
/* Simulate one-way ANOVA data */

data onewayanovadata;
   call streaminit(112358);
   drop n;
   do n = 1 to 100;
      treatment = rand( 'TABLE', .2, .4, .4);
      if treatment = 1 then response = rand( 'NORMAL', 10, 0.8 );
      else 
      if treatment = 2 then response = rand( 'NORMAL', 11, 0.8 );
      else 
      if treatment = 3 then response = rand( 'NORMAL', 15, 0.8 );  
      output;
   end;
run;
  
proc print;
run;

```



# 3.描述---

## 自定义 obs 输出

```sas
ODS HTML5(ID=WEB);
ODS PDF(ID=WEB);
ODS RTF(ID=WEB);

PROC PRINT DATA=SASHELP.CARS; RUN;
ODS _ALL_ CLOSE;



/** FOR CSV Files uploaded from Windows **/

FILENAME CSV "<Your CSV File>" TERMSTR=CRLF;

/** FOR CSV File/* Stream an XML representation of SASHELP.CARS directly to the user's browser. */

filename _dataout temp encoding="utf-8";
libname _dataout xml;

data _dataout.cars;
set sashelp.cars;
run;

libname _dataout;

%let _DATAOUT_MIME_TYPE=text/xml;
%let _DATAOUT_NAME=cars.xml;/** Import an XLSX file.  **/

PROC IMPORT DATAFILE="<Your XLSX File>"
		    OUT=WORK.MYEXCEL
		    DBMS=XLSX
		    REPLACE;
RUN;

/** Print the results. **/

PROC PRINT DATA=WORK.MYEXCEL; RUN;ODS HTML5(ID=WEB);
ODS PDF(ID=WEB);
ODS RTF(ID=WEB);

PROC PRINT DATA=SASHELP.CARS; RUN;
ODS _ALL_ CLOSE;

s uploaded from Unix/MacOS **/

FILENAME CSV "<Your CSV File>" TERMSTR=LF;

/** Import the CSV file.  **/

PROC IMPORT DATAFILE=CSV
		    OUT=WORK.MYCSV
		    DBMS=CSV
		    REPLACE;
RUN;

/** Print the results. **/

PROC PRINT DATA=WORK.MYCSV; RUN;

/** Unassign the file reference.  **/

FILENAME CSV;

```







## proc sql

```sas
/* 代码1 */

DATA exmp;
	INPUT age sex $ height weight @@;
	CARDS;
	25 f 50 160 26 m 56 163
	33 m 62 167 30 f 58 159
	……
RUN;

PROC PRINT;
RUN;

/* 代码2 */
data test1;
input a ;
cards;
a1 b1
a2 b2
a3 b3
a4 b4
;
run;


SAS Studio 旨在助您尽可能快而准确地编写您的 SAS 程序。
从导航窗格的“逻辑库”部分中，您可以访问所有逻辑库以及逻辑库中的表。
若您想查看表中各列的名称，可以展开表并查看所有列。
编写程序时，可将项从“逻辑库”部分拖至您的程序来节省时间。
SAS Studio 会为您将拖动项的代码添加至您的程序。
要查看这是如何实现的，请回到最初使用的原始程序：

proc print data=sashelp.class;
run;

/* 您的程序应与下面类似： */


proc print data=sashelp.class;
var age height name;
run;


proc sql;
libname asd "/Users/tianzi/Desktop/2019049SHR3680-SHR3162-Ⅱ-CRPC/3\ STATISTICS/SDTM/SDTM_rawdata/2019049SHR3680-SHR3162-Ⅱ-CRPC_原始数据库_20191129sas";
quit;




PROC SQL;

	CREATE TABLE WORK.QUERY

	AS

	SELECT * FROM SASHELP.CARS;

RUN;
QUIT;

PROC PRINT DATA=WORK.QUERY; RUN;



proc sql;
select * from exmp;

quit;

```

# 4.图形---

## 条形图面板

```sas
%macro web_list_catalogs(library);
	%let library=%upcase(&library);
    proc sql ;
        create table work.catalogs as select memname as Catalog, memtype as 
            Type, engine as Engine from sashelp.vmember where 
            libname="&library" and memtype="CATALOG";
        run;
        title "Catalogs in &library";

    proc print data=work./*--Bar Panel--*/

title 'Mileage by Origin and Type';
proc sgpanel data=sashelp.cars(where=(type in ('Sedan' 'Sports'))) noautolegend;
  panelby Type / novarname columns=2 onepanel;
  vbar origin / response=mpg_city stat=mean group=origin;
  rowaxis grid;
  run;
catalogs;
    run;
%mend;

%web_list_catalogs(SASHELP);
/* Stream a CSV representation of SASHELP.CARS directly to the user's browser. */

proc export data=sashelp.cars
            outfile=_dataout
            dbms=csv replace;
run;

%let _DATAOUT_MIME_TYPE=text/csv;
%let _DATAOUT_NAME=cars.csv;
```

## 盒形图面板

```sas
/*--Box Panel--*/

title 'Cholesterol by Weight and Sex';
proc sgpanel data=sashelp.heart(where=(weight_status ne 'Underweight'));
  panelby weight_status / novarname;
  vbox cholesterol / category=sex;
  rowaxis grid;
  run;

```





## 比较散点图

```sas
/*--Comparative Scatter Plot--*/

title 'Mileage by Horsepower and Weight';
proc sgscatter data=sashelp.cars(where=(type in ('Sedan' 'Sports')));
  label mpg_city='City';
  label mpg_highway='Highway';
  compare x=(mpg_city mpg_highway) y=(horsepower weight) /
     transparency=0.8 markerattrs=graphdata1(symbol=circlefilled);
  run;



```

## 点图

```sas

/*--Dot Plot--*/

title 'Horsepower by Type';
proc sgplot data=sashelp.cars;
  dot type / response=horsepower limits=both stat=mean
      markerattrs=(symbol=circlefilled size=9);
  xaxis grid;
  yaxis display=(nolabel) offsetmin=0.1;
  keylegend / location=inside position=topright across=1;
  run;

```



## 拟合图

```sas
/*--Fit Plot--*/

title 'Mileage by Horsepower for USA';
proc sgplot data=sashelp.cars(where=(origin='USA'));
  reg x=horsepower y=mpg_city / degree=2 clm='CL Mean';
  keylegend / location=inside position=topright across=1;
  xaxis grid;
  yaxis grid;
  run;

```





## 水平条形图

```sas
/*--HBar Plot--*/

title 'Mileage by Type';
proc sgplot data=sashelp.cars ;
  hbar type / response=mpg_city  stat=mean  limits=both;
  yaxis display=(nolabel) grid;
  xaxis display=(nolabel);
  run;


```





## 高低图

```sas
/*--HBar Plot--*/

title 'Mileage by Type';
proc sgplot data=sashelp.cars ;
  hbar type / response=mpg_city  stat=mean  limits=both;
  yaxis display=(nolabel) grid;
  xaxis display=(nolabel);
  run;
/*--HighLow Plot--*/

title 'Monthly Stock Price for IBM';
proc sgplot data=sashelp.stocks(where=(stock eq 'IBM' and date > '01Jan2003'd));
  highlow x=date high=high low=low / open=open close=close
      lineattrs=(thickness=2) y2axis;
  xaxis display=(nolabel);
  y2axis display=(nolabel) grid;
  run;

```





## 直方图

```sas
/*--Histogram--*/

title 'Distribution of Mileage';
proc sgplot data=sashelp.cars(where=(type ne 'Hybrid'));
  histogram mpg_city;
  density mpg_city / lineattrs=(pattern=solid);
  density mpg_city / type=kernel lineattrs=(pattern=solid);
  keylegend / location=inside position=topright across=1;
  yaxis offsetmin=0 grid;
run;



```





## 散点图矩阵

```sas
/*--Scatter Plot Matrix--*/

title 'Vehicle Profile';
proc sgscatter data=sashelp.cars(where=(type in ('Sedan' 'Sports')));
  label mpg_city='City';
  label mpg_highway='Highway';
  matrix mpg_city mpg_highway horsepower weight /
     transparency=0.8 markerattrs=graphdata3(symbol=circlefilled);
  run;

```







## 垂直盒行图

```sas
/*--VBox Plot--*/

title 'Mileage by Type and Origin';
proc sgplot data=sashelp.cars(where=(type in ('Sedan' 'Sports'))) ;
  vbox mpg_city / category=origin group=type groupdisplay=cluster
    lineattrs=(pattern=solid) whiskerattrs=(pattern=solid);
  xaxis display=(nolabel);
  yaxis grid;
  keylegend / location=inside position=topright across=1;
  run;

```





# 5-iml  

## 求解非线性方差的根

```sas
/* Find the root of a function of one variable.  Example taken from 
   R. Wicklin, "A simple way to find the root of a function of one variable",
   The DO Loop blog, published Feb 4, 2014.
   URL: http://blogs.sas.com/content/iml/2014/02/05/find-the-root-of-a-function/ 
*/

proc iml;
/* define a function that has one or more zeros */
start Func(x);
   return( exp(-x##2) - x##3 + 5#x +1 );
finish;

if num(symget("SYSVER"))>=9.4 then do;
   /* plot the function to get an idea of how many roots there
      are and approximately where they are located */
   x = do(-4, 4, 0.1);
   y = Func(x);
   call Series(x, y) 
	grid="x" other="refline 0 / axis=y"; /* reference line */
end;

/* Specify three intervals to search for roots */
intervals = {-4   -1.5,         /* 1st interval [-4, -1.5] */
             -1.5  1  ,         /* 2nd interval [-1.5 1]   */
              1    4  };        /* 3rd interval [1, 4]     */
Roots = froot("Func", intervals);
print Roots;
quit;

```





## 使用最大似然拟合

```sas
/* Use maximum likelihood estimation to estimate parameters for 
   normal density estimate. Example taken from 
   R. Wicklin, "Maximum likelihood estimation in SAS/IML",
   The DO Loop blog, published Oct 12, 2011.
   URL: http://blogs.sas.com/content/iml/2011/10/12/maximum-likelihood-estimation-in-sasiml/ 

You can use SAS/IML software to fit a parametric density to data. 
1. Write a SAS/IML module that computes the log-likelihood function. 
2. Specify constraints for the parameters. 
3. Call a nonlinear optimization routines to maximize the log-likelihood.
*/
%let DSName = Sashelp.Iris;
%let VarName = SepalWidth;

proc iml;
/* write the log-likelihood function for Normal dist */
start LogLik(param) global (x);
   mu = param[1];
   sigma2 = param[2]##2;
   n = countn(x);         /* count nonmissing values */
   f = -n/2*log(sigma2) - 1/2/sigma2*ssq(x-mu);
   return ( f );
finish;

/* read data */
use &DSName;
read all var {&VarName} into x;
close &DSName;
/* Specify initial guess for parameters that is close to 
   p = mean(x) || std(x); */
p = {35 5.5};

/*     mu-sigma constraint matrix */
con = { .   0,  /* lower bounds: -infty < mu; 0 < sigma     */
        .   .}; /* upper bounds:  mu < infty; sigma < infty */
opt = {1,       /* find maximum of function                 */
       0};      /* print iteration history? 0=no; 1=yes     */
call nlpnra(rc, MLE, "LogLik", p, opt, con);
print MLE[c={"mu" "sigma"}]; /* maximum likelihood estimates */

/* Optional: plot histogram with density overlay.
   The SUBMIT and ENDSUBMIT statements enable you to call
   SAS procedures from within a SAS/IML program.  You can 
   pass parameters to the procedure. See
   R. Wicklin, "Passing values from PROC IML into SAS procedures",
   The DO Loop blog, published Jun 3, 2013.
   http://blogs.sas.com/content/iml/2013/06/03/passing-values-into-procedures/
*/
submit mu=(MLE[1]) sigma=(MLE[2]);
   proc sgplot data=&DSName;
   histogram &VarName;
   density &VarName / type=normal(mu=&mu sigma=&sigma);
   run;
endsubmit;

quit;

```





## 生成 bootstrap

```sas

/* Bootstrap distribution of the sample mean.  Example taken from 
   R. Wicklin (2010), Statistical Programming with SAS/IML Software,
   SAS Press: Cary, NC, pp. 350-356.
*/
%let DSName = Sashelp.Cars;
%let VarName = MPG_City;
%let alpha = 0.05;  /* significance; (1-alpha)100% conf limits */

proc iml;
use &DSName;
read all var {&VarName} into x;
close &DSName;

/* Resample B times from the data (with replacement) 
   to form B bootstrap samples. */
B = 5000;                          /* number of bootstrap samples */
call randseed(12345);
xBoot = Sample(x, B||nrow(x));     /* each column is a resample */

/* Compute the statistic on each bootstrap resample */   
s = T( mean(xBoot) );              /* mean of each resample     */
title "Bootstrap distribution of the mean";
if num(symget("SYSVER"))>=9.4 then do;
   call Histogram(s) density="Kernel"; /* graph bootstrap distrib  */
end; 

Mean = mean(x);                    /* sample mean of original data  */
/* Analyze the bootstrap distribution */
MeanBoot = s[:];                   /* a. mean of bootstrap dist     */
StdErrBoot = std(s);               /* b. estimate of std error      */
prob = &alpha/2 || 1-&alpha/2;     /* lower/upper percentiles       */
call qntl(CIBoot, s, prob);        /* c. quantiles of bootstrap dist*/
pct = putn(1-&alpha, "PERCENT5.");

print Mean MeanBoot StdErrBoot 
      (CIBoot`)[c=("Lower "+pct+" CL" || "Upper "+pct+" CL")];
quit;
title;

/* By the Central Limit Theorem, the sampling distribution of
   the mean is approximately normally distributed. 
   If desired, compare the bootstrap estimates with 
   estimates of the SEM and CLM that assume normality. */
/*
proc means data=&DSName mean stderr clm alpha=&alpha;
var &VarName;
run;
*/

```





## 函数求积分

```sas
/* Numerical integration by using SAS/IML software. 
   Example taken from 
   R. Wicklin, "How to numerically integrate a function in SAS",
   The DO Loop blog, published May 6, 2011.
   URL: http://blogs.sas.com/content/iml/2011/05/06/how-to-numerically-integrate-a-function-in-sas/ 

You can use SAS/IML software to numerically integrate a function. 
1. Write a SAS/IML module that evaluates the integrand. 
2. Call the QUAD subroutine to integrate the function on the interval [a,b].
*/
proc iml;

start SimpleFunc(x);
   return( cos(x) );
finish;
 
/* integrate function on [0, pi/2] */
pi = constant("PI");
a = 0;    
b = pi / 2; 
call quad(Integral1, "SimpleFunc", a||b); 

/* compare with exact answer */
Answer1 = sin(b) - sin(a);
diff = Answer1 - Integral1;
print Integral1 Answer1 diff;

/*********************/
/* a harder integral */
/*********************/
start TrigFunc(x);
   return( 5 - 2*tan(x)/cos(x) );
finish;

/* integrate function on [pi/6, pi/4] */
a = pi / 6;    
b = pi / 4;  
call quad(Integral2, "TrigFunc", a||b);

/* compare with exact answer */
Answer2 = 5*pi/12 - 2*sqrt(2) + 4/sqrt(3);
diff = Answer2 - Integral2;
print Integral2 Answer2 diff;

if num(symget("SYSVER"))>=9.4 then do;
   /* optional: plot the function on [a,b] */
   x = do(a,b,0.01);
   title "f(x) = 5 - 2 tan(x)/cos(x)";
   call Series(x, TrigFunc(x)) other="band x=x upper=y lower=0";
   title;
end;
quit;
```





## 模拟多元正态数据

```sas

/* Simulate data from a multivariate normal distribution 
   with a specified mean and covariance. Example taken from
   R. Wicklin (2013) Simulating Data with SAS, SAS Press: Cary, NC, 
   pp. 133-135.
*/
proc iml;
/* specify the mean and covariance of the population */
VarNames = 'x1':'x3';
Mean = {1, 2, 3};
Cov = {3 2 1, 
       2 4 0,
       1 0 5};
 
NumSamples = 1000;
call randseed(4321);
X = RandNormal(NumSamples, Mean, Cov);

/* X has 3 columns and 1000 rows.
   Check that the sample mean and covariance are close to 
   the population values. */
SampleMean = mean(X);
SampleCov = cov(X);
print SampleMean[c=varNames], 
      SampleCov[c=varNames r=varNames];

/* optional: plot the simulated data */
create _Temp from X[c=varNames];
append from X;
close _Temp;
submit;
   proc sgscatter data=_Temp; 
      matrix x1-x3 / diagonal=(histogram normal);
   run;
endsubmit;
call delete(_Temp);

quit;

```





# 6- 宏 ---

##  sas 宏

```sas
%MACRO printTable(table);
PROC PRINT DATA=&TABLE;RUN;
%MEND;
%printTable(SASHELP.CARS);

```

格式化代码

```sas
%MACRO printTable(table);
	PROC PRINT DATA=&TABLE;
	RUN;

%MEND;

%printTable(SASHELP.CARS);
```

## sas 宏变量

```sas
/*----------------------------------------------*/
  /*      Macro Variables                        */
  /*----------------------------------------------*/
用户定义的全局变量
/* User Defined Global Variables */
%let city=Dallas;
%let date=25APR2014;
%let amount=343;

/* User Defined Local Variables */
%macro lvars;
   %local name day;
   %let name=Ed Norton;
   %let day=Friday;
   %put _local_;
%mend;

/* When we run this we will see the Local Variables in %lvar */
%lvars

/* This shows all global user and automatic macro variables */
%put _all_;%MACRO printTable(table);
	PROC PRINT DATA=&TABLE;
	RUN;

%MEND;

%printTable(SASHELP.CARS);
```





## sas 宏 do语句

```sas

/*----------------------------------------------*/
  /*      Macro Variables                        */
  /*----------------------------------------------*/

/* User Defined Global Variables */
%let city=Dallas;
%let date=25APR2014;
%let amount=343;

/* User Defined Local Variables */
%macro lvars;
   %local name day;
   %let name=Ed Norton;
   %let day=Friday;
   %put _local_;
%mend;

/* When we run this we will see the Local Variables in %lvar */
%lvars /*----------------------------------------------*/
 /*       %DO  statement                         */
 /*----------------------------------------------*/

 %macro shownote(length);
    %if &length = LONG %then %do;
       %put NOTE: This is a longer note.;
       %put NOTE: It is shown if the macro parameter is set to the value LONG.;
       %put NOTE: The default note is much shorter.;
    %end;
    %else %put NOTE: This is a short note;
%mend shownote;

%shownote(LONG)

  /* results should be:
  
 NOTE: This is a longer note.
 NOTE: It is shown if the macro parameter is set to the value LONG.
 NOTE: The default note is much shorter.
 
 */

/* This shows all global user and automatic macro variables */
%put _all_;%MACRO printTable(table);
	PROC PRINT DATA=&TABLE;
	RUN;

%MEND;

%printTable(SASHELP.CARS);
```





## sas宏 if 语句

```sas
 /*----------------------------------------------*/
  /*       %IF  statement                         */
  /*----------------------------------------------*/

  %macro testif;
      %local x y z;
      %let x=10;
      %let y=5;
      %let z=0;
      %if &x > &y %then %put test 1 successful;
      %else %put test 1 failed;
      %if &x < &y %then %put test 2 failed;
      %else %put test 2 successful;
      %if &x %then %put test 3 successful;
      %else %put test 3 failed;
      %if &z %then %put test 4 failed;
      %else %put test 4 successful;
   %mend testif;

   %testif

  /* results should be:
test 1 successful
test 2 successful
test 3 successful
test 4 successful
*/
```

## Sas 宏参数

```sas
/*----------------------------------------------*/
  /*       Macro Parameters                       */
  /*----------------------------------------------*/


/* Positional Parameters */

%macro pospar(var1,var2,var3,var4,var5);
      %put &var1 &var2 &var3 &var4 &var5;
  %mend pospar;

  %pospar();

  /* results should be: *blank*  */


  %pospar(str1,str2,str3,str4,str5)


  /*  results should be: str1 str2 str3 str4 str5  */

  %pospar(str1)

  /* results should be: str1  */


/* Keyword Parameters  */

  %macro keypar(var1=str1,var2=str2,var3=);
  %put &var1 &var2 &var3;
  %mend keypar;

  %keypar();

  /* results should be: str1 str2  */


  %keypar();

  /* results should be: str1 str2  */

  %keypar(var1=abc,var2=def,var3=ghi)

  /* results should be: abc def ghi */


```





## Sas 宏 引用

```sas
  /*----------------------------------------------*/
  /*       Macro Quoting                          */
  /*----------------------------------------------*/


  %macro m;
    %put this is macro m;
  %mend m;

  %let p=%str(proc print; run;);
  %put p = &p;

  /* results should be:  p = proc print; run; */


  %let m=%nrstr(look at macro %m and var &m);
  %put m = &m;

  /* results should be: m = look at macro %m and var &m */


 data test;
    store="Tom's place";
    call symput('s',store);
run;

%macro test;
   %if %bquote(&s) ne %then %put *** valid ***;
   %else %put *** null value ***;
%mend test;
%test;

 /* results should be:  *** valid *** */


 %let bqtvar=%str(macro%'s here!);
     %put bqtvar = &bqtvar;

  /* results should be: bqtvar = macro's here! */


 %let nbqtvar=%nrstr(macro%'s and &procs);
 %put nbqtvar = &nbqtvar;

  /*---------------------------
   results should be:
      nbqtvar = macro's and &procs
   ---------------------------*/


  %put superqed variable = %superq(nbqtvar);

  /* results should be:  superqed variable = macro's and &procs */


  %let qsc=%qscan(&nbqtvar,1);
  %put qsc = &qsc;

  /* results should be: qsc = macro's  */


  %let qsu=%qsubstr(&nbqtvar,1,7);
  %put qsu = &qsu;

  /* results should be: qsu = macro's */


  %let qsp=%qupcase(&nbqtvar);
  %put qsp = &qsp;

  /* results should be:  qsp = MACRO'S AND &PROCS */


  %let mvar=%nrstr(%m);
  %put mvar = %unquote(&mvar);

  /*---------------------------
    results should be:
this is macro m
mvar =
   ---------------------------*/
```



## Sas 宏 char 函数

```sas
/*----------------------------------------------*/
  /*       Macro Char Functions                   */
  /*----------------------------------------------*/


  /*------------------------------*/
  /*       %EVAL FUNCTION         */
  /*------------------------------*/

  %let num1=%eval(32767+7233);
  %put &num1 should be 40000;


  /*------------------------------*/
  /*       %INDEX FUNCTION        */
  /*------------------------------*/

  %let a=a very long value;
  %let b=%index(&a,v);
  %put v appears at position &b..;         /* at 3 */

  /*------------------------------*/
  /*       %LENGTH FUNCTION       */
  /*------------------------------*/

  %macro aproc;
     proc print; run;
  %mend aproc;

  %put %length(&a) should be 17;

  %put %length(%aproc) should be 16;

  /*------------------------------*/
  /*       %SCAN FUNCTION         */
  /*------------------------------*/

	%LET P=CATS AND DOGS;
	%LET Q=%SCAN(&P,3,%str( ));
	%put &q SHOULD BE DOGS;


  /*-------------------------------*/
  /*      %substr function         */
  /*-------------------------------*/

   %LET FIRST=THIS BOOK;
   %LET SECOND=%SUBSTR(&FIRST,6,4);
   %put &second SHOULD BE BOOK;


  /*-------------------------------*/
  /*      %UPCASE function         */
  /*-------------------------------*/

  %let string=%upcase(a string to upcase);
  %put &string should be A STRING TO UPCASE;
```

