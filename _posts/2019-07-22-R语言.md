---
layout: post
title: "R语言学习"
date: 2019-07-22
tag: lang
---





## R终端

```
➜  ~ git:(master) ✗ R

R version 3.6.1 (2019-07-05) -- "Action of the Toes"
Copyright (C) 2019 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin15.6.0 (64-bit)

R是自由软件，不带任何担保。
在某些条件下你可以将其自由散布。
用'license()'或'licence()'来看散布的详细条件。

R是个合作计划，有许多人为之做出了贡献.
用'contributors()'来看合作者的详细情况
用'citation()'会告诉你如何在出版物中正确地引用R或R程序包。

用'demo()'来看一些示范程序，用'help()'来阅读在线帮助文件，或
用'help.start()'通过HTML浏览器来看帮助文件。
用'q()'退出R.

> rep(1:3,2)
[1] 1 2 3 1 2 3
> rep(1:3 ,c(2,1,2))
[1] 1 1 2 3 3
> rep(1:3,each= 2,length.out = 4)
[1] 1 1 2 2

➜  go git:(master) ✗ cd  ../R       
进入指定文件夹；
➜  R git:(master) ✗ Rscript r.r
[1] "hello"
➜  R git:(master) ✗ 

> q()
Save workspace image? [y/n/c]: y
n直接退出，c是继续写
直接给我显示退出R工具，提示保存，不能直接结束当前的程序
➜  R git:(master) ✗ 

```









## 编译环境

**mac搭建R环境**

**1.什么是R**

R是用于统计分析、绘图的语言和操作环境。R是属于GNU系统的一个自由、免费、源代码开放的软件，它是一个用于统计计算和统计制图的优秀工具。简单来说，R是一门统计计算语言，是一套开源的数据分析解决方案。

**2.什么是RStudio**

RStudio是一款R语言的IDE，R自带的环境操作起来可能不是方便，而Rstudio很好地解决了这个问题，而且它还具有调试、可视化等功能，支持纯R脚本、Rmarkdown (脚本文档混排)、Bookdown (脚本文档混排成书)、Shiny (交互式网络应用)等。

**3.R和RStudio安装前说明**

安装顺序：①R    ②RStudio
R是RStudio的基础，必须先安装R，再安装RStudio。
即使只使用RStudio，还是需要事先为计算机安装好R。
RStudio只是辅助你使用R进行编辑的工具，因为它自身并不附带R程序。



```
step1：登录R的官方网站
https://www.r-project.org/

https://mirrors.tuna.tsinghua.edu.cn/CRAN/ 

```

```
1 Windows：

键入 cd C:\Program Files\R\R-3.2.0\bin   工作目录切换到R的核心程序目录
键入 R BATCH F:\Test.R 或 Rscript F:\Test.R 运行脚本
前者R控制台内容记录到Test.Rout文件中，后者则将数据输出到windows控制台。二者涉及文件创建都需要权限。
后者也是linux下运行R脚本的命令。

 

2 Linux：

R  --no-save  <  step1.R  >temp001

```



r.r**文件**

```r
sayHello <- function(){
   print('hello')
}

sayHello()



# [1] "hello"
# [Finished in 0.9s]
```











##                          R语言学习笔记

常用函数

**1****、聚类**

§  常用的包： fpc，cluster，pvclust，mclust

§  基于划分的方法: kmeans, pam, pamk, clara

§  基于层次的方法: hclust, pvclust, agnes, diana

§  基于模型的方法: mclust

§  基于密度的方法: dbscan

§  基于画图的方法: plotcluster, plot.hclust

§  基于验证的方法: cluster.stats

**2****、分类**

§  常用的包

§  rpart，party，randomForest，rpartOrdinal，tree，marginTree，maptree，survival

§  决策树: rpart, ctree

§  随机森林: cforest, randomForest

§  回归, Logistic回归, Poisson回归: glm, predict, residuals

§  生存分析: survfit, survdiff, coxph

**3****、关联规则与频繁项集**

§  常用的包

§  arules：支持挖掘频繁项集，最大频繁项集，频繁闭项目集和关联规则

§  DRM：回归和分类数据的重复关联模型

§  APRIORI算法，广度RST算法：apriori, drm

§  ECLAT算法： 采用等价类，RST深度搜索和集合的交集： eclat

**4**、序列模式**

§  常用的包： arulesSequences

§  SPADE算法： cSPADE

**5**、时间序列

§  常用的包： timsac

§  时间序列构建函数： ts

§  成分分解: decomp, decompose, stl, tsr

**6**、统计

§  常用的包： Base R, nlme

§  方差分析: aov, anova

§  密度分析: density

§  假设检验:  t.test, prop.test, anova, aov

§  线性混合模型：lme

§  主成分分析和因子分析：princomp

**7****、图表**

§  条形图: barplot

§  饼图: pie

§  散点图: dotchart

§  直方图: hist

§  密度图: densityplot

§  蜡烛图, 箱形图 boxplot

§  QQ (quantile-quantile) 图: qqnorm, qqplot, qqline

§  Bi-variate plot: coplot

§  树: rpart

§  Parallel coordinates: parallel, paracoor, parcoord

§  热图, contour: contour, filled.contour

§  其他图: stripplot, sunflowerplot, interaction.plot, matplot, fourfoldplot,
 assocplot, mosaicplot

§  保存的图表格式: pdf, postscript, win.metafile, jpeg, bmp, png

**8****、数据操作**

§  缺失值：na.omit

§  变量标准化：scale

§  变量转置：t

§  抽样：sample

§  堆栈：stack, unstack

§  其他：aggregate, merge, reshape

**9****、与数据挖掘软件Weka****做接口**

§  RWeka: 通过这个接口，可以在R中使用Weka的所有算法。

安装程序包

**1** **用函数 install.packages()**

**2** **安装本地zip****包**

**路径：Packages>install packages from local files**

**查看安装的包 installed.packages()**

**检查更新 old.packages()**

**更新update.packages()**

 

帮助

l  查看帮助文档

**?install.package()**  

**help(“install.package”)**

l  函数帮助

**?function**

**help(‘function’)**

l  html帮助

**Help.start()**

**帮助>Html****帮助**

l  关键词搜索

**RSiteSearch(‘word’)**

数据类型

**向量**

l  创建向量

c( ),创建向量

length( ), 向量长度

删除向量vector[-n]，即删除第n个向量

mode( ), 向量类型

rbind( ), 向量元素都作为一行row

cbind( ) ，向量元素都作为一列col

*******创建向量序列**

```
seq(from, to, by = ((to - from)/(length.out - 1)),length...),
length是总长度（个数），因此by就是间隔
rep(mode,time) 产生mode 重复time次的向量
letters[n:m]  产生字符向量
rnorm(n,mean=…,sd=…) 随机序列
```

l  取子集

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  值范围限制

如：V(x>m|x<n)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  索引坐标限制

如：V[c()]，V[1:3]

l  创建向量空间

V=vector()

创建向量空间后就可以对向量元素进行赋值

l  常用计算函数

mean(x ), 

sum( x), 

min( x), max( x), 

var( x), 方差

sd( x), 标准差

cov(x), 协方差

cor(x), 相关度

prod(x )，所有值相乘的积

which(x的表达式)，which.min(x)，which.max(x)

rev(x)，反转

sort(x)，排序

**因子**

因子是用水平来表示所有可能取的值

![*](../images/posts/icon/clip.gif)  ![*](/images/posts/icon/clip.gif)

- 创建（转换）因子

factor(v,level=vl) level不指定则默认v中所有值

gl(k,n)   k是因子的水平个数，n是每个水平重复的个数

- 因子统计

nlevels(factor) 查看因子水平

table(factor) 频数

prop.table(factor) 概率

- 交叉统计

对于两个向量进行统计会构成一张交叉的表table(factor1,,factor2)

向量命名

names(v)=c(“area1”,”area2”,…)，命名后就可以按名称取值了，v[“area1”]

 

**矩阵**

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  创建矩阵

1.matrix(v, nrow = 1, ncol = 1, byrow = FALSE)，一列（不是行）一列的分配，当数据不够时候就会重复

​       2.dim(x)=value  value是一个向量，指定行数列数，分配方式与上面一样

​       3.另外就是通过rbind()绑定多个向量

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  行列命名

colnames(matrix)=c(“”,””,…)

rownames(matrix)=c(“”,””,…)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  矩阵运算

矩阵相乘：A%*%B

t(matrix)，矩阵转置

diag(matrix )，矩阵的对角（向量）；diag(diag(matrix ))，对角矩阵

solve(matrix)，矩阵求逆

eigen( matrix )，特征值和特征向量

svd(matrix)，奇异值分解，返回X包含属性U、d、V

**工作空间对象**

**ls()**   列举所有对象

**rm()**  删除对象

 

**数据框**

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **创建数据框**

data.frame(x1,x2,…)或带上列的名称data.frame(x1.name=x1,x2.name=x2,…)

在创建数据框的时候，字符串的列会自动的转换成因子，以方便统计

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **数据框取值**

data[x,y]（取单个值）  

data[x]（取第x列的数据组成的数据框）  

data[x,]（取第x行的数据） 

data[,y]（取第y列的数据）  

data[a:b,y]（取a-b行的第y列的数据）

data[c(“colName1”,” colName1”,””,…)] ，根据列名进行访问

**注意**：data[x]与 data[,y]的不同，data[,y]取值后返回的是一个一维向量

ü  **限定取值**

可以通过限制列的范围来取子集，但**此时同时一定要指定取哪些列，如**

**data[data$col>k,c(“col1”,”col2”,…)]****，用****attach(**data**)****可以简化这一步操作，即在****attach****之后可以直接访问列（所有），****data[data$col>k]****，用****detach****可以解除。**

另一种控制条件查询的方式即通过subset函数取子集

Subset(data,colName>k)，此时colName是数据框的一个列属性

ü  **筛选**

which()函数进行筛选，which中是筛选条件，如：is.na()…

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **编辑数据**edit(data)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **查看数据框属性**

查看数据维度：dim(data)  返回：行，列

单独查看行数列数：nrow(data)、ncol(data)

查看列名：names(data)，同时修改列名：names(data)=c(“”,””,…)

查看数据结构：str(data)

查看属性（列名$names、类$class、列$row.names），attributes(data)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **添加一列**

data$addCol=c(“”,””,…)，添加列的元素应与原来的行数相等

merge(dataframeA,dataframeB,by=c(“”,””,…))，横向合并（添加多列）

数据操作

**数据处理**

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  变量重命名，调用fix(data)，出现一个交互式工具；或者rename(dataframe,c(oldname=”newname,…”))

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  类型转换：is.datatype()判断，as.datatype()转换

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  字符串处理：nchar()，计算字符数量

substr(x,start,stop)

grep(pattern,v)，返回向量坐标

sub(pattern,replacement,x)，替换

strsplit(x,split)分割

paste(x,c(),sep=””)，在x后面（向量个数）连接c()向量，以sep分隔

cat(“str1”,”str2”,…)，连接字符串

toupper()

tolower()

**读取文件数据**

**data=read.table(”****位置”, header=T)**                **读取文本文件**

**data=read.csv(”****位置”,header=T)**                     **读取csv****文件**

在数据导入R语言后，会以数据框(dataframe)的形式储存。dataframe是一种R的数据格式，可以将它想象成类似统计表格，每一行都代表一个样本点，而每一列则代表了样本的不同属性或特征。初学者需要掌握的基本操作方法就是dataframe的编辑、抽取和运算。

**数据库操作**

1、配置数据元

安装connector

配置数据源（控制面板à管理工具à数据源）

2、连接数据库

odbcConnect(data_src,uid=" ",pwd=" ")

3、查询

这个是一个通用类型的操作，即可以查询，又可以添加删除修改

sqlQuery(channel,"sql")

4、更新数据库表，并读取数据（问题暂未解决）

sqlSave(channel,mydata,'NEW_TABLE_NAME',append = TRUE)

表若不存在则新建，默认以数据框命名。mydata数据框：data.frame()函数建立

 

**描述统计**

l  统计函数

mean()

Median()

var()

mad()，绝对中位差

quantile(x,probs)，求分位数

range()，值域

sum()

diff(v,lag=n)，滞后差分

min()

max()

scale()，按列标准化

l  概率函数

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  分布函数

Beta分布 beta()

柯西分布 cauchy()

卡方分布 chisq()

t分布 t()

F分布 f()

Logistic分布 logis()

均匀分布 unif()

正态分布函数rnorm( )

对数正态分布 lnorm()

多项分布 mutinom()

泊松分布函数pois( )

指数分布函数exp( )

Gamma分布函数gamma( )

均匀分布函数unif( )

二项分布函数binom( )

​     几何分布函数geom( ) 

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  将这些分布函数加上第一个字母：d=密度函数

p=分布函数

q=分位数函数

r=**生成随机数** 

l  统计与整合（分组）

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  summary()

描述统计是一种从大量数据中压缩提取信息的工具，最常用的就是**summary**命令，运行summary(data)得到结果如下：对于数值变量计算了**五个分位点**和**均值**，对于分类变量则计算了**频数（显示最高的前五个）**

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  aggregate(x, by, FUN, ..., simplify = TRUE)

对数据x，通过by指明的变量，以FUN的方式进行整合。

**x**是一个数据框的一个属性

**by**有哪些因子去进行统计

**FUN**是计算的方法

这个函数最后返回的是一个组织好的**数据框**

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **sapply(x,FUN,options)****，**指定统计方法进行描述

options是FUN的参数。

另外，可以自定义统计函数，返回是一个向量。描述统计将根据自定义的函数计算，最终返回这个向量。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **by(x,INDICES,FUN)**，也可以对数据进行整合描述，其中，INDICES是一个因子或列表。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **table()**统计频数。

l  列联表

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  创建表

**table(data)**，创建一维列联表

table(A,B)，创建二维列联表（矩阵式），A是行，B是列

**xtabs(formula,data)**，根据formula的格式创建。

formula可以为~A+B

抽样函数：Sample(x,size=,[replace=T])

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  处理表

**prob.table(table,margins)**，比例，margins是边际（1表示行与行相比，2表示列与列相比）

margin.table(table,margins)，频数

addmargins(tables,margins)，为表格添加边际

ftable(table)

 

**常用统计推断**

l  独立性检验

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  卡方独立性检验

chisq.test()

p<0.01则拒绝假设，p>0.05则不拒绝。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  Fisher精确性检验

fisher.test()，假设是：边界固定的列联表行和列是相互独立的。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  Corchran-Mantel-Haenszel检验

mantelhaen.test()，假设：两个名义变量在第三个变量的每一层中都是独立的。

l  相关性度量

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  assocstats()，较大的值意味着较强的相关性。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  cor(x,use,method=)，计算相关系数；

use指定缺失数据的处理方式，method指定相关系数的类型（Pearson、spearman、Kendall三种）

cor.test(x,y,alternative=,method=)，对x、y的相关性检验，alternative表示总体的相关系数大于还是小于0（’less’小于0，’greater’大于0，’two.side’，不等于0）

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  cov()，计算协方差。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  pcor(u,S)，偏相关，指控制一个或多个变量后，另外两个变量之间的相互关系。u是一个数值向量，前两个数值表示要计算相关性的下标，后面的表示要控制的变量。S为变量的协方差矩阵。

l  t检验

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  独立性检验

t.test(y~x,data)，y是一个数值变量，x是一个二分变量。

t.test(y1,y2)，y1，y2是数值向量。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  非独立性检验

假定组件差异成正态分布。

t.tet(y1,y2,paired=TRUE) 

 

**时间序列**

ts(data = NA, start = 1, end = numeric(), frequency = 1,

   deltat = 1, ts.eps = getOption("ts.eps"), class = , names = )

as.ts(x, ...)          强制转化为时间序列

```
is.ts(x)               判断是否为时间序列
```

统计分析

**回归分析**

a = lm(formula =, data = dataframe)

formula:回归函数的表达式（模型公式），如：y~x1+x2…，其中的参数是数据框列的名称

求模型系数

\> coef(a)

提取模型公式

\> formula(a)

plot(a) 绘画模型诊断图(不理解)

预测：predict(a,z),z是新的数据框，利用回归函数a对z进行预测

 

**方差分析**ANOVA

l  概述

方差分析是用于两个及两个以上样本均数差别的**显著性检验**。方差分析的因变量是连续型资料，自变量是分类变量，一般都以组别的形式出现。方差分析是比较组间差异，组间差异的来源有（1）随机误差，组内差异（2）控制条件，组间差异。方差分析的基本思想是：通过分析研究不同来源的变异对总变异的贡献大小，从而确定可控因素对研究结果影响力的大小。

方差分析的检验方式是**F****检验**（对组间的差异性检验）。

l  方差分析类别

方差分析根据自变量的个数可以有单因素，双因数、三因数等；根据因子的类型，可以分为组内因子和组间因子；另外因变量如果是多个则可以是多元方差分析。

l  模型拟合

方差分析和回归分析都是广义线性模型，因此方差分析也可以用lm()进行。

aov(formula,data=dataframe)，同lm一样，返回的也是一个拟合值，formula的不同就是分析的因素不同，常用的formula有：

y ~ A                    单因素分析

y ~ x+A                含有协变量的单因素

y ~ A*B                双因素，*表示A和B之间的交互（展开为A+B+A:B）

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  单因素方差分析

单因素分析是比较两个或多个组别的**因变量均值**。

fit=aov(A~B)

summary(fit)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  双因素方差分析

fit=aov(y~A*B)

交互性显示：interaction.plot(A,B,y,…)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  多元方差分析

当因变量不止一个时，可以用多元方差同时分析。

manova(c()~A…)

**广义线性模型**

在许多情况下，因变量可能不符合正态分布，如：

Ø  结果变量是类别型的。

Ø  结果变量是计数型的（有限，并且均值与方差是相关的，正态分布是相互独立的）。

l  广义线性模型

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  线性模型

​                                                  

对于广义线性模型，只需要保证参数（ẞ0，ẞ1，…）为线性即可，因此定义广义线性模型如下形式：

   

其中，g()是条件均值的函数（连接函数）。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  glm()函数

**glm(formula,family=family(link=function),data=…)**

family=…指明了概率分布和相应的连接函数，分布族默认的连接函数：

binomial (link = "logit")

gaussian (link = "identity")

gamma (link = "inverse")

inverse.gaussian (link = "1/mu^2")

poisson (link = "log")

quasi (link = "identity", variance = "constant")

quasibinomial (link = "logit")

quasipoisson (link = "log")

默认的link可以在使用的时候省略。

例如，对于logistic回归，假设符合二项分布，则可以用

family= binomial (link = "logit")来表示。

 

l  Logistic回归

logistic回归是一个二值检验，因此首先需要将要检验的因子（因变量）转换为二值因子。对于数值变量可以设置界定，上界与下界分别取一个因子。

同样的，可以通过p值观测变量的显著性，而重新定义拟合模型。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  模型的比较可以使用anova()，设两套线性模型分别是fit.full和fit.reduced，利用卡方检验进行比较，如：

```
       anova(fit.reduced,fit.full,test="Chisq")
```

它们的显著性（p值），说明了两个模型的拟合程度。也就是说，在拟合程度相似的情况下，fit.reduced下面的变量确实具有更高的显著性效果，而其他的却不具备。

**主成分分析（PCA****）与因子分析（EFA****）**

主成分分析是一种数据降维方法，将大量相关变量转换为一组低维不相关的变量。主成分分析是观测变量的一个**线性组合**，权重是通过最大化各主成分所解释的方差获得的。如：

PC1=a1X1+a2X2+…akXk

探索因子分析是用来发现一组变量的潜在结构的方法。寻找一组**更小的、潜在的结构**来解释已观测的、显示的变量间的关系。

分析的一般步骤：

（1）、数据预处理

（2）、选择因子模型

（3）、判断选择的主成分/因子数目

（4）、选择主成分/因子

（5）、旋转主成分/因子

（6）、解释结果

（7）、计算主成分或因子得分

l  主成分分析

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  主成分个数确定

Ø  根据解释变量方差的积累值的阈值来判断需要的主成分数目；

Ø  通过变量间K*K的相关系数矩阵来判断保留的主成分数目。

特征值方法：第一主成分与最大特征值关联，第二主成分与第二大的关联，依次下去。

Ø  碎石检验绘制了特征值与主成分的图形，**在图形变化最大处之上的主成分**都可以保留。特征值的判别标准函数：

fa.parallel(data,fa=””,n.iter=…)

绘制结果如图：   

图中表示了三种特征值的判别准则，①蓝线展示了基于观测值的碎石检验，②虚线表示根据n.iter个随机数矩阵推导出来的特征值均值，③实线表示大于1的特征值准则。图中显示了只需要保留1个主成分即可以保留大部分信息。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  提取主成分

principal(r,nfactors=,rotate=,scores=)

r是相关系数矩阵或原始矩阵；

nfactor是主成分数目，默认为1；

rotate指定旋转方法，默认最大方差旋转（varimax）；

scores设定是否需要计算主成分得分（默认不需要）。

​       

结果中，PC1栏包含了**成分载荷**，指出了观测变量与主成分的相关系数；h2栏指出了**成分公因子方差**——主成分对每个变量的方差解释度；u2栏指**成分唯一性**——方差无法被主成分解释比例。SS loadings包含了主成分相关联的特征值，Proportion var表示主成分对整体数据集的解释程度。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  主成分旋转

旋转是将一系列成分载荷变得更容易解释，它们尽可能的对成分去噪。旋转的方法有两种：

Ø  使选择的成分保持不相关（正交旋转）；

Ø  让它们变得相关（斜交旋转）。

方差极大旋转，对载荷阵的列进行去噪，使得每个变量只由一组有限变量解释。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  获取主成分得分

设置scores=TRUE，可以获得**每个对象**在该主成分上的得分。因此，这里的r只能是原始数据，否则需要另外通过相关系数进行计算。

l  因子分析

因子分析是通过发掘隐藏在数据下的一组较少的、更为基本的**无法观测**的变量，来解释一组可观测变量的相关性。每个因子被认为可解释多个**观测变量间共有的方差**（因此又称为公共因子）。模型形式是：

Xi=a1F1+a2F2+…akFk+Ui

Ui是Xi独有的部分，无法被公共因子解释。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  判断公共因子数目

fa.parallel()将fa=”both”，将同时展现主成分与公共因子分析的结果。   

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  提取公共因子

fa(r,nfactors=,n.obs=,rotate=,scores=,fm=)

n.obs是观测数，输入相关系数时需要填写；

fm设定因子化方法，默认是最小残差法（minres），另外还有：最大似然法（ml），主轴迭代法（pa），加权最小二乘法（wls），广义加权最小二乘法（gls）。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  因子旋转

Ø  正交旋转结果分析rotate=”varimax”

   

可以看到reading和vocab在第一因子上载荷较大，picture、blocks和maze在第二因子上载荷较大，而general较为平均。这说明了包含的两个因子——语言类和非语言类。

Ø  斜交旋转结果

   

可以看出两者的不同之处。正交旋转，因子分析侧重于**结构矩阵**（变量与因子的相关系数）；斜交分析，因子分析会考虑三个矩阵：**因子结构矩阵**、**因子模式矩阵**和**因子关联矩阵**。

R绘图

**绘图初探**

l  图形参数

par()  返回当前图形参数的列表

par(optionname=value,…)

常用参数

|            | 参数       | 用途               | 值       |
| ---------- | ---------- | ------------------ | -------- |
| 符号与线条 | pch        | 绘制点时的符号形状 | 0~25     |
| cex        | 符号的大小 | 默认大小的倍数     |          |
| lty        | 线条的类型 | 1~6                |          |
| lwd        | 线条的宽度 | 默认大小的倍数     |          |
| 颜色       | col        | 绘图颜色           | 字符向量 |
| col.axis   | 坐标轴刻度 |                    |          |
| col.lab    | 坐标轴标签 |                    |          |
| col.main   | 标题       |                    |          |
| col.sub    | 副标题     |                    |          |
| fg         | 前景       |                    |          |
| bg         | 背景       |                    |          |

l  自定义属性

标题title()

坐标轴axis()

参考线abline(h=yvalues,v=xvalues)

图例legend(location,title,legend,…)，legend是图例标签的字符向量

文本标注text(),mtext()

l  图形组合

par(mfrow=c(nrows,ncols))

layout(matrix)，matrix指定了图形组合的位置布局

l  基本图形

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **条形图**barplot(x,main=””,xlab=””,ylab=””,horiz=FALSE)

堆砌与分组条形图barplot(x,main=””,xlab=””,ylab=””,horiz=FALSE,col=c(),legend=c(),besides=FALSE)，绘图对象是一个二维矩阵形式

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  **饼状图**pie()

扇形图，plotrix包的fan.plot(x,labels=c())，适合于大小的比较

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  直方图hist(x,breaks=n,…)，breaks可以指定直方图的条数

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  核密度图，密度函数density(x)

密度图的绘制可以是plot(density())直接绘制，或者是在一幅图上面通过lines(density())进行叠加，**注意**：在叠加之前由于密度图都小于1，因此要把之前的图范围变为1处理，添加属性freq=FALSE

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  箱线图boxplot()

箱线图分组展示：boxplot(formula,data=dataframe)，formula形如Y~X，为变量X的每个值生成对应Y的箱线图。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  点图dotchart()

**散点图（进阶）**

plot(x,y)，可以绘制散点图，可以在散点图上面添加许多线条来直观的表示数据，散点图是显示二变量之间关系的图。

l  线条添加

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  曲线类别函数

lm()，回归曲线

lowess(x,y)，平滑的曲线

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  曲线线条添加

abline()，添加一条回归曲线

lines()

另外，car包提供了一种综合绘图的函数，scatterplot(formula,data=…)

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  散点图矩阵

pairs(~A+B+C…,data=…)，~包含了所有矩阵变量，添加参数upper.panel=NULL，可以只显示上三角图形。

另外，car包的scatterplotMatrix(~A+B+C…,data=…)，可以综合的显示包含多种线条的散点图矩阵图。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  高密度散点图

对于密度较高的散点图，可能眼睛难以分出其分布密度，因此可以根据其密度函数显示其密度上面的分布关系。

smoothScantter(x,y)，x,y是数据框的列名。

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  3D散点图

scatterplot3d(data[n,n+k])，data可以是数据框形式的数据，但至少包括3个属性（维度），即k>=2，高于三维会用不同的颜色或图形显示。一般不会超过5个维度。

添加属性type=”h”，可以添加垂直线。

添加属性highlight=TRUE，可以添加高亮色彩。

**列属性**

```
    3D绘图返回的是一个数据框，包含列有"xyz.convert" ，"points3d"，"plane3d" ，"box3d" 
```

例如，设置plane3d，可以添加一个平面。$plane3d(lm(…))

![*](file:////Users/tianzi/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image001.gif)  气泡图

在散点图的基础上，将另一个变量的大小显示出来。

symbols(x,y,circle=r)，x,y表示坐标，circle指示半径。

还可以添加text(x,y,rownames(data))，来指明坐标处的行名。

**地图绘制**

Map(database,fill=true,col=color,mar=vector(4))

Col:颜色，可以是rgb色彩

Mar:边界

map("world", fill = TRUE, col = rainbow(200),

​    ylim = c(-60, 90), mar = c(0, 0, 0, 0))

title("世界地图") 

 





